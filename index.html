<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamingHub â€¢ Filmy</title>
  <style>

:root {
  --bg: #0b0d10;
  --card: #151922;
  --text: #e3e7ee;
  --muted: #a8bfe2;
  --brand: #4f7cff;
  --border: #232a37;
}

* { box-sizing: border-box; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  line-height: 1.4;
}

a { color: var(--text); text-decoration: none; }

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
}

header {
  position: sticky;
  top: 0;
  background: rgba(11,13,16,0.9);
  backdrop-filter: blur(6px);
  z-index: 10;
}

.nav {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 12px 16px;
  flex-wrap: wrap;
}

.brand { font-weight: 800; }

.nav input[type=search] {
  flex: 1;
  background: #0e1218;
  border: 1px solid var(--border);
  color: #fff;
  padding: 10px 12px;
  border-radius: 12px;
  min-width: 160px;
}

.menu {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.menu a, .menu button {
  padding: 8px 10px;
  color: var(--muted);
  background: none;
  border: none;
  cursor: pointer;
}

.btn {
  background: var(--brand);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 15px;
}

.btn.secondary { background: #2a3446; }

.badge {
  font-size: 12px;
  color: #fff;
  background: #2a3446;
  padding: 2px 8px;
  border-radius: 999px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}

.card.p { padding: 12px; border: 0; }

.card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  display: block;
}

.small { font-size: 12px; color: var(--muted); }

.alert {
  background: #152031;
  padding: 10px;
  border-radius: 10px;
  color: #0e1218;
  margin: 8px 0;
}

.flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

textarea, input, select {
  width: 100%;
  padding: 10px;
  background: #0e1218;
  border: 1px solid var(--border);
  color: #fff;
  border-radius: 10px;
  font-size: 15px;
}

footer {
  color: var(--muted);
  text-align: center;
  padding: 30px 0;
  font-size: 14px;
}

.hidden { display: none; }

.video-container {
  position: relative;
  width: 100%;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  background: black;
  border-radius: 22px;
}

.video-container iframe {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  border: 0;
}

/* RESPONSYWNOÅšÄ† */
@media (max-width: 900px) {
  .row { grid-template-columns: 1fr; }
  .nav { flex-direction: column; align-items: stretch; }
  .menu { justify-content: center; }
  .card img { height: 180px; }
  .container { padding: 12px; }
}

@media (max-width: 600px) {
  .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
  .btn { padding: 10px 12px; font-size: 14px; }
  h1, h2, h3 { font-size: 1.1rem; }
  .card img { height: 150px; }
  input, select, textarea { font-size: 14px; }
  .flex { gap: 8px; }
}

@media (max-width: 400px) {
  .nav { padding: 8px; }
  .nav input[type=search] { padding: 8px; font-size: 14px; }
  .menu a, .menu button { font-size: 13px; }
  .grid { grid-template-columns: 1fr 1fr; gap: 8px; }
  .card img { height: 130px; }
  footer { font-size: 12px; }
}

</style>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="#" onclick="UI.show('home')">ðŸŽ¬ StreamingHub</a>
    <form onsubmit="event.preventDefault(); UI.search(this.q.value)" style="flex:1">
      <input type="search" name="q" placeholder="Szukaj filmÃ³wâ€¦" />
    </form>
    
    <nav class="menu flex">
      <a href="#" onclick="UI.show('home')">Filmy</a>
      <a href="seriale.html">seriale</a>
      <a href="top.html">TOP</a>
      <a href="moja-biblioteka.html">Moja biblioteka</a>
      
      <!-- Przycisk "Zaloguj siÄ™" dla niezalogowanych uÅ¼ytkownikÃ³w -->
      <a href="login.html" id="loginLink" class="btn">Zaloguj siÄ™</a>
      
      <!-- Przycisk "Wyloguj" dla zalogowanych uÅ¼ytkownikÃ³w -->
      <form id="logoutForm" class="hidden" onsubmit="event.preventDefault(); Auth.logout(); window.location='filmy.html';">
        <button class="btn secondary">Wyloguj</button>
      </form>
    </nav>

  </div>
</header>

<main class="container" id="app"></main>

<footer>Â© <script>document.write(new Date().getFullYear())</script> StreamingHub â€¢ free video</footer>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   KONFIG: PODMIEÅƒ NA SWOJE
   ========================= */
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   UTILS
   ========================= */
const delay = (ms)=>new Promise(r=>setTimeout(r,ms));
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s])); }
function toast(msg){ const d=document.createElement("div"); d.className="alert"; d.textContent=msg; d.style.position="fixed"; d.style.right="16px"; d.style.bottom="16px"; d.style.zIndex=9999; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); }

/* =========================
   AUTH + PROFILES
   ========================= */
const Auth = {
async currentUser(){ 
  const { data:{ user } } = await db.auth.getUser(); 
  return user || null; 
},

  async currentProfile(){
    const user = await Auth.currentUser(); if(!user) return null;
    const { data, error } = await db.from("profiles").select("*").eq("id", user.id).maybeSingle();
    if(error){ console.error(error); return null; }
    return data ? { ...user, ...data } : { ...user };
  },
  async register(username, email, password){
    const { data, error } = await db.auth.signUp({ email, password });
    if(error) return alert("âŒ " + error.message);
    const user = data.user;
    // profil moÅ¼e juÅ¼ byÄ‡ tworzony triggerem; mimo to upsert bezpieczny
    const { error: pErr } = await db.from("profiles").upsert({
      id: user.id, username, points: 0, is_admin: false
    });
    if(pErr) console.warn("Profil:", pErr.message);
    toast("âœ”ï¸ Konto utworzone. SprawdÅº e-mail (jeÅ›li wymagane).");
    UI.show("home");
  },
  async login(email, password){
    const { error } = await db.auth.signInWithPassword({ email, password });
    if(error) return alert("âŒ " + error.message);
    await UI.updateHeader();
    toast("âœ”ï¸ Zalogowano");
    UI.show("home");
  },
  async logout(){ await db.auth.signOut(); await UI.updateHeader(); toast("Wylogowano"); UI.show("home"); }
};

// reaguj na zmianÄ™ sesji
db.auth.onAuthStateChange(async ()=>{ UI.updateHeader(); });

/* =========================
   DATA ACCESS (Supabase)
   ========================= */
// Movies
async function getMovies(filters={}){
  let q = db.from("movies").select("*");
  if(filters.q) q = q.ilike("title", `%${filters.q}%`);
  if(filters.category_id) q = q.eq("category_id", filters.category_id);
  if(filters.year) q = q.eq("year", filters.year);
  if(filters.min_duration) q = q.gte("duration", filters.min_duration);
  // sort
  if(filters.sort === "new") q = q.order("created_at", { ascending: false });
  else q = q.order("created_at", { ascending: false });
  const { data, error } = await q;
  if(error) throw error;
  return data||[];
}
async function getMovie(id){
  const { data, error } = await db.from("movies").select("*").eq("id", id).single();
  if(error) throw error; return data;
}
async function addMovie(payload){ return db.from("movies").insert(payload); }
async function deleteMovie(id){ return db.from("movies").delete().eq("id", id); }

// Categories
async function getCategories(){
  const { data, error } = await db.from("categories").select("*").order("name");
  if(error) throw error; return data||[];
}
async function addCategory(name){ return db.from("categories").insert({ name }); }
async function delCategory(id){ return db.from("categories").delete().eq("id", id); }

// Ratings
async function getRatingsFor(movieId){
  const { data, error } = await db.from("ratings").select("score").eq("movie_id", movieId);
  if(error) throw error; return data||[];
}
async function upsertRating(movieId, userId, score){
  return db.from("ratings").upsert({ movie_id: movieId, user_id: userId, score });
}
async function getUserRating(movieId, userId){
  const { data, error } = await db.from("ratings").select("*").eq("movie_id", movieId).eq("user_id", userId).maybeSingle();
  if(error) throw error; return data||null;
}

// Comments
async function getComments(movieId){
  // pobierz komentarze + nazwÄ™ autora z profiles
  const { data, error } = await db
    .from("comments")
    .select("id,text,created_at,user_id,profiles(username)")
    .eq("movie_id", movieId)
    .order("created_at", { ascending:false });
  if(error) throw error; return data||[];
}
async function addComment(movieId, userId, text){
  return db.from("comments").insert({ movie_id: movieId, user_id: userId, text });
}

// Wishlist
async function getWishlist(userId){
  const { data, error } = await db.from("wishlist").select("movie_id").eq("user_id", userId);
  if(error) throw error; return new Set((data||[]).map(x=>x.movie_id));
}
async function toggleWishlist(userId, movieId){
  const { data, error } = await db.from("wishlist").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") console.warn(error);
  if(data){
    await db.from("wishlist").delete().eq("user_id", userId).eq("movie_id", movieId);
  } else {
    await db.from("wishlist").insert({ user_id: userId, movie_id: movieId });
  }
}

// Unlocks
async function getUnlocked(userId){
  const { data, error } = await db.from("unlocks").select("movie_id").eq("user_id", userId);
  if(error) throw error; return new Set((data||[]).map(x=>x.movie_id));
}
async function ensureUnlocked(userId, movieId){
  const { data, error } = await db.from("unlocks").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") console.warn(error);
  if(!data){
    await db.from("unlocks").insert({ user_id: userId, movie_id: movieId });
  }
}

// History
async function getHistory(userId){
  const { data, error } = await db.from("history").select("*").eq("user_id", userId).order("watched_at", { ascending:false }).limit(10);
  if(error) throw error; return data||[];
}
async function addHistory(userId, movieId){
  const { data, error } = await db.from("history").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") console.warn(error);
  if(data){
    await db.from("history").update({ watched_at: new Date().toISOString() }).eq("id", data.id);
  } else {
    await db.from("history").insert({ user_id: userId, movie_id: movieId, watched_at: new Date().toISOString() });
  }
}

// Points
async function getPoints(userId){
  const { data, error } = await db.from("profiles").select("points").eq("id", userId).maybeSingle();
  if(error){ console.error(error); return 0; }
  return data?.points || 0;
}
async function addPoints(userId, delta, reason){
  const current = await getPoints(userId);
  const newVal = current + delta;
  await db.from("profiles").update({ points: newVal }).eq("id", userId);
  await db.from("points_log").insert({ user_id: userId, delta, reason, created_at: new Date().toISOString() });
}

// Codes
async function redeemCode(userId, code){
  const { data, error } = await db.from("codes").select("*").eq("code", code).maybeSingle();
  if(error || !data) return { msg: "âŒ Kod nieprawidÅ‚owy" };
  if(data.used) return { msg: "âŒ Kod juÅ¼ wykorzystany" };
  await db.from("codes").update({ used: true, used_by: userId }).eq("code", code);
  await addPoints(userId, data.points, `Kod: ${code}`);
  return { msg: `âœ”ï¸ Zdobyto ${data.points} pkt!` };
}

/* =========================
   UI
   ========================= */
const UI = {
  el: ()=>document.getElementById("app"),
  async updateHeader(){
    const u = await Auth.currentProfile();
    
    // PokaÅ¼/ukryj przycisk "Zaloguj siÄ™"
    const loginLink = document.getElementById("loginLink");
    if(loginLink){
      loginLink.classList.toggle("hidden", !!u);
    }
    
    // PokaÅ¼/ukryj przycisk "Wyloguj"
    const logoutForm = document.getElementById("logoutForm");
    if(logoutForm){
      logoutForm.classList.toggle("hidden", !u);
    }
  },
  async show(view, params={}){
    const app = UI.el();
    const me = await Auth.currentProfile();

    // HOME
    if(view==="home"){
      const cats = await getCategories();
      const movies = await getMovies({ sort:"new" });

      // policz ratingi zbiorczo
      const ratingsMap = await UI._avgRatingsMap(movies.map(m=>m.id));

      // Historia dla zalogowanych
      let historyHTML = "";
      if(me){
        const hist = await getHistory(me.id);
        const histMovies = await Promise.all(hist.map(h=>getMovie(h.movie_id).catch(()=>null)));
        const validHist = histMovies.filter(Boolean);
        if(validHist.length){
          historyHTML = `<section class="mt-4">
            <h3>Ostatnio oglÄ…dane</h3>
            <div class="grid">${validHist.map(m=>UI.card(m, ratingsMap.get(m.id))).join("")}</div>
          </section>`;
        }
      }

      app.innerHTML = UI.filters(cats) + historyHTML + `
        <section class="mt-4">
          <h3>Wszystkie filmy</h3>
          <div class="grid">${movies.map(m=>UI.card(m, ratingsMap.get(m.id))).join("")}</div>
        </section>
      `;
    }

    // MOVIE DETAIL
    else if(view==="movie"){
      const m = await getMovie(params.id);
      const ratings = await getRatingsFor(m.id);
      const avg = ratings.length ? (ratings.reduce((a,b)=>a+b.score,0)/ratings.length).toFixed(1) : "-";
      const count = ratings.length;
      const comments = await getComments(m.id);

      let youRated = null;
      if(me){
        youRated = await getUserRating(m.id, me.id);
      }

      const rateHTML = me ? `
        <form onsubmit="event.preventDefault(); UI.rate(${m.id}, this.score.value)">
          <select name="score" required>
            <option value="">OceÅ„ film</option>
            ${[1,2,3,4,5,6,7,8,9,10].map(s=>`<option value="${s}" ${youRated&&youRated.score===s?"selected":""}>${s}</option>`).join("")}
          </select>
          <button class="btn mt-2">WyÅ›lij ocenÄ™</button>
        </form>
      ` : `<p class="small">Zaloguj siÄ™, aby oceniÄ‡.</p>`;

      const commentHTML = me ? `
        <form onsubmit="event.preventDefault(); UI.comment(${m.id}, this.text.value); this.reset();">
          <textarea name="text" placeholder="TwÃ³j komentarzâ€¦" rows="3" required></textarea>
          <button class="btn mt-2">Dodaj komentarz</button>
        </form>
      ` : `<p class="small">Zaloguj siÄ™, aby komentowaÄ‡.</p>`;

      const commentsHTML = comments.map(c=>`
        <div class="card p mt-2">
          <strong>${escapeHtml(c.profiles?.username||"Anonim")}</strong>
          <p>${escapeHtml(c.text)}</p>
          <div class="small">${new Date(c.created_at).toLocaleString("pl")}</div>
        </div>
      `).join("");

      // Wishlist
      let wishlistHTML = "";
      if(me){
        const wish = await getWishlist(me.id);
        const inWish = wish.has(m.id);
        wishlistHTML = `<button class="btn secondary" onclick="UI.onToggleWishlist(${m.id})">${inWish?"UsuÅ„ z listy":"Dodaj do listy"}</button>`;
      }

      // Unlock
      let unlockHTML = "";
      if(me){
        const unlocked = await getUnlocked(me.id);
        const isUnlocked = unlocked.has(m.id);
        const cost = m.points_required || 0;
        if(cost > 0 && !isUnlocked){
          unlockHTML = `<button class="btn" onclick="UI.buyMovie(${m.id}, ${cost})">Kup za ${cost} pkt</button>`;
        } else if(isUnlocked){
          unlockHTML = `<button class="btn" onclick="UI.show('watch',{id:${m.id}})">OglÄ…daj</button>`;
        } else {
          unlockHTML = `<button class="btn" onclick="UI.show('watch',{id:${m.id}})">OglÄ…daj</button>`;
        }
      } else {
        unlockHTML = `<p class="small">Zaloguj siÄ™, aby oglÄ…daÄ‡.</p>`;
      }

      app.innerHTML = `
        <div class="row mt-4">
          <div>
            <img src="${m.thumb}" alt="${escapeHtml(m.title)}" style="width:100%; border-radius:14px;">
          </div>
          <div>
            <h2>${escapeHtml(m.title)}</h2>
            <p>${escapeHtml(m.description||"")}</p>
            <div class="small">Rok: ${m.year||"?"} â€¢ Czas: ${m.duration||"?"} min</div>
            <div class="flex mt-3">
              ${unlockHTML}
              ${wishlistHTML}
            </div>
          </div>
        </div>

        <section class="mt-4">
          <h3>Oceny</h3>
          <div class="flex">
            <strong>${avg}</strong>
            <span class="small">(${count} ocen)</span>
          </div>
          ${rateHTML}
        </section>

        <section class="mt-4">
          <h3>Komentarze</h3>
          ${commentHTML}
          ${commentsHTML}
        </section>
      `;
    }

    // WATCH
    else if(view==="watch"){
      const m = await getMovie(params.id);
      if(!me) return UI.show("login");
      const unlocked = await getUnlocked(me.id);
      const cost = m.points_required || 0;
      if(cost > 0 && !unlocked.has(m.id)){
        toast("Musisz kupiÄ‡ ten film.");
        return UI.show("movie", { id: m.id });
      }
      await addHistory(me.id, m.id);
      app.innerHTML = `
        <h2 class="mt-4">${escapeHtml(m.title)}</h2>
        <div class="video-container">
          ${m.iframe}
        </div>
        <button class="btn mt-3" onclick="UI.show('movie',{id:${m.id}})">WrÃ³Ä‡ do opisu</button>
      `;
    }

    // ME (profil)
    else if(view==="me"){
      if(!me) return UI.show("login");
      const pts = await getPoints(me.id);
      const wish = await getWishlist(me.id);
      const wishMovies = await Promise.all([...wish].map(id=>getMovie(id).catch(()=>null)));
      const validWish = wishMovies.filter(Boolean);
      const ratingsMap = await UI._avgRatingsMap(validWish.map(m=>m.id));

      app.innerHTML = `
        <h2 class="mt-4">MÃ³j profil</h2>
        <div class="card p">
          <p><strong>Nazwa:</strong> ${escapeHtml(me.username||me.email)}</p>
          <p><strong>E-mail:</strong> ${escapeHtml(me.email)}</p>
          <p><strong>Punkty:</strong> ${pts}</p>
        </div>

        <section class="mt-4">
          <h3>Edytuj nazwÄ™</h3>
          <form onsubmit="event.preventDefault(); UI.saveBio(this.username.value)">
            <input name="username" placeholder="Nazwa uÅ¼ytkownika" value="${escapeHtml(me.username||"")}" />
            <button class="btn mt-2">Zapisz</button>
          </form>
        </section>

        <section class="mt-4">
          <h3>ZdobÄ…dÅº punkty</h3>
          <button class="btn" onclick="UI.earnAd()">Obejrzyj reklamÄ™ (+50 pkt)</button>
        </section>

        <section class="mt-4">
          <h3>UÅ¼yj kodu</h3>
          <form onsubmit="event.preventDefault(); UI.redeem(this.code.value); this.reset();">
            <input name="code" placeholder="Kod" />
            <button class="btn mt-2">Aktywuj</button>
          </form>
        </section>

        <section class="mt-4">
          <h3>Moja lista</h3>
          <div class="grid">${validWish.map(m=>UI.card(m, ratingsMap.get(m.id))).join("") || '<div class="small">Brak filmÃ³w.</div>'}</div>
        </section>
      `;
    }

    // LOGIN
    else if(view==="login"){
      app.innerHTML = `
        <h2 class="mt-4">Logowanie</h2>
        <form onsubmit="event.preventDefault(); Auth.login(this.email.value, this.password.value)">
          <input type="email" name="email" placeholder="E-mail" required />
          <input type="password" name="password" placeholder="HasÅ‚o" required />
          <button class="btn mt-2">Zaloguj</button>
        </form>
        <p class="small mt-2">Nie masz konta? <a href="#" onclick="UI.show('register')">Zarejestruj siÄ™</a></p>
      `;
    }

    // REGISTER
    else if(view==="register"){
      app.innerHTML = `
        <h2 class="mt-4">Rejestracja</h2>
        <form onsubmit="event.preventDefault(); Auth.register(this.username.value, this.email.value, this.password.value)">
          <input name="username" placeholder="Nazwa uÅ¼ytkownika" required />
          <input type="email" name="email" placeholder="E-mail" required />
          <input type="password" name="password" placeholder="HasÅ‚o" required />
          <button class="btn mt-2">Zarejestruj</button>
        </form>
        <p class="small mt-2">Masz konto? <a href="#" onclick="UI.show('login')">Zaloguj siÄ™</a></p>
      `;
    }

    // ADMIN
    else if(view==="admin"){
      if(!me || !me.is_admin) return UI.show("home");
      const movies = await getMovies();
      const cats = await getCategories();
      app.innerHTML = `
        <h2 class="mt-4">Panel admina</h2>

        <section class="mt-4">
          <h3>Dodaj film</h3>
          <form onsubmit="event.preventDefault(); UI.addMovie(this)">
            <input name="title" placeholder="TytuÅ‚" required />
            <textarea name="description" placeholder="Opis" rows="3"></textarea>
            <input name="thumb" placeholder="URL miniatury" />
            <textarea name="iframe" placeholder="Kod iframe" rows="3"></textarea>
            <select name="category_id">
              <option value="">Kategoria</option>
              ${cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}
            </select>
            <input type="number" name="year" placeholder="Rok" />
            <input type="number" name="duration" placeholder="Czas (min)" />
            <input type="number" name="points_required" placeholder="Punkty (0=darmowy)" />
            <button class="btn mt-2">Dodaj</button>
          </form>
        </section>

        <section class="mt-4">
          <h3>Filmy</h3>
          ${movies.map(m=>`
            <div class="card p mt-2 flex" style="justify-content:space-between;">
              <span>${escapeHtml(m.title)}</span>
              <button class="btn secondary" onclick="UI.deleteMovie(${m.id})">UsuÅ„</button>
            </div>
          `).join("")}
        </section>

        <section class="mt-4">
          <h3>Kategorie</h3>
          <form onsubmit="event.preventDefault(); UI.addCategory(this.name.value); this.reset();">
            <input name="name" placeholder="Nazwa kategorii" required />
            <button class="btn mt-2">Dodaj</button>
          </form>
          ${cats.map(c=>`
            <div class="card p mt-2 flex" style="justify-content:space-between;">
              <span>${escapeHtml(c.name)}</span>
              <button class="btn secondary" onclick="UI.delCategory(${c.id})">UsuÅ„</button>
            </div>
          `).join("")}
        </section>
      `;
    }
  },

  filters(cats){
    return `<div class="flex mt-4">
      <select onchange="UI.search('', { category_id: this.value||undefined })">
        <option value="">Wszystkie kategorie</option>
        ${cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}
      </select>
    </div>`;
  },

  async _avgRatingsMap(movieIds){
    const map = new Map();
    for(const id of movieIds){
      const ratings = await getRatingsFor(id);
      if(ratings.length){
        const avg = ratings.reduce((a,b)=>a+b.score,0) / ratings.length;
        map.set(id, avg);
      }
    }
    return map;
  },

  // <-- ZAMIANA: tutaj zmieniÅ‚em linki aby ustawiaÅ‚y #hash wygenerowany z tytuÅ‚u
  card(m, avg){
    if(!m) return "";
    // funkcja czyszczÄ…ca tytuÅ‚ na hash (bez polskich znakÃ³w, spacje -> '-')
    const clean = (str) => (str||"").toLowerCase()
      .replace(/[Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]/g, c => ({ "Ä…":"a","Ä‡":"c","Ä™":"e","Å‚":"l","Å„":"n","Ã³":"o","Å›":"s","Åº":"z","Å¼":"z" }[c]||c))
      .replace(/[^a-z0-9\-]+/g,"-")
      .replace(/\-+/g,"-")
      .replace(/^\-|\-$/g,"");
    const slug = clean(m.title);
    return `<div class="card">
      <a href="#${slug}" onclick="UI.show('movie',{id:${m.id}})"><img src="${m.thumb}" alt="${escapeHtml(m.title)}"></a>
      <div class="card p">
        <div class="flex" style="justify-content:space-between;">
          <strong><a href="#${slug}" onclick="UI.show('movie',{id:${m.id}})">${escapeHtml(m.title)}</a></strong>
          <span class="badge">â˜… ${avg?avg.toFixed(1):"-"}</span>
        </div>
        <div class="small mt-2">czas: ${m.duration||"?"} min â€¢ rok: ${m.year||"?"}</div>
      </div>
    </div>`;
  },

  async search(q, extra={}){
    const cats = await getCategories();
    const movies = await getMovies({ q, ...extra });
    const ratingsMap = await UI._avgRatingsMap(movies.map(m=>m.id));
    const app = UI.el();
    app.innerHTML = UI.filters(cats) + `
      <h3 class="mt-4">Wyniki</h3>
      <div class="grid">${movies.map(m=>UI.card(m, ratingsMap.get(m.id))).join("") || '<div class="small">Brak wynikÃ³w.</div>'}</div>
    `;
  },

  async onToggleWishlist(movieId){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    await toggleWishlist(me.id, movieId);
    toast("Zaktualizowano listÄ™.");
  },

  async unlock(movieId){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    const m = await getMovie(movieId);
    if((m.points_required||0)===0){ await ensureUnlocked(me.id, movieId); return UI.show('watch',{id:movieId}); }
    const have = await getPoints(me.id);
    if(have < (m.points_required||0)) return toast("Za maÅ‚o punktÃ³w");
    await addPoints(me.id, -(m.points_required||0), `Odblokowanie: ${m.title}`);
    await ensureUnlocked(me.id, movieId);
    toast("Odblokowano âœ”ï¸"); UI.show('watch',{id:movieId});
  },

async rate(movieId, score){
  const me = await Auth.currentProfile();
  if (!me) return UI.show("login");
  score = Number(score);

  // sprawdÅº, czy uÅ¼ytkownik juÅ¼ oceniaÅ‚
  const existing = await getUserRating(movieId, me.id);
  if (existing) {
    // aktualizacja istniejÄ…cej oceny
    const { error } = await db
      .from("ratings")
      .update({ score })
      .eq("movie_id", movieId)
      .eq("user_id", me.id);
    if (error) {
      console.error(error);
      return toast("âŒ BÅ‚Ä…d przy aktualizacji oceny.");
    }
    toast("âœ”ï¸ Zmieniono TwojÄ… ocenÄ™!");
  } else {
    // nowa ocena
    const { error } = await db
      .from("ratings")
      .insert({ movie_id: movieId, user_id: me.id, score });
    if (error) {
      console.error(error);
      return toast("âŒ BÅ‚Ä…d przy dodawaniu oceny.");
    }
    toast("âœ”ï¸ Ocena dodana!");
  }

  // odÅ›wieÅ¼ tylko sekcjÄ™ ocen â€” nie przeÅ‚adowuj caÅ‚ej strony
  const ratings = await getRatingsFor(movieId);
  const avg = ratings.length
    ? (ratings.reduce((a, b) => a + b.score, 0) / ratings.length).toFixed(1)
    : "-";
  const count = ratings.length;
  const youRated = await getUserRating(movieId, me.id);

  // zaktualizuj tekst na stronie bez reloadu
  const movieSection = document.querySelector("section.mt-4");
  if (movieSection) {
    movieSection.querySelector("div strong").textContent = avg;
    const sel = movieSection.querySelector("select[name='score']");
    if (sel) sel.value = youRated.score;
  }
},

  async comment(movieId, text){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    text = (text||"").trim(); if(!text) return;
    await addComment(movieId, me.id, text.slice(0,2000));
    UI.show('movie',{id:movieId});
  },
    async buyMovie(movieId, cost){
    const me = await Auth.currentProfile();
    if(!me) return UI.show("login");

    const have = await getPoints(me.id);
    if(have < cost){
      return toast("âŒ Masz za maÅ‚o punktÃ³w");
    }

    // odejmij punkty
    await addPoints(me.id, -cost, `Zakup filmu #${movieId}`);

    // zapisz odblokowanie
    await ensureUnlocked(me.id, movieId);

    toast("âœ”ï¸ Film odblokowany!");
    UI.show("movie", { id: movieId }); // odÅ›wieÅ¼ widok
  },


  async saveBio(username){
    const me = await Auth.currentProfile(); if(!me) return;
    await db.from("profiles").update({ username: String(username||"").slice(0,50) }).eq("id", me.id);
    toast("Zapisano âœ”ï¸"); UI.show('me');
  },

  async earnAd(){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    await addPoints(me.id, 50, "Reklama (demo)");
    toast("Zdobyto 50 pkt");
    UI.show('me');
  },

  async redeem(code){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    const res = await redeemCode(me.id, code);
    toast(res.msg);
    UI.show('me');
  },

  async addMovie(form){
    const payload = {
      title: form.title.value.trim(),
      description: form.description.value.trim(),
      thumb: form.thumb.value.trim(),
      iframe: form.iframe.value.trim(),
      category_id: form.category_id.value ? Number(form.category_id.value) : null,
      year: form.year.value ? Number(form.year.value) : null,
      duration: form.duration.value ? Number(form.duration.value) : null,
      points_required: form.points_required.value ? Number(form.points_required.value) : 0,
      created_at: new Date().toISOString()
    };
    const { error } = await addMovie(payload);
    if(error){ alert("âŒ " + error.message); return; }
    toast("Film dodany âœ”ï¸");
    UI.show('admin');
  },

  async deleteMovie(id){
    const { error } = await deleteMovie(id);
    if(error){ alert("âŒ " + error.message); return; }
    UI.show('admin');
  },

  async addCategory(name){
    name = (name||"").trim(); if(!name) return;
    const { error } = await addCategory(name);
    if(error) alert("âŒ " + error.message);
    UI.show('admin');
  },

  async delCategory(id){
    const { error } = await delCategory(id);
    if(error) alert("âŒ " + error.message);
    UI.show('admin');
  }
};

// Start
UI.updateHeader();
UI.search('', { sort: 'new' });
</script>

<!-- =========== Router hash: otwieranie filmu po #hash =========== -->
<script>
/*
  ObsÅ‚uga hash-a:
  - po wejÅ›ciu na filmy.html#slug lub zmianie hash -> sprÃ³buj znaleÅºÄ‡ film po wygenerowanym 'slug' z tytuÅ‚u
  - jeÅ›li znajdzie, otwÃ³rz UI.show('movie', {id})
*/
function makeSlug(str){
  return (str||"").toLowerCase()
    .replace(/[Ä…Ä‡Ä™Å‚Å„Ã³Å›ÅºÅ¼]/g, c => ({ "Ä…":"a","Ä‡":"c","Ä™":"e","Å‚":"l","Å„":"n","Ã³":"o","Å›":"s","Åº":"z","Å¼":"z" }[c]||c))
    .replace(/[^a-z0-9\-]+/g,"-")
    .replace(/\-+/g,"-")
    .replace(/^\-|\-$/g,"");
}

async function handleHash(){
  const hash = (window.location.hash||"").replace("#","");
  if(!hash){
    // jeÅ›li nie ma hasha, pokaÅ¼ home (ale nie wymuszaj jeÅ¼eli juÅ¼ jesteÅ›my np. w innym widoku)
    // UI.show('home');
    return;
  }
  try{
    const movies = await getMovies();
    const movie = movies.find(m => makeSlug(m.title) === hash);
    if(movie){
      UI.show('movie', { id: movie.id });
      // scroll to top for nicer UX
      window.scrollTo(0,0);
    } else {
      // nie znaleziono - zostaw stronÄ™ jak jest albo pokaÅ¼ home
      // UI.show('home');
      console.warn("Hash nie pasuje do Å¼adnego filmu:", hash);
    }
  }catch(e){
    console.error(e);
  }
}
window.addEventListener("hashchange", handleHash);
window.addEventListener("DOMContentLoaded", handleHash);
</script>
</body>
</html>
