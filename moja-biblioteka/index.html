<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moja biblioteka ‚Ä¢ StreamingHub</title>
  <style>
    :root {
      --bg: #0b0d10;
      --card: #151922;
      --text: #e3e7ee;
      --muted: #a8bfe2;
      --brand: #4f7cff;
      --border: #232a37;
      --danger: #c24b4b;
      --success: #22c55e;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      min-height: 100vh;
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    header {
      position: sticky;
      top: 0;
      background: rgba(11, 13, 16, .8);
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    .nav { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      padding: 12px 16px; 
      flex-wrap: wrap; 
      justify-content: space-between; 
      border-bottom: 1px solid var(--border); 
    }
    .brand { font-weight: 700; font-size: 1.25rem; display: flex; align-items: center; gap: 8px; text-decoration: none; color: #fff; }
    .menu { display: flex; gap: 16px; align-items: center; }
    .menu a { font-size: .9rem; color: var(--muted); text-decoration: none; transition: color .2s; }
    .menu a:hover { color: #fff; }
    .menu a.active { color: #fff; font-weight: 600; }

    h1 { font-size: 1.5rem; margin-bottom: 24px; }
    .tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 8px; overflow-x: auto; }
    .tab { background: none; border: none; color: var(--muted); padding: 8px 16px; cursor: pointer; border-radius: 8px; font-size: .9rem; white-space: nowrap; }
    .tab.active { background: var(--brand); color: #fff; }

    .section-title { font-size: 1.1rem; font-weight: 600; margin: 32px 0 16px; display: flex; align-items: center; gap: 8px; color: var(--muted); }
    .list { display: flex; flex-direction: column; gap: 12px; }
    .item { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; }
    .thumb { width: 45px; height: 60px; object-fit: cover; border-radius: 6px; background: #000; }
    .muted-block { font-size: .8rem; color: var(--muted); margin-top: 4px; }
    
    .small-btn { background: var(--border); border: none; color: #fff; padding: 6px 12px; border-radius: 8px; cursor: pointer; font-size: .8rem; }
    .small-btn:hover { background: #2d3646; }

    .loading { text-align: center; padding: 40px; color: var(--muted); }

    /* --- SKOPIOWANE STYLE MOBILNE 1:1 --- */
    @media (max-width: 900px) {
      .row { grid-template-columns: 1fr; }
      .nav { flex-direction: column; align-items: stretch; gap: 24px; }
      .menu { justify-content: center; }
      .card img { height: 180px; }
      .container { padding: 12px; }
    }

    @media (max-width: 600px) {
      .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .btn { padding: 10px 12px; font-size: 14px; }
      h1, h2, h3 { font-size: 1.1rem; }
      .card img { height: 150px; }
      input, select, textarea { font-size: 14px; }
      .flex { gap: 8px; }
    }

    @media (max-width: 400px) {
      .nav { padding: 8px; }
      .nav input[type=search] { padding: 8px; font-size: 14px; }
      .menu a, .menu button { font-size: 13px; }
      .grid { grid-template-columns: 1fr 1fr; gap: 8px; }
      .card img { height: 130px; }
      footer { font-size: 12px; }
    }
  </style>
</head>
<body>

<header>
  <div class="nav">
    <a href="index.html" class="brand">üé¨ StreamingHub</a>
    <nav class="menu">
      <a href="/filmy/">Filmy</a>
      <a href="/seriale/">Seriale</a>
      <a href="/moja-biblioteka/" class="active">Moja biblioteka</a>
      <a href="#" onclick="logout()" id="logoutBtn" style="display:none;">Wyloguj</a>
    </nav>
  </div>
</header>

<div class="container">
  <h1 id="userName">Twoja biblioteka</h1>

  <div class="tabs">
    <button class="tab active" onclick="switchTab('history', this)">Historia oglƒÖdania</button>
    <button class="tab" onclick="switchTab('watchlist', this)">Chcƒô obejrzeƒá</button>
    <button class="tab" onclick="switchTab('favorites', this)">Ulubione</button>
    <button class="tab" onclick="switchTab('settings', this)">Ustawienia profilu</button>
  </div>

  <div id="content">
    <div class="loading">≈Åadowanie Twoich danych...</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;

async function init() {
  const { data } = await db.auth.getUser();
  if (!data.user) {
    window.location.href = "login.html";
    return;
  }
  user = data.user;
  document.getElementById("userName").innerText = `Witaj, ${user.user_metadata.username || 'u≈ºytkowniku'}!`;
  document.getElementById("logoutBtn").style.display = "block";
  loadHistory();
}

async function logout() {
  await db.auth.signOut();
  window.location.href = "login.html";
}

async function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  const div = document.getElementById("content");
  div.innerHTML = '<div class="loading">≈Åadowanie...</div>';

  if (tab === 'history') loadHistory();
  else if (tab === 'watchlist') loadWatchlist();
  else if (tab === 'favorites') loadFavorites();
  else if (tab === 'settings') loadSettings();
}

// Sekcja ustawie≈Ñ
async function loadSettings() {
    const div = document.getElementById("content");
    div.innerHTML = `
        <div style="max-width: 400px; background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
            <h3 style="margin-top:0">Zmie≈Ñ nazwƒô u≈ºytkownika</h3>
            <input type="text" id="newUsername" placeholder="Nowa nazwa" style="width:100%; padding:10px; background:#0b0d10; border:1px solid var(--border); color:#fff; border-radius:8px; margin-bottom:12px;">
            <button class="small-btn" style="width:100%; padding:10px; background:var(--brand);" onclick="updateUsername()">Zapisz zmiany</button>
            
            <hr style="border:0; border-top:1px solid var(--border); margin: 20px 0;">
            
            <h3>Zmie≈Ñ has≈Ço</h3>
            <button class="small-btn" style="width:100%; padding:10px;" onclick="resetPasswordEmail()">Wy≈õlij link do resetu has≈Ça</button>
        </div>
    `;
}

async function updateUsername() {
    const newName = document.getElementById("newUsername").value.trim();
    if(!newName) return alert("Wpisz nazwƒô!");
    const { error } = await db.auth.updateUser({ data: { username: newName } });
    if(error) alert(error.message);
    else { alert("Zmieniono!"); location.reload(); }
}

async function resetPasswordEmail() {
    const { error } = await db.auth.resetPasswordForEmail(user.email, { redirectTo: window.location.origin + '/login.html' });
    if(error) alert(error.message);
    else alert("Link wys≈Çany na email!");
}

// Historia
async function loadHistory() {
  const div = document.getElementById("content");
  const { data: mRows } = await db.from("watch_history_movies").select("*").eq("user_id", user.id).order("watched_at", { ascending: false });
  const { data: sRows } = await db.from("watch_history_series").select("*").eq("user_id", user.id).order("watched_at", { ascending: false });

  let html = "";
  html += `<div class='section-title'>üé¨ Ostatnio oglƒÖdane filmy</div>`;
  html += `<div class='list'>${await makeMoviesHtml(mRows || [], 'history')}</div>`;
  html += `<div class='section-title'>üì∫ Ostatnie odcinki seriali</div>`;
  html += `<div class='list'>${await makeSeriesHtml(sRows || [], 'history')}</div>`;
  div.innerHTML = html;
}

// Chcƒô obejrzeƒá (Watchlist)
async function loadWatchlist() {
    const div = document.getElementById("content");
    const { data: mRows } = await db.from("watchlist_movies").select("*").eq("user_id", user.id);
    const { data: sRows } = await db.from("watchlist_series").select("*").eq("user_id", user.id);
    
    let html = "";
    html += `<div class='section-title'>üìå Filmy do obejrzenia</div>`;
    html += `<div class='list'>${await makeMoviesHtml(mRows || [], 'watchlist')}</div>`;
    html += `<div class='section-title'>üìå Seriale do obejrzenia</div>`;
    html += `<div class='list'>${await makeSeriesHtml(sRows || [], 'watchlist_series')}</div>`;
    div.innerHTML = html;
}

// Ulubione
async function loadFavorites() {
    const div = document.getElementById("content");
    const { data: mRows } = await db.from("favorites_movies").select("*").eq("user_id", user.id);
    const { data: sRows } = await db.from("favorites_series").select("*").eq("user_id", user.id);
    
    let html = "";
    html += `<div class='section-title'>‚ù§Ô∏è Ulubione filmy</div>`;
    html += `<div class='list'>${await makeMoviesHtml(mRows || [], 'favorites')}</div>`;
    html += `<div class='section-title'>‚ù§Ô∏è Ulubione seriale</div>`;
    html += `<div class='list'>${await makeSeriesHtml(sRows || [], 'favorites_series')}</div>`;
    div.innerHTML = html;
}

// Generatory HTML
async function makeMoviesHtml(rows, type) {
  if (!rows.length) return "<div class='muted-block'>Nic tu jeszcze nie ma.</div>";
  const ids = rows.map(r => r.movie_id);
  const { data: movies } = await db.from("movies").select("id,title,thumb").in("id", ids);
  const map = new Map(movies?.map(m => [m.id, m]));
  
  return rows.map(r => {
    const m = map.get(r.movie_id);
    if(!m) return "";
    return `
      <div class='item'>
        <div style="display:flex;gap:12px;align-items:center;">
          <img class='thumb' src='${m.thumb}'>
          <div>
            <b>${m.title}</b>
            <div class='muted-block'>${r.watched_at ? new Date(r.watched_at).toLocaleString() : ''}</div>
          </div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class='small-btn' onclick="location.href='filmy.html?id=${m.id}'">‚ñ∂</button>
            <button class='small-btn' style="color:var(--danger)" onclick="removeFromList('${type}', ${r.id})">‚úï</button>
        </div>
      </div>`;
  }).join("");
}

async function makeSeriesHtml(rows, type) {
  if (!rows.length) return "<div class='muted-block'>Nic tu jeszcze nie ma.</div>";
  
  let html = "";
  if(type === 'history') {
      const { data: eps } = await db.from("episodes").select("id,series_id,season,episode,thumb").in("id", rows.map(r => r.episode_id));
      const sids = [...new Set(eps?.map(e => e.series_id))];
      const { data: series } = await db.from("series").select("id,title,thumb").in("id", sids);
      const sMap = new Map(series?.map(s => [s.id, s]));
      const eMap = new Map(eps?.map(e => [e.id, e]));

      return rows.map(r => {
        const e = eMap.get(r.episode_id); if (!e) return "";
        const s = sMap.get(e.series_id);
        return `
          <div class='item'>
            <div style="display:flex;gap:12px;align-items:center;">
              <img class='thumb' src='${e.thumb || s?.thumb}'>
              <div>
                <b>${s?.title}</b>
                <div class='muted-block'>S${e.season} E${e.episode} ‚Ä¢ ${new Date(r.watched_at).toLocaleString()}</div>
              </div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class='small-btn' onclick="location.href='seriale.html?id=${s?.id}&e=${e.id}'">‚ñ∂</button>
                <button class='small-btn' style="color:var(--danger)" onclick="removeFromList('history_series', ${r.id})">‚úï</button>
            </div>
          </div>`;
      }).join("");
  } else {
      const sids = rows.map(r => r.series_id);
      const { data: series } = await db.from("series").select("id,title,thumb").in("id", sids);
      const sMap = new Map(series?.map(s => [s.id, s]));
      
      return rows.map(r => {
          const s = sMap.get(r.series_id);
          if(!s) return "";
          return `
            <div class='item'>
                <div style="display:flex;gap:12px;align-items:center;">
                    <img class='thumb' src='${s.thumb}'>
                    <div><b>${s.title}</b></div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button class='small-btn' onclick="location.href='seriale.html?id=${s.id}'">‚ñ∂</button>
                    <button class='small-btn' style="color:var(--danger)" onclick="removeFromList('${type}', ${r.id})">‚úï</button>
                </div>
            </div>`;
      }).join("");
  }
}

async function removeFromList(type, id) {
    if(!confirm("UsunƒÖƒá z listy?")) return;
    let table = "";
    if(type === 'history') table = "watch_history_movies";
    else if(type === 'history_series') table = "watch_history_series";
    else if(type === 'watchlist') table = "watchlist_movies";
    else if(type === 'watchlist_series') table = "watchlist_series";
    else if(type === 'favorites') table = "favorites_movies";
    else if(type === 'favorites_series') table = "favorites_series";
    
    const { error } = await db.from(table).delete().eq("id", id);
    if(error) alert(error.message);
    else location.reload();
}

init();
</script>
</body>
</html>
