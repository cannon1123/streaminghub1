<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Chat ‚Ä¢ StreamingHub</title>
<style>
:root {
  --bg: #0b0d10;
  --card: #151922;
  --card-light: #1c222c;
  --text: #e3e7ee;
  --muted: #a8bfe2;
  --brand: #4f7cff; /* G≈Ç√≥wny kolor niebieski */
  --border: #232a37;
  --admin-chat: #4f7cff;
  --user-chat: #34495e;
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Roboto;
  line-height: 1.4;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
  flex-grow: 1;
  display: flex;
}

/* ---------------- HEADER ---------------- */
header {
  background: rgba(11,13,16,0.9);
  backdrop-filter: blur(6px);
  z-index: 20;
  border-bottom: 1px solid var(--border);
}

.nav {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 12px 16px;
  flex-wrap: nowrap;
}

.brand {
  margin-right: auto;       
  font-weight: 800;
  color: var(--text);
  text-decoration: none;
}

.menu a {
  padding: 8px 10px;
  color: var(--muted);
  background: none;
  border: none;
  cursor: pointer;
  text-decoration: none;
}

.menu a.active {
  color: #fff;
}

/* ---------------- CHAT LAYOUT ---------------- */
.chat-layout {
  display: flex;
  width: 100%;
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  background: var(--card);
}

.conversation-list-panel {
  width: 300px;
  border-right: 1px solid var(--border);
  flex-shrink: 0;
  overflow-y: auto;
  max-height: calc(100vh - 80px); /* Dopasuj wysoko≈õƒá do menu */
}

.chat-view-panel {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
}

/* ---------------- KONWERSACJE ---------------- */
.conversation-item {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: background-color 0.2s;
}

.conversation-item:hover {
  background: var(--card-light);
}

.conversation-item.active {
  background: var(--card-light);
  border-left: 3px solid var(--brand);
  padding-left: 9px; 
}

.conversation-item-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.conv-username {
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.conv-event {
  font-size: 12px;
  color: var(--muted);
}

.new-message-indicator {
  color: red;
  font-weight: bold;
}

/* ---------------- WIADOMO≈öCI ---------------- */
.chat-header {
  padding: 12px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 600;
  background: var(--card-light);
}

.messages-container {
  flex-grow: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}

.message {
  margin-bottom: 10px;
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  word-wrap: break-word;
}

.message.sent {
  align-self: flex-end;
  background-color: var(--brand);
  color: #fff;
  border-bottom-right-radius: 2px;
}

.message.received {
  align-self: flex-start;
  background-color: var(--user-chat); 
  color: var(--text);
  border-bottom-left-radius: 2px;
}

.message-sender {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
  margin-bottom: 4px;
}

.message.received .message-sender {
  color: var(--muted);
}

.chat-input-area {
  padding: 10px 16px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 10px;
}

.chat-input-area input {
  flex-grow: 1;
  padding: 10px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--bg);
  color: var(--text);
}

.chat-input-area button {
  background: var(--brand);
  color: #fff;
  padding: 10px 14px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-size: 15px;
}

/* ---------------- RESPONSYWNO≈öƒÜ ---------------- */
@media (max-width: 768px) {
  .chat-layout {
    flex-direction: column;
  }
  
  .conversation-list-panel {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--border);
    max-height: 40vh;
  }
  
  .container {
    padding: 8px;
  }
}

.status-info {
  padding: 20px;
  text-align: center;
  color: var(--muted);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="/filmy/">üé¨ StreamingHub</a>
    <nav class="menu">
      <a href="/filmy/">Filmy</a>
      <a href="/seriale/">Seriale</a>
      <a href="/top/">TOP</a>
      <a href="/moja-biblioteka/">Moja biblioteka</a>
      <a href="/chat/" class="active">Chat</a>
      </nav>
  </div>
</header>

<main class="container" id="app">
  <div class="chat-layout">
    <div class="conversation-list-panel">
      <div class="chat-header">Konwersacje</div>
      <div id="conversationsList">
        <p class="status-info">≈Åadowanie...</p>
      </div>
    </div>
    
    <div class="chat-view-panel">
      <div id="chatHeader" class="chat-header">Wybierz konwersacjƒô</div>
      
      <div id="messagesContainer" class="messages-container">
        <p class="status-info">Wybierz konwersacjƒô z listy, aby wy≈õwietliƒá wiadomo≈õci.</p>
      </div>
      
      <div id="chatInputArea" class="chat-input-area" style="display:none;">
        <input type="text" id="messageInput" placeholder="Napisz wiadomo≈õƒá...">
        <button onclick="handleSendMessage()">Wy≈õlij</button>
      </div>
    </div>
  </div>
</main>

<script>
/* ---------------------- SUPABASE INIT ---------------------- */
// **Zmie≈Ñ na swoje dane** (mo≈ºesz u≈ºyƒá tej samej instancji co w top.html)
const db = supabase.createClient(
  "https://jjmnacolebxsifmnmqks.supabase.co", 
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0"
);

let user = null;
let currentConversationId = null;
let conversations = []; // Przechowuje listƒô konwersacji
let messagesSubscription = null; // Przechowuje subskrypcjƒô Realtime

/* ---------------------- BOOT ---------------------- */
(async () => {
  const { data: { session }} = await db.auth.getSession();
  if(!session){ location.href="login.html"; return; }
  
  user = session.user;
  const { data: profileData } = await db.from('profiles').select('is_admin').eq('id', user.id).single();
  user.is_admin = profileData?.is_admin || false;

  await loadConversations();
})();

/* ---------------------- AUTORYZACJA i WYSZUKIWANIE ---------------------- */

/**
 * Pobiera listƒô konwersacji dla zalogowanego u≈ºytkownika.
 * Sortuje konwersacje po dacie ostatniej wiadomo≈õci.
 */
async function loadConversations(){
  const listContainer = document.getElementById('conversationsList');
  listContainer.innerHTML = '<p class="status-info">≈Åadowanie konwersacji...</p>';
  
  // W Supabase nie mo≈ºemy zrobiƒá "user_id = X OR admin_id = X" bezpo≈õrednio w jednej zapytaniu.
  // U≈ºyjemy RPC (lub prostej logiki z widokiem/funkcjƒÖ, ale dla prostoty zrobimy dwa zapytania,
  // co jest mniej optymalne, ale najprostsze w czystym js).
  
  // W tym rozwiƒÖzaniu, u≈ºyjemy prostej klauzuli OR, kt√≥rƒÖ Supabase obs≈Çuguje, 
  // ale musimy upewniƒá siƒô, ≈ºe indeksy i RLS na to pozwalajƒÖ. 
  // NajbezpieczniejszƒÖ i najprostszƒÖ metodƒÖ jest u≈ºycie `or()` w .select()
  
  const { data: convs, error } = await db
    .from('conversations')
    .select(`
      id, 
      status, 
      created_at, 
      event_id,
      user_id,
      admin_id,
      user:user_id(username),
      admin:admin_id(username),
      latest_message:conversation_messages!inner(content, created_at, sender_id),
      event:event_id(name)
    `)
    .or(`user_id.eq.${user.id},admin_id.eq.${user.id}`)
    .order('created_at', { ascending: false, foreignTable: 'latest_message' }); // Sortowanie po dacie ostatniej wiadomo≈õci (to mo≈ºe wymagaƒá ustawienia indeksu)
  
  if(error){
    console.error("B≈ÇƒÖd ≈Çadowania konwersacji:", error);
    listContainer.innerHTML = '<p class="status-info">B≈ÇƒÖd ≈Çadowania konwersacji.</p>';
    return;
  }
  
  conversations = (convs || []).map(conv => {
    // Dodanie dodatkowych informacji
    const otherUserId = conv.user_id === user.id ? conv.admin_id : conv.user_id;
    const otherUser = conv.user_id === user.id ? conv.admin : conv.user;
    
    // Sortowanie wiadomo≈õci, aby ostatnia by≈Ça na poczƒÖtku
    const lastMessage = Array.isArray(conv.latest_message) && conv.latest_message.length > 0
        ? conv.latest_message.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0]
        : null;

    return {
      ...conv,
      otherUserId: otherUserId,
      otherUsername: otherUser?.username || 'U≈ºytkownik usuniƒôty',
      lastMessage: lastMessage
    };
  }).filter(conv => conv.lastMessage); // Poka≈ºemy tylko te z wiadomo≈õciami
  
  renderConversations();
  
  // Je≈õli mamy wybranƒÖ konwersacjƒô, prze≈Çadujmy wiadomo≈õci, 
  // aby upewniƒá siƒô, ≈ºe po prze≈Çadowaniu strony nadal jest aktywna
  if(currentConversationId){
      const activeConv = conversations.find(c => c.id === currentConversationId);
      if(activeConv) selectConversation(activeConv);
  } else if (conversations.length > 0) {
      // Automatycznie wybierz pierwszƒÖ konwersacjƒô, je≈õli to pierwsze ≈Çadowanie
      selectConversation(conversations[0]);
  }
}

/**
 * Renderuje listƒô konwersacji na podstawie danych z `conversations`.
 */
function renderConversations(){
  const listContainer = document.getElementById('conversationsList');
  if(conversations.length === 0){
    listContainer.innerHTML = '<p class="status-info">Brak aktywnych konwersacji.</p>';
    return;
  }
  
  let html = '';
  conversations.forEach(conv => {
    const isActive = conv.id === currentConversationId;
    const latestMsg = conv.lastMessage;
    
    // Logika wska≈∫nika nowej wiadomo≈õci
    let indicator = '';
    if(user.is_admin && latestMsg && latestMsg.sender_id === conv.user_id){
        // Admin widzi wska≈∫nik, je≈õli ostatnia wiadomo≈õƒá pochodzi od u≈ºytkownika
        indicator = '<span class="new-message-indicator">üî•</span>';
    } else if (!user.is_admin && latestMsg && latestMsg.sender_id === conv.admin_id && conv.status === 'open') {
        // Zwyk≈Çy u≈ºytkownik mo≈ºe mieƒá wska≈∫nik, je≈õli admin napisa≈Ç, a konwersacja jest otwarta
        // Mo≈ºna to rozszerzyƒá o dodatkowƒÖ flagƒô 'is_read'
        indicator = ''; // Na potrzeby tego promptu upraszczamy to do widoczno≈õci tylko dla Admina (lub gdy admin widzi wiadomo≈õƒá od u≈ºytkownika)
    }

    const eventInfo = conv.event ? `<div class="conv-event">${conv.event.name}</div>` : '';
    const lastMessageContent = latestMsg ? latestMsg.content.substring(0, 30) + (latestMsg.content.length > 30 ? '...' : '') : 'Brak wiadomo≈õci';

    html += `
      <div 
        class="conversation-item ${isActive ? 'active' : ''}" 
        onclick="selectConversation(${conv.id})">
        <div class="conversation-item-info">
            <span class="conv-username">${conv.otherUsername} ${indicator}</span>
            <span class="conv-event">${new Date(conv.lastMessage.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
        </div>
        ${eventInfo}
        <div class="conv-last-msg" style="font-size:13px; color:var(--muted);">${lastMessageContent}</div>
      </div>
    `;
  });
  
  listContainer.innerHTML = html;
}

/* ---------------------- WIADOMO≈öCI ---------------------- */

/**
 * Wybiera konwersacjƒô, aktualizuje widok i subskrybuje Realtime.
 */
async function selectConversation(convId){
    const conv = conversations.find(c => c.id === convId);
    if (!conv) return;

    // 1. Zmie≈Ñ aktywnƒÖ konwersacjƒô
    currentConversationId = convId;
    renderConversations(); // Od≈õwie≈ºenie listy dla nowego pod≈õwietlenia
    
    // 2. Aktualizuj nag≈Ç√≥wek czatu i pole input
    document.getElementById('chatHeader').innerHTML = `Rozmowa z: ${conv.otherUsername}`;
    document.getElementById('chatInputArea').style.display = conv.status === 'open' ? 'flex' : 'none';

    // 3. Wyczy≈õƒá i za≈Çaduj wiadomo≈õci
    await loadMessages(convId);
    
    // 4. Uruchom subskrypcjƒô Realtime
    setupRealtimeSubscription(convId);
}

/**
 * ≈Åaduje i wy≈õwietla wiadomo≈õci dla danej konwersacji.
 */
async function loadMessages(conversationId){
  const messagesContainer = document.getElementById('messagesContainer');
  messagesContainer.innerHTML = '<p class="status-info">≈Åadowanie wiadomo≈õci...</p>';
  
  const { data: messages, error } = await db
    .from('conversation_messages')
    .select('id, sender_id, content, created_at, sender:sender_id(username)')
    .eq('conversation_id', conversationId)
    .order('created_at', { ascending: true });
    
  if(error){
    console.error("B≈ÇƒÖd ≈Çadowania wiadomo≈õci:", error);
    messagesContainer.innerHTML = '<p class="status-info">B≈ÇƒÖd ≈Çadowania wiadomo≈õci.</p>';
    return;
  }
  
  renderMessages(messages || []);
}

/**
 * Renderuje wiadomo≈õci do kontenera.
 */
function renderMessages(messages){
  const messagesContainer = document.getElementById('messagesContainer');
  
  if(messages.length === 0){
    messagesContainer.innerHTML = '<p class="status-info">Brak wiadomo≈õci w tej konwersacji.</p>';
    return;
  }
  
  let html = '';
  messages.forEach(msg => {
    const isSent = msg.sender_id === user.id;
    const senderName = isSent ? 'Ty' : msg.sender.username;
    
    // Dodajemy nazwƒô nadawcy, tylko je≈õli nie jeste≈õmy adminem (lub jeste≈õmy adminem, ale rozm√≥wcƒÖ jest u≈ºytkownik)
    // Aby nie powtarzaƒá "Admin", gdy admin pisze do u≈ºytkownika, zostawiamy tylko nazwƒô drugiego
    const showSenderName = !isSent; // Pokazuj nazwƒô, tylko je≈õli wiadomo≈õƒá jest odebrana

    html += `
      <div class="message ${isSent ? 'sent' : 'received'}">
        ${showSenderName ? `<div class="message-sender">${senderName}</div>` : ''}
        <div>${msg.content}</div>
        <div style="font-size:10px; opacity:0.6; text-align:right;">${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
      </div>
    `;
  });
  
  messagesContainer.innerHTML = html;
  messagesContainer.scrollTop = messagesContainer.scrollHeight; // Przewi≈Ñ na d√≥≈Ç
}

/**
 * Obs≈Çuguje wysy≈Çanie nowej wiadomo≈õci.
 */
async function handleSendMessage(){
  const inputEl = document.getElementById('messageInput');
  const content = inputEl.value.trim();
  
  if(!content || !currentConversationId) return;
  
  inputEl.value = ''; // Wyczy≈õƒá pole natychmiast
  
  const { error } = await db
    .from('conversation_messages')
    .insert({
      conversation_id: currentConversationId,
      sender_id: user.id,
      content: content
    });
    
  if(error){
    console.error("B≈ÇƒÖd wysy≈Çania wiadomo≈õci:", error);
    alert('B≈ÇƒÖd wysy≈Çania wiadomo≈õci. Spr√≥buj ponownie.');
    inputEl.value = content; // Przywr√≥ƒá tre≈õƒá w razie b≈Çƒôdu
  } else {
    // Po udanym wys≈Çaniu, Realtime zajmie siƒô od≈õwie≈ºeniem wiadomo≈õci
    // Ale musimy te≈º zaktualizowaƒá listƒô konwersacji o ostatniƒÖ wiadomo≈õƒá
    await loadConversations();
  }
}

document.getElementById('messageInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        handleSendMessage();
    }
});


/* ---------------------- REAL-TIME ---------------------- */

/**
 * Ustanawia subskrypcjƒô Realtime dla wiadomo≈õci w danej konwersacji.
 */
function setupRealtimeSubscription(conversationId){
  // Je≈õli istnieje stara subskrypcja, usu≈Ñ jƒÖ
  if(messagesSubscription){
    db.removeChannel(messagesSubscription);
    messagesSubscription = null;
  }
  
  messagesSubscription = db.channel(`messages-conv-${conversationId}`)
    .on(
      'postgres_changes',
      { 
        event: 'INSERT', 
        schema: 'public', 
        table: 'conversation_messages',
        filter: `conversation_id=eq.${conversationId}`
      },
      (payload) => {
        console.log('Nowa wiadomo≈õƒá Realtime:', payload);
        // Od≈õwie≈º wiadomo≈õci
        loadMessages(conversationId);
        // Od≈õwie≈º konwersacje (aby zaktualizowaƒá ostatniƒÖ wiadomo≈õƒá w li≈õcie)
        loadConversations();
      }
    )
    .subscribe((status, err) => {
      if(status === 'CLOSED' || status === 'TIMED_OUT'){
          console.error("B≈ÇƒÖd Realtime:", err);
      }
    });
}
</script>

</body>
</html>
