<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamingHub ‚Ä¢ Filmy</title>
  <style>
    :root { --bg: #0b0d10; --card: #151922; --text: #e3e7ee; --muted: #a8bfe2; --brand: #4f7cff; --border: #232a37; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto; line-height: 1.4; }
    a { color: var(--text); text-decoration: none; }
    .container { max-width: 1100px; margin: 0 auto; padding: 16px; }
    header { position: sticky; top: 0; background: rgba(11,13,16,0.9); backdrop-filter: blur(6px); z-index: 10; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .nav { display: flex; gap: 12px; align-items: center; padding: 12px 16px; flex-wrap: wrap; }
    .brand { font-weight: 800; display:flex; align-items:center; gap:8px;}
    .nav input[type=search] { flex: 1; background: #0e1218; border: 1px solid var(--border); color: #fff; padding: 10px 12px; border-radius: 12px; min-width: 160px; }
    .menu { display: flex; gap: 8px; flex-wrap: wrap; align-items:center; }
    .menu a, .menu button { padding: 8px 10px; color: var(--muted); background: none; border: none; cursor: pointer; font-size: 0.95rem; }
    .menu a:hover { color:#fff; }
    .btn { background: var(--brand); color: #fff; padding: 8px 14px; border-radius: 12px; border: none; cursor: pointer; font-size: 14px; text-decoration:none; display:inline-block;}
    .btn.secondary { background: #2a3446; }
    .badge { font-size: 12px; color: #fff; background: #2a3446; padding: 2px 8px; border-radius: 999px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; margin-top:20px;}
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; overflow: hidden; transition:transform .2s; }
    .card:hover { transform:translateY(-4px); border-color:var(--brand); }
    .card.p { padding: 12px; border: 0; }
    .card img { width: 100%; height: 240px; object-fit: cover; display: block; background:#111; }
    .small { font-size: 12px; color: var(--muted); }
    .alert { background: #152031; padding: 10px; border-radius: 10px; color: #e3e7ee; margin: 8px 0; border:1px solid var(--brand); }
    .flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    textarea, input, select { width: 100%; padding: 10px; background: #0e1218; border: 1px solid var(--border); color: #fff; border-radius: 10px; font-size: 15px; }
    footer { color: var(--muted); text-align: center; padding: 30px 0; font-size: 14px; }
    .hidden { display: none !important; }
    .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; background: black; border-radius: 12px; }
    .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; }
    
    @media (max-width: 600px) {
      .grid { grid-template-columns: repeat(2, 1fr); }
      .card img { height: 180px; }
      .nav { flex-direction:column; align-items:stretch; }
      .menu { justify-content:center; margin-top:8px; }
    }
  </style>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="#" onclick="UI.show('home')">üé¨ <span>StreamingHub</span></a>
    <form onsubmit="event.preventDefault(); UI.search(this.q.value)" style="flex:1">
      <input type="search" name="q" placeholder="Szukaj film√≥w‚Ä¶" />
    </form>
    
    <nav class="menu" id="mainMenu">
      <a href="#" onclick="UI.show('home')">Filmy</a>
      <a href="/seriale/">Seriale</a>
      
      <span id="userLinks" class="flex hidden">
        <a href="/top/">TOP</a>
        <a href="/moja-biblioteka/">Biblioteka</a>
        <a href="#" id="adminLink" class="hidden" onclick="UI.show('admin')">Admin</a>
        <button onclick="Auth.logout()" class="btn secondary" style="padding:6px 12px;">Wyloguj</button>
      </span>

      <span id="guestLinks">
        <a href="login.html" class="btn">Zaloguj siƒô</a>
      </span>
    </nav>
  </div>
</header>

<main class="container" id="app"></main>

<footer>¬© <script>document.write(new Date().getFullYear())</script> StreamingHub</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

function toast(msg){ const d=document.createElement("div"); d.className="alert"; d.textContent=msg; d.style.position="fixed"; d.style.right="16px"; d.style.bottom="16px"; d.style.zIndex=9999; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); }
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s])); }

const Auth = {
  user: null,
  profile: null,
  async init() {
    const { data: { session } } = await db.auth.getSession();
    await Auth.setUser(session?.user);
    db.auth.onAuthStateChange(async (event, session) => {
      await Auth.setUser(session?.user);
      UI.updateHeader();
    });
  },
  async setUser(u) {
    Auth.user = u || null;
    if (u) {
      const { data } = await db.from("profiles").select("*").eq("id", u.id).maybeSingle();
      Auth.profile = data || null;
    } else {
      Auth.profile = null;
    }
    UI.updateHeader();
  },
  async logout() {
    await db.auth.signOut();
    toast("Wylogowano");
    UI.show("home");
  }
};

/* --- DATA ACCESS --- */
async function getMovies(filters={}){
  let q = db.from("movies").select("*");
  if(filters.q) q = q.ilike("title", `%${filters.q}%`);
  if(filters.category_id) q = q.eq("category_id", filters.category_id);
  if(filters.year) q = q.eq("year", filters.year);
  if(filters.min_duration) q = q.gte("duration", filters.min_duration);
  q = q.order("created_at", { ascending: false });
  const { data, error } = await q;
  return data||[];
}
async function getMovie(id){
  const { data } = await db.from("movies").select("*").eq("id", id).single();
  return data;
}
async function getCategories(){
  const { data } = await db.from("categories").select("*").order("name");
  return data||[];
}
async function getRatingsFor(movieId){
  const { data } = await db.from("ratings").select("score").eq("movie_id", movieId);
  return data||[];
}
async function getComments(movieId){
  const { data } = await db.from("comments").select("*, profiles(username)").eq("movie_id", movieId).order("created_at", {ascending:false});
  return data||[];
}
async function isUnlocked(userId, movieId){
  if(!userId) return false;
  const { data } = await db.from("unlocks").select("id").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  return !!data;
}

/* --- UI --- */
const UI = {
  el: ()=>document.getElementById("app"),
  
  updateHeader(){
    const u = Auth.user;
    const p = Auth.profile;
    const userLinks = document.getElementById("userLinks");
    const guestLinks = document.getElementById("guestLinks");
    const adminLink = document.getElementById("adminLink");

    if(u) {
      userLinks.classList.remove("hidden");
      guestLinks.classList.add("hidden");
      if(p?.is_admin) adminLink.classList.remove("hidden"); else adminLink.classList.add("hidden");
    } else {
      userLinks.classList.add("hidden");
      guestLinks.classList.remove("hidden");
    }
  },

  async show(view, params={}){
    const app = UI.el();
    const me = Auth.user;

    // --- HOME ---
    if(view==="home"){
      const cats = await getCategories();
      const movies = await getMovies({ sort:"new" });
      const ratingsMap = await UI._avgRatingsMap(movies.map(m=>m.id));

      app.innerHTML = `
        ${UI.filters(cats)}
        <h2 class="mt-4">Najnowsze filmy</h2>
        <div class="grid">
          ${movies.map(m=> UI.card(m, ratingsMap.get(m.id))).join("")}
        </div>
      `;
    }

    // --- MOVIE DETAIL ---
    else if(view==="movie"){
      const id = Number(params.id);
      let m; try { m = await getMovie(id); } catch { app.innerHTML=`<div class="alert">Nie znaleziono</div>`; return; }
      
      const [comments, ratings] = await Promise.all([ getComments(id), getRatingsFor(id) ]);
      const avg = ratings.length ? (ratings.reduce((a,b)=>a+b.score,0)/ratings.length).toFixed(1) : null;
      const unlocked = me ? await isUnlocked(me.id, id) : false;
      const canWatch = !!me && (unlocked || (m.points_required||0)===0);

      app.innerHTML = `
        <div class="flex" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <h1>${escapeHtml(m.title)}</h1>
            <div class="small" style="color:var(--brand)">${m.year||""} ‚Ä¢ ${m.duration||""} min</div>
          </div>
        </div>

        ${m.points_required > 0 && !unlocked ? 
          `<div class="alert">üîê Ten film wymaga <b>${m.points_required} pkt</b>.</div>` : ''}

        <img class="mt-4" src="${m.thumb}" style="width:100%;max-height:400px;object-fit:cover;border-radius:14px; margin:20px 0;"/>
        
        <p style="font-size:1.05rem; line-height:1.6; color:#ccc;">${escapeHtml(m.description||"Brak opisu.")}</p>

        <div style="margin:24px 0;">
          ${!me ? `<a href="login.html" class="btn">Zaloguj siƒô, aby obejrzeƒá</a>` : 
            (canWatch ? `<button class="btn" onclick="UI.show('watch',{id:${m.id}})">‚ñ∂ OglƒÖdaj</button>` : 
            `<button class="btn" onclick="UI.unlock(${m.id}, ${m.points_required})">Odblokuj (${m.points_required} pkt)</button>`
            )
          }
        </div>

        <hr style="border-color:var(--border); margin:30px 0;">
        
        <h3>Oceny (≈örednia: ${avg || '-'})</h3>
        ${me ? UI.ratingForm(m.id) : '<small>Zaloguj siƒô, aby oceniƒá.</small>'}

        <h3 style="margin-top:30px;">Komentarze</h3>
        ${me ? UI.commentForm(m.id) : ''}
        <div class="mt-4" id="commentsBox">
          ${comments.length ? comments.map(c=>`
            <div class="card p" style="margin-bottom:10px;">
              <div class="small" style="color:var(--brand)">${escapeHtml(c.profiles?.username || 'U≈ºytkownik')}</div>
              <div style="margin-top:4px;">${escapeHtml(c.text)}</div>
            </div>`).join('') : '<div class="small">Brak komentarzy.</div>'}
        </div>
      `;
    }

    // --- WATCH PLAYER ---
    else if(view==="watch"){
      if(!me) { alert("Musisz byƒá zalogowany!"); return UI.show("login"); }
      const id = Number(params.id);
      const m = await getMovie(id);
      
      // double check unlock
      const unlocked = await isUnlocked(me.id, id);
      if(!unlocked && (m.points_required||0)>0) return UI.show("movie",{id});

      // Zapisz historiƒô
      db.from("watch_history").insert({ user_id: me.id, movie_id: id, watched_at: new Date().toISOString() }).then(()=>{});

      app.innerHTML = `
        <button class="btn secondary" onclick="UI.show('movie',{id:${m.id}})" style="margin-bottom:12px;">‚Üê Powr√≥t</button>
        <div class="video-container">
          <iframe src="${m.iframe}" allowfullscreen></iframe>
        </div>
        <h2 style="margin-top:16px;">${escapeHtml(m.title)}</h2>
      `;
    }

    // --- ADMIN ---
    else if(view==="admin"){
      if(!(me && Auth.profile?.is_admin)){ app.innerHTML="<div class='alert'>Brak dostƒôpu</div>"; return; }
      // Uproszczony widok admina
      app.innerHTML = `<h1>Panel Admina</h1><p>Tu mo≈ºesz dodawaƒá filmy (kod w oryginale).</p>`;
    }
  },

  filters(categories){
    return `
    <div style="background:#11141b; padding:16px; border-radius:12px; margin-bottom:20px;">
      <form onsubmit="event.preventDefault(); UI.search(this.q.value, { category_id:this.cat.value })" style="display:flex; gap:10px; flex-wrap:wrap;">
        <select name="cat" style="max-width:200px;"><option value="">Wszystkie kategorie</option>${categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join("")}</select>
        <input name="q" placeholder="Szukaj tytu≈Çu..." style="flex:1;">
        <button class="btn">Szukaj</button>
      </form>
    </div>`;
  },

  card(m, avg){
    if(!m) return "";
    const slug = (m.title||"").toLowerCase().replace(/[^a-z0-9]+/g,"-");
    return `<div class="card" onclick="UI.show('movie',{id:${m.id}})" style="cursor:pointer">
      <img src="${m.thumb}" alt="${escapeHtml(m.title)}">
      <div class="card p">
        <div style="font-weight:700; font-size:0.95rem; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(m.title)}</div>
        <div class="flex" style="justify-content:space-between;">
          <span class="small">${m.year||""}</span>
          <span class="badge">‚òÖ ${avg?avg.toFixed(1):"-"}</span>
        </div>
      </div>
    </div>`;
  },

  ratingForm(id){
    return `<form onsubmit="event.preventDefault(); UI.rate(${id}, this.score.value)" class="flex">
      <select name="score" style="width:auto;"><option value="10">10</option><option value="5">5</option><option value="1">1</option></select>
      <button class="btn secondary">Oce≈Ñ</button>
    </form>`;
  },
  
  commentForm(id){
    return `<form onsubmit="event.preventDefault(); UI.comment(${id}, this.text.value); this.reset();">
      <textarea name="text" rows="2" placeholder="Napisz komentarz..."></textarea>
      <button class="btn" style="margin-top:8px;">Wy≈õlij</button>
    </form>`;
  },

  async unlock(movieId, cost){
    if(!confirm(`Odblokowaƒá film za ${cost} punkt√≥w?`)) return;
    const me = Auth.user;
    const points = Auth.profile.points || 0;
    if(points < cost) return alert("Za ma≈Ço punkt√≥w!");
    
    await db.from("profiles").update({ points: points - cost }).eq("id", me.id);
    await db.from("unlocks").insert({ user_id: me.id, movie_id: movieId });
    await db.from("points_log").insert({ user_id: me.id, change: -cost, reason: "Odblokowanie filmu" });
    
    alert("Film odblokowany!");
    Auth.setUser(me); // od≈õwie≈º punkty
    UI.show('watch', {id: movieId});
  },

  async search(q, extra={}){
    const movies = await getMovies({ q, ...extra });
    const ratingsMap = await UI._avgRatingsMap(movies.map(m=>m.id));
    const list = document.querySelector(".grid");
    if(list) list.innerHTML = movies.map(m=>UI.card(m, ratingsMap.get(m.id))).join("") || '<div class="small">Brak wynik√≥w.</div>';
  },

  async _avgRatingsMap(ids){
    const map = new Map();
    if(!ids.length) return map;
    const { data } = await db.from("ratings").select("movie_id, score").in("movie_id", ids);
    const by = {};
    (data||[]).forEach(r=>{ by[r.movie_id] ||= []; by[r.movie_id].push(r.score); });
    ids.forEach(id=>{ const a=by[id]; map.set(id, a ? a.reduce((x,y)=>x+y,0)/a.length : null); });
    return map;
  },

  async rate(mid, score){
    await db.from("ratings").upsert({ movie_id: mid, user_id: Auth.user.id, score: Number(score) });
    alert("Oceniono!");
  },

  async comment(mid, text){
    if(!text.trim()) return;
    await db.from("comments").insert({ movie_id: mid, user_id: Auth.user.id, text: text.trim() });
    UI.show('movie', {id: mid});
  }
};

// Start
Auth.init();
UI.show('home');

// Hash handler
window.addEventListener("hashchange", ()=>{
  // opcjonalnie obs≈Çuga hasha
});
</script>
</body>
</html>
