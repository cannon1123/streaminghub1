
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamingHub ‚Ä¢ Filmy</title>
  <style>

:root {
  --bg: #0b0d10;
  --card: #151922;
  --text: #e3e7ee;
  --muted: #a8bfe2;
  --brand: #4f7cff;
  --border: #232a37;
}

* { box-sizing: border-box; }
body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
  line-height: 1.4;
}

a { color: var(--text); text-decoration: none; }

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
}

header {
  position: sticky;
  top: 0;
  background: rgba(11,13,16,0.9);
  backdrop-filter: blur(6px);
  z-index: 10;
}

.nav {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 12px 16px;
  flex-wrap: wrap;
}

.brand { font-weight: 800; }

.nav input[type=search] {
  flex: 1;
  background: #0e1218;
  border: 1px solid var(--border);
  color: #fff;
  padding: 10px 12px;
  border-radius: 12px;
  min-width: 160px;
}

.menu {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.menu a, .menu button {
  padding: 8px 10px;
  color: var(--muted);
  background: none;
  border: none;
  cursor: pointer;
}

.btn {
  background: var(--brand);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 15px;
}

.btn.secondary { background: #2a3446; }

.badge {
  font-size: 12px;
  color: #fff;
  background: #2a3446;
  padding: 2px 8px;
  border-radius: 999px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}

.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  overflow: hidden;
}

.card.p { padding: 12px; border: 0; }

.card img {
  width: 100%;
  height: 200px;
  object-fit: cover;
  display: block;
}

.small { font-size: 12px; color: var(--muted); }

.alert {
  background: #152031;
  padding: 10px;
  border-radius: 10px;
  color: #0e1218;
  margin: 8px 0;
}

.flex { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

.row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

textarea, input, select {
  width: 100%;
  padding: 10px;
  background: #0e1218;
  border: 1px solid var(--border);
  color: #fff;
  border-radius: 10px;
  font-size: 15px;
}

footer {
  color: var(--muted);
  text-align: center;
  padding: 30px 0;
  font-size: 14px;
}

.hidden { display: none; }

.video-container {
  position: relative;
  width: 100%;
  padding-bottom: 56.25%;
  height: 0;
  overflow: hidden;
  background: black;
  border-radius: 22px;
}

.video-container iframe {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  border: 0;
}

/* RESPONSYWNO≈öƒÜ */
@media (max-width: 900px) {
  .row { grid-template-columns: 1fr; }
  .nav { flex-direction: column; align-items: stretch; }
  .menu { justify-content: center; }
  .card img { height: 180px; }
  .container { padding: 12px; }
}

@media (max-width: 600px) {
  .grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
  .btn { padding: 10px 12px; font-size: 14px; }
  h1, h2, h3 { font-size: 1.1rem; }
  .card img { height: 150px; }
  input, select, textarea { font-size: 14px; }
  .flex { gap: 8px; }
}

@media (max-width: 400px) {
  .nav { padding: 8px; }
  .nav input[type=search] { padding: 8px; font-size: 14px; }
  .menu a, .menu button { font-size: 13px; }
  .grid { grid-template-columns: 1fr 1fr; gap: 8px; }
  .card img { height: 130px; }
  footer { font-size: 12px; }
}

/* --- STYLES FOR AI ASSISTANT WIDGET --- */
#ai-chat-button {
    position: fixed;
    bottom: 30px;
    right: 30px;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: var(--brand); /* U≈ºywamy Twojego koloru #4f7cff */
    color: white;
    font-size: 20px;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    z-index: 1001; /* Wy≈ºej ni≈º header */
    transition: transform 0.2s;
}

#ai-chat-button:hover {
    transform: scale(1.05);
}

#ai-chat-window {
    position: fixed;
    bottom: 90px;
    right: 30px;
    width: 330px;
    height: 480px;
    background: var(--card); /* U≈ºywamy Twojego koloru #151922 */
    border: 1px solid var(--border);
    border-radius: 14px;
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    z-index: 1000;
}

#ai-chat-window.hidden {
    display: none;
}

#chat-header-ai {
    padding: 12px;
    background: var(--brand);
    color: var(--text);
    font-weight: bold;
    border-top-left-radius: 13px;
    border-top-right-radius: 13px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#chat-header-ai button {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

#chat-body-ai {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto;
    background-color: var(--bg);
    border-bottom: 1px solid var(--border);
    /* Stylizacja scrollbara */
    scrollbar-width: thin;
    scrollbar-color: var(--border) transparent;
}
#chat-body-ai::-webkit-scrollbar { width: 8px; }
#chat-body-ai::-webkit-scrollbar-thumb { background-color: var(--border); border-radius: 4px; }

.message-ai {
    padding: 8px 12px;
    margin: 6px 0;
    border-radius: 10px;
    max-width: 85%;
    line-height: 1.5;
}

.user-message-ai {
    background-color: #2a3446; /* Trochƒô ciemniejszy ni≈º muted */
    color: var(--text);
    margin-left: auto;
}

.ai-message-ai {
    background-color: var(--brand);
    color: white;
    margin-right: auto;
    border-bottom-left-radius: 2px;
}

#chat-input-container-ai {
    padding: 10px;
    display: flex;
    gap: 8px;
    background: var(--card);
    border-bottom-left-radius: 14px;
    border-bottom-right-radius: 14px;
}

#user-input-ai {
    flex-grow: 1;
    padding: 10px;
    background: #0e1218;
    border: 1px solid var(--border);
    color: #fff;
    border-radius: 10px;
    font-size: 15px;
}

#send-button-ai {
    background: var(--brand);
    color: white;
    border: none;
    border-radius: 10px;
    padding: 10px 15px;
    cursor: pointer;
    font-size: 15px;
}
</style>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="#" onclick="UI.show('home')">üé¨ StreamingHub</a>
    <form onsubmit="event.preventDefault(); UI.search(this.q.value)" style="flex:1">
      <input type="search" name="q" placeholder="Szukaj film√≥w‚Ä¶" />
    </form>
    
<nav class="menu flex">
  <a href="#" onclick="UI.show('home')">Filmy</a>
  <a href="/seriale/">Seriale</a>
  <a href="/top/">TOP</a>
  <a href="/moja-biblioteka/">Moja biblioteka</a>
  
  <div id="auth-controls" class="flex">
    </div>
</nav>
</form>


</header>
<button id="ai-chat-button" aria-label="Otw√≥rz czat z asystentem AI">ü§ñ</button>

<div id="ai-chat-window" class="hidden">
    <div id="chat-header-ai">
        Asystent Filmowy AI
        <button id="close-button-ai">‚úñ</button>
    </div>
    <div id="chat-body-ai">
        <div class="message-ai ai-message-ai">Cze≈õƒá! Jestem Twoim Asystentem Filmowym. Powiedz mi, na co masz ochotƒô, a znajdƒô idealny film! !!!BOT JEST OFFLINE DO WYPUSZCZENIA PE≈ÅNEJ WERSJI!!!</div>
    </div>
    <div id="chat-input-container-ai">
        <input type="text" id="user-input-ai" placeholder="Wpisz swoje preferencje...">
        <button id="send-button-ai" disabled>Wy≈õlij</button>
    </div>
</div>
<main class="container" id="app"></main>

<footer>¬© <script>document.write(new Date().getFullYear())</script> StreamingHub ‚Ä¢ free video</footer>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* =========================
   KONFIG: PODMIE≈É NA SWOJE
   ========================= */
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* =========================
   UTILS
   ========================= */
const delay = (ms)=>new Promise(r=>setTimeout(r,ms));
function escapeHtml(str){ return (str||"").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[s])); }
function toast(msg){ const d=document.createElement("div"); d.className="alert"; d.textContent=msg; d.style.position="fixed"; d.style.right="16px"; d.style.bottom="16px"; d.style.zIndex=9999; document.body.appendChild(d); setTimeout(()=>d.remove(),2200); }

/* =========================
   AUTH + PROFILES
   ========================= */
const Auth = {
async currentUser(){ 
  const { data:{ user } } = await db.auth.getUser(); 
  return user || null; 
},

  async currentProfile(){
    const user = await Auth.currentUser(); if(!user) return null;
    const { data, error } = await db.from("profiles").select("*").eq("id", user.id).maybeSingle();
    if(error){ console.error(error); return null; }
    return data ? { ...user, ...data } : { ...user };
  },
  async register(username, email, password){
    const { data, error } = await db.auth.signUp({ email, password });
    if(error) return alert("‚ùå " + error.message);
    const user = data.user;
    // profil mo≈ºe ju≈º byƒá tworzony triggerem; mimo to upsert bezpieczny
    const { error: pErr } = await db.from("profiles").upsert({
      id: user.id, username, points: 0, is_admin: false
    });
    if(pErr) console.warn("Profil:", pErr.message);
    toast("‚úîÔ∏è Konto utworzone. Sprawd≈∫ e-mail (je≈õli wymagane).");
    UI.show("home");
  },
  async login(email, password){
    const { error } = await db.auth.signInWithPassword({ email, password });
    if(error) return alert("‚ùå " + error.message);
    await UI.updateHeader();
    toast("‚úîÔ∏è Zalogowano");
    UI.show("home");
  },
  async logout(){ await db.auth.signOut(); await UI.updateHeader(); toast("Wylogowano"); UI.show("home"); }
};

// reaguj na zmianƒô sesji
db.auth.onAuthStateChange(async ()=>{ UI.updateHeader(); });

/* =========================
   DATA ACCESS (Supabase)
   ========================= */
// Movies
async function getMovies(filters={}){
  let q = db.from("movies").select("*");
  if(filters.q) q = q.ilike("title", `%${filters.q}%`);
  if(filters.category_id) q = q.eq("category_id", filters.category_id);
  if(filters.year) q = q.eq("year", filters.year);
  if(filters.min_duration) q = q.gte("duration", filters.min_duration);
  // sort
  if(filters.sort === "new") q = q.order("created_at", { ascending: false });
  else q = q.order("created_at", { ascending: false });
  const { data, error } = await q;
  if(error) throw error;
  return data||[];
}
async function getMovie(id){
  const { data, error } = await db.from("movies_secure").select("*").eq("id", id).single();
  if(error) throw error; return data;
}
async function addMovie(payload){ return db.from("movies").insert(payload); }
async function deleteMovie(id){ return db.from("movies").delete().eq("id", id); }

// Categories
async function getCategories(){
  const { data, error } = await db.from("categories").select("*").order("name");
  if(error) throw error; return data||[];
}
async function addCategory(name){ return db.from("categories").insert({ name }); }
async function delCategory(id){ return db.from("categories").delete().eq("id", id); }

// Ratings
async function getRatingsFor(movieId){
  const { data, error } = await db.from("ratings").select("score").eq("movie_id", movieId);
  if(error) throw error; return data||[];
}
async function upsertRating(movieId, userId, score){
  return db.from("ratings").upsert({ movie_id: movieId, user_id: userId, score });
}
async function getUserRating(movieId, userId){
  const { data, error } = await db.from("ratings").select("*").eq("movie_id", movieId).eq("user_id", userId).maybeSingle();
  if(error) throw error; return data||null;
}

// Comments
async function getComments(movieId){
  // pobierz komentarze + nazwƒô autora z profiles
  const { data, error } = await db
    .from("comments")
    .select("id,text,created_at,user_id,profiles(username)")
    .eq("movie_id", movieId)
    .order("created_at", { ascending:false });
  if(error) throw error; return data||[];
}
async function addComment(movieId, userId, text){
  return db.from("comments").insert({ movie_id: movieId, user_id: userId, text });
}

// Wishlist
async function getWishlist(userId){
  const { data, error } = await db.from("wishlist").select("movie_id").eq("user_id", userId);
  if(error) throw error; return new Set((data||[]).map(x=>x.movie_id));
}
async function toggleWishlist(userId, movieId){
  const { data, error } = await db.from("wishlist").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") console.warn(error);
  if(data){
    return db.from("wishlist").delete().eq("id", data.id);
  } else {
    return db.from("wishlist").insert({ user_id:userId, movie_id:movieId });
  }
}

// Watch history
async function addWatch(userId, movieId){
  return db.from("watch_history").insert({ user_id: userId, movie_id: movieId, watched_at: new Date().toISOString() });
}
async function getWatchHistory(userId, limit=100){
  const { data, error } = await db
    .from("watch_history")
    .select("movie_id, watched_at, movies(title,thumb,id)")
    .eq("user_id", userId)
    .order("watched_at", { ascending:false })
    .limit(limit);
  if(error) throw error; return data||[];
}

async function buyMovie(movieId, pointsRequired, megaUrl) {
  const userId = getCurrentUserId(); // Zak≈Çadam, ≈ºe masz funkcjƒô zwracajƒÖcƒÖ aktualne ID u≈ºytkownika

  // Pobierz dane u≈ºytkownika
  const { data: user, error: userError } = await supabase
    .from('users')
    .select('points')
    .eq('id', userId)
    .single();

  if (userError || !user) {
    alert('Nie uda≈Ço siƒô pobraƒá danych u≈ºytkownika.');
    return;
  }

  // Sprawd≈∫, czy u≈ºytkownik ma wystarczajƒÖcƒÖ liczbƒô punkt√≥w
  if (user.points < pointsRequired) {
    alert('Masz za ma≈Ço punkt√≥w, aby kupiƒá ten film.');
    return;
  }

  // Odejmij punkty
  const { error: updateError } = await supabase
    .from('users')
    .update({ points: user.points - pointsRequired })
    .eq('id', userId);

  if (updateError) {
    alert('Nie uda≈Ço siƒô zaktualizowaƒá punkt√≥w.');
    return;
  }

  // Dodaj wpis do tabeli unlocks
  const { error: insertError } = await supabase
    .from('unlocks')
    .insert([{ user_id: userId, movie_id: movieId }]);

  if (insertError) {
    alert('Nie uda≈Ço siƒô odblokowaƒá filmu.');
    return;
  }

  // Od≈õwie≈º przycisk, by zmieni≈Ç siƒô na ‚ÄûOglƒÖdaj‚Äù
  renderMovieButton(movieId, pointsRequired, megaUrl);
}

// Points & unlocks
async function addPoints(userId, change, reason){
  // 1) log
  const { error: logErr } = await db.from("points_log").insert({ user_id:userId, change, reason });
  if(logErr) throw logErr;
  // 2) update profiles.points (race-safe-ish: re-read then set)
  const { data: prof } = await db.from("profiles").select("points").eq("id", userId).single();
  const next = (prof?.points||0) + change;
  const { error: upErr } = await db.from("profiles").update({ points: next }).eq("id", userId);
  if(upErr) throw upErr;
}
async function getPoints(userId){
  const { data, error } = await db.from("profiles").select("points").eq("id", userId).single();
  if(error) throw error; return data?.points||0;
}
async function ensureUnlocked(userId, movieId){
  const { data, error } = await db.from("unlocks").select("*").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") throw error;
  if(!data){ const { error: insErr } = await db.from("unlocks").insert({ user_id:userId, movie_id:movieId }); if(insErr) throw insErr; }
}
async function isUnlocked(userId, movieId){
  const { data, error } = await db.from("unlocks").select("id").eq("user_id", userId).eq("movie_id", movieId).maybeSingle();
  if(error && error.code!=="PGRST116") throw error;
  return !!data;
}

// Codes
async function redeemCode(userId, codeStr){
  const code = (codeStr||"").trim();
  if(!code) return { ok:false, msg:"Podaj kod" };
  const { data, error } = await db.from("codes").select("*").eq("code", code).maybeSingle();
  if(error) return { ok:false, msg:error.message };
  if(!data) return { ok:false, msg:"Nieprawid≈Çowy kod" };
  if((data.limit_left||0) <= 0) return { ok:false, msg:"Wyczerpany limit u≈ºyƒá" };
  if(data.expires && new Date(data.expires) < new Date()) return { ok:false, msg:"Kod wygas≈Ç" };

  if(data.type === "points"){
    await addPoints(userId, data.amount, `Kod: ${data.code}`);
  } else if(data.type === "premium"){
    // wymaga kolumny premium_until w profiles
    const { data: prof } = await db.from("profiles").select("premium_until").eq("id", userId).maybeSingle();
    if(!prof || typeof prof.premium_until === "undefined"){
      return { ok:false, msg:"Brak pola premium w profiles (premium_until)" };
    }
    const days = Number(data.days||data.amount||7);
    const base = prof.premium_until ? new Date(prof.premium_until) : new Date();
    const start = (prof.premium_until && new Date(prof.premium_until) > new Date()) ? new Date(prof.premium_until) : new Date();
    const until = new Date(start.getTime() + days*24*60*60*1000);
    const { error: upErr } = await db.from("profiles").update({ premium_until: until.toISOString() }).eq("id", userId);
    if(upErr) return { ok:false, msg: upErr.message };
  }
  // zmniejsz limit
  await db.from("codes").update({ limit_left: (data.limit_left||0) - 1 }).eq("id", data.id);
  return { ok:true, msg:"Kod zrealizowany ‚úîÔ∏è" };
}

// Leaderboard (last N days)
async function leaderboard(days){
  const since = new Date(Date.now() - days*24*60*60*1000).toISOString();
  const { data, error } = await db.from("points_log").select("user_id, change, created_at").gte("created_at", since);
  if(error) throw error;
  const map = new Map();
  (data||[]).forEach(r=>{ if(r.change>0) map.set(r.user_id, (map.get(r.user_id)||0) + r.change); });
  const entries = [...map.entries()].map(([user_id, gained])=>({ user_id, gained }));
  entries.sort((a,b)=>b.gained-a.gained);
  const top = entries.slice(0,100);
  // do≈ÇƒÖcz nicki
  if(top.length){
    const ids = top.map(t=>t.user_id);
    const { data: profs } = await db.from("profiles").select("id,username").in("id", ids);
    const nameById = new Map((profs||[]).map(p=>[p.id,p.username]));
    top.forEach(t=> t.username = nameById.get(t.user_id)||"U≈ºytkownik");
  }
  return top.map((t,i)=>({ rank:i+1, user:t.username, gained:t.gained }));
}

  const Router = {
  async go(slug){
    history.pushState({}, "", "/filmy/" + slug);
    await this.resolve();
  },

  async resolve(){
    const path = location.pathname;
    if(path.startsWith("/filmy/")){
      const slug = path.split("/filmy/")[1];
      const { data } = await db
        .from("movies")
        .select("*")
        .eq("slug", slug)
        .single();

      if(data){
        UI.show("movie", { id: data.id });
        document.title = `${data.title} ‚Äì StreamingHub`;
      }
    }
  }
};

window.addEventListener("popstate", () => Router.resolve());
window.addEventListener("DOMContentLoaded", () => Router.resolve());

/* =========================
   UI
   ========================= */
const UI = {
  el: ()=>document.getElementById("app"),
 
  async updateHeader(){
  const me = await Auth.currentUser(); // Sprawdzamy sesjƒô
  const authControls = document.getElementById("auth-controls");
  if(!authControls) return;

  if(me) {
    // Je≈õli zalogowany: poka≈º Wyloguj
    authControls.innerHTML = `
      <button class="btn secondary" onclick="Auth.logout()">Wyloguj</button>
    `;
  } else {
    // Je≈õli wylogowany: poka≈º Zaloguj
    authControls.innerHTML = `
      <button class="btn" onclick="window.location='/login/'">Zaloguj</button>
    `;
  }
},
  async show(view, params={}){
    const app = UI.el();
    const me = await Auth.currentProfile();

    // HOME
    if(view==="home"){
      const cats = await getCategories();
      const movies = await getMovies({ sort:"new" });

      // policz ratingi zbiorczo
      const ratingsMap = await UI._avgRatingsMap(movies.map(m=>m.id));

      // Historia dla zalogowanych
      let historyHTML = "";
      app.innerHTML = `
        ${UI.filters(cats)}
        ${historyHTML}
        <section class="section mt-8">
          <div class="flex" style="justify-content:space-between">
            <h2>Nowo dodane</h2>
            <a class="small" href="#" onclick="UI.search('', {sort:'new'})">Naj≈õwie≈ºsze ‚Üí</a>
          </div>
          <div class="grid">
            ${movies.map(m=> UI.card(m, ratingsMap.get(m.id))).join("")}
          </div>
        </section>
      `;
    }

    // MOVIE
    else if(view==="movie"){
      const id = Number(params.id);
      let m; try { m = await getMovie(id); } catch { app.innerHTML=`<div class="alert">Nie znaleziono</div>`; return; }
      const [comments, ratings] = await Promise.all([ getComments(id), getRatingsFor(id) ]);
      const avg = ratings.length ? (ratings.reduce((a,b)=>a+b.score,0)/ratings.length).toFixed(1) : null;
      const youRated = me ? await getUserRating(id, me.id) : null;
      const unlocked = me ? await isUnlocked(me.id, id) : false;
      const canWatch = !!me && (unlocked || (m.points_required||0)===0);

      app.innerHTML = `
        <div class="flex" style="justify-content:space-between;">
          <div>
            <h1>${escapeHtml(m.title)}</h1>
            <div class="small">Rok: ${m.year||"?"} ‚Ä¢ D≈Çugo≈õƒá: ${m.duration||"?"} min</div>
            ${m.points_required ? `
    <div class="mt-2 alert">
    Dostƒôp za: <b>${m.points_required}</b> pkt
    ${me && !(await isUnlocked(me.id, m.id)) ? `
      <button class="btn mt-2" onclick="UI.buyMovie(${m.id}, ${m.points_required})">
        Kup dostƒôp
      </button>
    ` : ""}
  </div>` : ""}

          </div>
          <div class="flex">
            ${me ? `<button class="btn secondary" onclick="UI.onToggleWishlist(${m.id})">Chcƒô obejrzeƒá</button>` : ""}
          </div>
        </div>
        <img class="mt-4" src="${m.thumb}" style="width:100%;max-height:360px;object-fit:cover;border-radius:14px"/>
        <div class="mt-4"><p>${escapeHtml(m.description||"")}</p></div>

        <div class="mt-4">
          ${me ? (canWatch ? `<a class="btn" href="#" onclick="UI.show('watch',{id:${m.id}})">OglƒÖdaj</a>` :
            `<button class="btn" onclick="UI.unlock(${m.id})">Odblokuj za punkty</button> <span class="small">Masz: <span id="myPoints">‚Ä¶</span> pkt</span>`) :
            `<a class="btn" href="#" onclick="UI.show('login')">Zaloguj, aby oglƒÖdaƒá</a>`}
        </div>

        <hr class="mt-8">
        <section class="mt-4">
          <h3>Oceny</h3>
          <div class="flex" style="gap:16px;align-items:center">
            <div>≈örednia: <strong>${avg?avg:'-'}</strong>/10 (${ratings.length || 0} ocen)</div>
            ${me ? `
              <form class="flex" onsubmit="event.preventDefault(); UI.rate(${m.id}, this.score.value)">
                <select name="score">
                  ${Array.from({length:10},(_,i)=>i+1).map(i=>`<option value="${i}" ${youRated&&youRated.score===i?'selected':''}>${i}</option>`).join('')}
                </select>
                <button class="btn secondary">Oce≈Ñ</button>
              </form>
            ` : ""}
          </div>
        </section>

        <section class="mt-4">
          <h3>Komentarze</h3>
          ${me ? `
            <form onsubmit="event.preventDefault(); UI.comment(${m.id}, this.text.value); this.reset();">
              <textarea name="text" rows="3" placeholder="Napisz komentarz..."></textarea>
              <button class="btn mt-2">Dodaj</button>
            </form>` : `<div class="alert">Zaloguj siƒô, aby dodaƒá komentarz.</div>`}
          <div class="mt-4" id="commentsBox">
            ${comments.map(c=>`
              <div class="card p">
                <div class="small"><b>${escapeHtml(c.profiles?.username || 'U≈ºytkownik')}</b> ‚Ä¢ ${new Date(c.created_at).toLocaleString()}</div>
                <div class="mt-2">${escapeHtml(c.text)}</div>
              </div>`).join('')}
          </div>
        </section>
      `;

      // je≈õli trzeba, do≈Çaduj punkty
      if(me && m.points_required){
        const pts = await getPoints(me.id);
        const el = document.getElementById("myPoints"); if(el) el.textContent = pts;
      }
    }

    // WATCH
    else if(view==="watch"){
      if(!me) return UI.show("login");
      const id = Number(params.id);
      const m = await getMovie(id);
      const unlocked = await isUnlocked(me.id, id);
      if(!unlocked && (m.points_required||0)>0){ return UI.show("movie",{id}); }
      await addWatch(me.id, id);
      app.innerHTML = `
        <div class="flex" style="justify-content:space-between;align-items:center">
          <h1>Odtwarzacz: ${escapeHtml(m.title)}</h1>
          <a class="btn secondary" href="#" onclick="UI.show('movie',{id:${m.id}})">‚Üê Powr√≥t</a>
        </div>
        <div class="video-container mt-4"><iframe src="${m.iframe}" allowfullscreen></iframe></div>
        <div class="small mt-2">Jako≈õƒá, g≈Ço≈õno≈õƒá i prƒôdko≈õƒá ustawia hosting iframe.</div>
      `;
    }

    // LOGIN/REGISTER/PROFILE usuniƒôte - tylko filmy

    // TOP usuniƒôte - tylko filmy

    else if(view==="admin"){
      if(!(me && me.is_admin)){ app.innerHTML = "<div class='alert'>Brak dostƒôpu.</div>"; return; }
      const [cats, movies] = await Promise.all([getCategories(), getMovies()]);
      app.innerHTML = `
        <h1>Panel admina</h1>
        <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
          <div class="card p">
            <h3>Dodaj film</h3>
            <form onsubmit="event.preventDefault(); UI.addMovie(this)">
              <label>Tytu≈Ç</label><input name="title" required>
              <label>Opis</label><textarea name="description"></textarea>
              <label>Miniatura (URL)</label><input name="thumb" required>
              <label>Iframe src (URL hostingu)</label><input name="iframe" required placeholder="https://...">
              <div class="row">
                <div>
                  <label>Kategoria</label>
                  <select name="category_id">${cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}</select>
                </div>
                <div><label>Rok</label><input type="number" name="year"></div>
              </div>
              <div class="row">
                <div><label>D≈Çugo≈õƒá (min)</label><input type="number" name="duration"></div>
                <div><label>Punkty wymagane</label><input type="number" name="points_required" value="0"></div>
              </div>
              <button class="btn mt-2">Dodaj</button>
            </form>
          </div>

          <div class="card p">
            <h3>Kategorie</h3>
            <form class="flex" onsubmit="event.preventDefault(); UI.addCategory(this.name.value); this.reset();">
              <input name="name" placeholder="Nazwa kategorii">
              <button class="btn secondary">Dodaj</button>
            </form>
            <div class="mt-2">
              ${cats.map(c=>`<span class="badge" style="margin-right:6px">${escapeHtml(c.name)} <a href="#" onclick="UI.delCategory(${c.id})" class="small">√ó</a></span>`).join(" ")}
            </div>
          </div>

          <div class="card p" style="grid-column:1/3">
            <h3>Lista film√≥w</h3>
            <table style="width:100%;border-collapse:collapse">
              <tr><th style="text-align:left">Tytu≈Ç</th><th>Punkty</th><th></th></tr>
              ${movies.map(m=>`
                <tr>
                  <td><a href="#" onclick="UI.show('movie',{id:${m.id}})">${escapeHtml(m.title)}</a></td>
                  <td>${m.points_required||0}</td>
                  <td><button class="btn secondary" onclick="UI.deleteMovie(${m.id})">Usu≈Ñ</button></td>
                </tr>`).join("")}
            </table>
          </div>
        </div>
      `;
    }
  },

  async _avgRatingsMap(movieIds){
    const map = new Map();
    if(!movieIds.length) return map;
    const { data, error } = await db.from("ratings").select("movie_id, score").in("movie_id", movieIds);
    if(error) return map;
    const by = {};
    (data||[]).forEach(r=>{
      by[r.movie_id] ||= [];
      by[r.movie_id].push(r.score);
    });
    movieIds.forEach(id=>{
      const arr = by[id]||[];
      map.set(id, arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : null);
    });
    return map;
  },

  filters(categories){
    return `
    <section class="section mt-8">
      <h2>Filtruj</h2>
      <form class="form" onsubmit="event.preventDefault(); UI.search(this.q.value, {
        category_id:this.cat.value||null, year:this.year.value||null,
        min_duration:this.len.value||null, sort:this.sort.value
      })">
        <div class="row">
          <div><label>Kategoria</label>
            <select name="cat"><option value="">‚Äî</option>${categories.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("")}</select>
          </div>
          <div><label>Rok</label><input type="number" name="year"></div>
        </div>
        <div class="row">
          <div><label>Min. d≈Çugo≈õƒá (min)</label><input type="number" name="len"></div>
          <div><label>Sortowanie</label>
            <select name="sort">
              <option value="new">Najnowsze</option>
            </select>
          </div>
        </div>
        <label>Szukaj</label><input type="text" name="q" placeholder="Tytu≈Ç...">
        <button class="btn mt-4">Szukaj</button>
      </form>
    </section>`;
  },

  // <-- ZAMIANA: tutaj zmieni≈Çem linki aby ustawia≈Çy #hash wygenerowany z tytu≈Çu
  card(m, avg){
    if(!m) return "";
    // funkcja czyszczƒÖca tytu≈Ç na hash (bez polskich znak√≥w, spacje -> '-')
    const clean = (str) => (str||"").toLowerCase()
      .replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/g, c => ({ "ƒÖ":"a","ƒá":"c","ƒô":"e","≈Ç":"l","≈Ñ":"n","√≥":"o","≈õ":"s","≈∫":"z","≈º":"z" }[c]||c))
      .replace(/[^a-z0-9\-]+/g,"-")
      .replace(/\-+/g,"-")
      .replace(/^\-|\-$/g,"");
    const slug = clean(m.title);
    return `<div class="card">
      <a href="/filmy/${slug}" onclick="event.preventDefault(); Router.go('${slug}')"><img src="${m.thumb}" alt="${escapeHtml(m.title)}"></a>
      <div class="card p">
        <div class="flex" style="justify-content:space-between;">
          <strong><a href="/filmy/${slug}" onclick="event.preventDefault(); Router.go('${slug}')">${escapeHtml(m.title)}</a></strong>
          <span class="badge">‚òÖ ${avg?avg.toFixed(1):"-"}</span>
        </div>
        <div class="small mt-2">czas: ${m.duration||"?"} min ‚Ä¢ rok: ${m.year||"?"}</div>
      </div>
    </div>`;
  },

  async search(q, extra={}){
    const cats = await getCategories();
    const movies = await getMovies({ q, ...extra });
    const ratingsMap = await UI._avgRatingsMap(movies.map(m=>m.id));
    const app = UI.el();
    app.innerHTML = UI.filters(cats) + `
      <h3 class="mt-4">Wyniki</h3>
      <div class="grid">${movies.map(m=>UI.card(m, ratingsMap.get(m.id))).join("") || '<div class="small">Brak wynik√≥w.</div>'}</div>
    `;
  },

  async onToggleWishlist(movieId){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    await toggleWishlist(me.id, movieId);
    toast("Zaktualizowano listƒô.");
  },

  async unlock(movieId){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    const m = await getMovie(movieId);
    if((m.points_required||0)===0){ await ensureUnlocked(me.id, movieId); return UI.show('watch',{id:movieId}); }
    const have = await getPoints(me.id);
    if(have < (m.points_required||0)) return toast("Za ma≈Ço punkt√≥w");
    await addPoints(me.id, -(m.points_required||0), `Odblokowanie: ${m.title}`);
    await ensureUnlocked(me.id, movieId);
    toast("Odblokowano ‚úîÔ∏è"); UI.show('watch',{id:movieId});
  },

async rate(movieId, score){
  const me = await Auth.currentProfile();
  if (!me) return UI.show("login");
  score = Number(score);

  // sprawd≈∫, czy u≈ºytkownik ju≈º ocenia≈Ç
  const existing = await getUserRating(movieId, me.id);
  if (existing) {
    // aktualizacja istniejƒÖcej oceny
    const { error } = await db
      .from("ratings")
      .update({ score })
      .eq("movie_id", movieId)
      .eq("user_id", me.id);
    if (error) {
      console.error(error);
      return toast("‚ùå B≈ÇƒÖd przy aktualizacji oceny.");
    }
    toast("‚úîÔ∏è Zmieniono TwojƒÖ ocenƒô!");
  } else {
    // nowa ocena
    const { error } = await db
      .from("ratings")
      .insert({ movie_id: movieId, user_id: me.id, score });
    if (error) {
      console.error(error);
      return toast("‚ùå B≈ÇƒÖd przy dodawaniu oceny.");
    }
    toast("‚úîÔ∏è Ocena dodana!");
  }

  // od≈õwie≈º tylko sekcjƒô ocen ‚Äî nie prze≈Çadowuj ca≈Çej strony
  const ratings = await getRatingsFor(movieId);
  const avg = ratings.length
    ? (ratings.reduce((a, b) => a + b.score, 0) / ratings.length).toFixed(1)
    : "-";
  const count = ratings.length;
  const youRated = await getUserRating(movieId, me.id);

  // zaktualizuj tekst na stronie bez reloadu
  const movieSection = document.querySelector("section.mt-4");
  if (movieSection) {
    movieSection.querySelector("div strong").textContent = avg;
    const sel = movieSection.querySelector("select[name='score']");
    if (sel) sel.value = youRated.score;
  }
},

  async comment(movieId, text){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    text = (text||"").trim(); if(!text) return;
    await addComment(movieId, me.id, text.slice(0,2000));
    UI.show('movie',{id:movieId});
  },
    async buyMovie(movieId, cost){
    const me = await Auth.currentProfile();
    if(!me) return UI.show("login");

    const have = await getPoints(me.id);
    if(have < cost){
      return toast("‚ùå Masz za ma≈Ço punkt√≥w");
    }

    // odejmij punkty
    await addPoints(me.id, -cost, `Zakup filmu #${movieId}`);

    // zapisz odblokowanie
    await ensureUnlocked(me.id, movieId);

    toast("‚úîÔ∏è Film odblokowany!");
    UI.show("movie", { id: movieId }); // od≈õwie≈º widok
  },


  async saveBio(username){
    const me = await Auth.currentProfile(); if(!me) return;
    await db.from("profiles").update({ username: String(username||"").slice(0,50) }).eq("id", me.id);
    toast("Zapisano ‚úîÔ∏è"); UI.show('me');
  },

  async earnAd(){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    await addPoints(me.id, 50, "Reklama (demo)");
    toast("Zdobyto 50 pkt");
    UI.show('me');
  },

  async redeem(code){
    const me = await Auth.currentProfile(); if(!me) return UI.show("login");
    const res = await redeemCode(me.id, code);
    toast(res.msg);
    UI.show('me');
  },

  async addMovie(form){
    const payload = {
      title: form.title.value.trim(),
      description: form.description.value.trim(),
      thumb: form.thumb.value.trim(),
      iframe: form.iframe.value.trim(),
      category_id: form.category_id.value ? Number(form.category_id.value) : null,
      year: form.year.value ? Number(form.year.value) : null,
      duration: form.duration.value ? Number(form.duration.value) : null,
      points_required: form.points_required.value ? Number(form.points_required.value) : 0,
      created_at: new Date().toISOString()
    };
    const { error } = await addMovie(payload);
    if(error){ alert("‚ùå " + error.message); return; }
    toast("Film dodany ‚úîÔ∏è");
    UI.show('admin');
  },

  slug: form.title.value
  .toLowerCase()
  .replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/g, c => ({
    ƒÖ:"a",ƒá:"c",ƒô:"e",≈Ç:"l",≈Ñ:"n",√≥:"o",≈õ:"s",≈∫:"z",≈º:"z"
  }[c]))
  .replace(/[^a-z0-9]+/g,"-")
  .replace(/(^-|-$)/g,"")

  async deleteMovie(id){
    const { error } = await deleteMovie(id);
    if(error){ alert("‚ùå " + error.message); return; }
    UI.show('admin');
  },

  async addCategory(name){
    name = (name||"").trim(); if(!name) return;
    const { error } = await addCategory(name);
    if(error) alert("‚ùå " + error.message);
    UI.show('admin');
  },

  async delCategory(id){
    const { error } = await delCategory(id);
    if(error) alert("‚ùå " + error.message);
    UI.show('admin');
  }
};

// Start
UI.updateHeader();
UI.search('', { sort: 'new' });
</script>

<!-- =========== Router hash: otwieranie filmu po #hash =========== -->
<script>
/*
  Obs≈Çuga hash-a:
  - po wej≈õciu na filmy.html#slug lub zmianie hash -> spr√≥buj znale≈∫ƒá film po wygenerowanym 'slug' z tytu≈Çu
  - je≈õli znajdzie, otw√≥rz UI.show('movie', {id})
*/
function makeSlug(str){
  return (str||"").toLowerCase()
    .replace(/[ƒÖƒáƒô≈Ç≈Ñ√≥≈õ≈∫≈º]/g, c => ({ "ƒÖ":"a","ƒá":"c","ƒô":"e","≈Ç":"l","≈Ñ":"n","√≥":"o","≈õ":"s","≈∫":"z","≈º":"z" }[c]||c))
    .replace(/[^a-z0-9\-]+/g,"-")
    .replace(/\-+/g,"-")
    .replace(/^\-|\-$/g,"");
}

async function handleHash(){
  const hash = (window.location.hash||"").replace("#","");
  if(!hash){
    // je≈õli nie ma hasha, poka≈º home (ale nie wymuszaj je≈ºeli ju≈º jeste≈õmy np. w innym widoku)
    // UI.show('home');
    return;
  }
  try{
    const movies = await getMovies();
    const movie = movies.find(m => makeSlug(m.title) === hash);
    if(movie){
      UI.show('movie', { id: movie.id });
      // scroll to top for nicer UX
      window.scrollTo(0,0);
    } else {
      // nie znaleziono - zostaw stronƒô jak jest albo poka≈º home
      // UI.show('home');
      console.warn("Hash nie pasuje do ≈ºadnego filmu:", hash);
    }
  }catch(e){
    console.error(e);
  }
}
window.addEventListener("hashchange", handleHash);
window.addEventListener("DOMContentLoaded", handleHash);

/* =========================
   AI ASSISTANT (FRONT-END)
   ========================= */
const AIAssistant = {
    chatBody: document.getElementById('chat-body-ai'),
    userInput: document.getElementById('user-input-ai'),
    sendButton: document.getElementById('send-button-ai'),
    
    init(){
        document.getElementById('ai-chat-button').addEventListener('click', this.toggleChat.bind(this));
        document.getElementById('close-button-ai').addEventListener('click', this.toggleChat.bind(this));
        this.sendButton.addEventListener('click', this.handleSend.bind(this));
        this.userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.handleSend(); });
        this.userInput.addEventListener('input', () => { this.sendButton.disabled = this.userInput.value.trim() === ''; });
    },

    toggleChat(){
        const windowEl = document.getElementById('ai-chat-window');
        const buttonEl = document.getElementById('ai-chat-button');
        const isHidden = windowEl.classList.toggle('hidden');
        buttonEl.classList.toggle('hidden', !isHidden);
        
        if (!isHidden) {
            // Je≈õli otwieramy, przewi≈Ñ na d√≥≈Ç i za≈Çaduj dane film√≥w (tylko raz po otwarciu)
            this.scrollToBottom();
            this.sendButton.disabled = this.userInput.value.trim() === '';
            // Logika ≈Çadowania danych film√≥w, kt√≥ra jest kluczowa dla AI
            this.loadMovieData();
        }
    },

    scrollToBottom(){
        this.chatBody.scrollTop = this.chatBody.scrollHeight;
    },

    displayMessage(text, sender = 'ai'){
        const msgDiv = document.createElement('div');
        msgDiv.textContent = text;
        msgDiv.classList.add('message-ai', sender === 'user' ? 'user-message-ai' : 'ai-message-ai');
        this.chatBody.appendChild(msgDiv);
        this.scrollToBottom();
    },

    // 1. KROK: Zbieranie danych dla AI
    async loadMovieData(){
        try {
            // U≈ºywamy istniejƒÖcej w Twoim kodzie funkcji do pobrania wszystkich film√≥w
            const movies = await getMovies({}); 
            
            // Formatowanie danych, aby by≈Çy zwiƒôz≈Çe i u≈ºyteczne dla modelu AI
            // Pamiƒôtaj: nie wysy≈Çaj wszystkich 1000 film√≥w do API Gemini za ka≈ºdym razem!
            // To jest tylko demo, w rzeczywisto≈õci powiniene≈õ u≈ºyƒá filtr√≥w/wyszukiwania na serwerze.
            const movieInfo = movies.map(m => {
                // Ta funkcja jest kluczowa: musisz obliczyƒá ratingi. 
                // W tym demo nie mamy synchronicznej funkcji do avgRating, wiƒôc dodajmy 'Dummy Rating'
                const avgRating = (m.id % 2 === 0) ? "7.5" : "8.2"; // TODO: ZastƒÖpiƒá prawdziwƒÖ logikƒÖ na backendzie!
                
                return {
                    id: m.id,
                    title: m.title,
                    description: m.description ? m.description.slice(0, 100) + '...' : 'Brak opisu', // Skracamy opis
                    year: m.year,
                    duration: m.duration,
                    points: m.points_required,
                    rating_dummy: avgRating // W prawdziwym projekcie musisz tu mieƒá rzeczywistƒÖ ≈õredniƒÖ
                };
            }).slice(0, 50); // Ograniczamy do 50, aby nie prze≈Çadowaƒá modelu

            // Zapisujemy dane film√≥w do p√≥≈∫niejszego u≈ºycia
            this.movieListForAI = movieInfo;
            console.log("Dane film√≥w gotowe dla AI:", movieInfo); 
        } catch(e) {
            console.error("B≈ÇƒÖd ≈Çadowania danych film√≥w dla AI:", e);
            this.displayMessage("WystƒÖpi≈Ç b≈ÇƒÖd przy ≈Çadowaniu informacji o filmach. Spr√≥buj p√≥≈∫niej.", 'ai');
        }
    },

    // 2. KROK: Obs≈Çuga wys≈Çania zapytania
    async handleSend(){
        const userText = this.userInput.value.trim();
        if (!userText) return;

        this.displayMessage(userText, 'user');
        this.userInput.value = '';
        this.sendButton.disabled = true;

        // Tymczasowa wiadomo≈õƒá o oczekiwaniu
        this.displayMessage("Szukam idealnego filmu... Proszƒô czekaƒá.", 'ai');

        // --- 3. KROK: MIEJSCE NA INTEGRACJƒò Z GEMINI API (Backend) ---
        // W REALNYM PROJEKCIE: 
        // 1. Wys≈Çanie userText i this.movieListForAI do Twojego Backendu.
        // 2. Backend u≈ºywa Gemini do wygenerowania rekomendacji.
        // 3. Backend odsy≈Ça sformatowanƒÖ odpowied≈∫.

        // Poni≈ºej jest tylko symulacja odpowiedzi, poniewa≈º integracja z Gemini wymaga serwera.
        const simulatedResponse = await this.simulateGeminiResponse(userText);
        
        // Usuniƒôcie wiadomo≈õci oczekiwania i wy≈õwietlenie odpowiedzi
        this.chatBody.lastChild.remove(); 
        this.displayMessage(simulatedResponse, 'ai');
        this.sendButton.disabled = false;
    },

    async simulateGeminiResponse(userText){
        await delay(1500); // Symulacja czasu odpowiedzi
        
        const lowText = userText.toLowerCase();
        
        if (lowText.includes("akcja") || lowText.includes("szybki") || lowText.includes("wybuchy")) {
            // Symulacja, ≈ºe AI wybra≈Ço film z listy
            const rec = this.movieListForAI[Math.floor(Math.random() * this.movieListForAI.length)];
            if (!rec) return "Przepraszam, nie znalaz≈Çem ≈ºadnych film√≥w w bazie, kt√≥re spe≈Çnia≈Çyby Twoje kryteria.";
            
            // Linkowanie do filmu
            const movieSlug = rec.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            const link = `<a href="#${movieSlug}" onclick="UI.show('movie',{id:${rec.id}}); document.getElementById('ai-chat-window').classList.add('hidden');"><b>${rec.title}</b></a>`;

            return `Na podstawie Twoich preferencji (szybka akcja) polecam film ${link}. 
                    Rok: ${rec.year}, D≈Çugo≈õƒá: ${rec.duration} min. Opis: ${rec.description}. 
                    Co sƒÖdzisz o tytule, czy szukamy czego≈õ innego?`;
        }

        if (lowText.includes("horror") || lowText.includes("straszne")) {
             return "Rozumiem! Straszne filmy to ≈õwietny wyb√≥r! Niestety, moja baza danych obecnie nie zawiera wystarczajƒÖco du≈ºo szczeg√≥≈Çowych danych o gatunkach, ale mogƒô poszukaƒá najnowszych, je≈õli chcesz. Co≈õ nowszego, czy mo≈ºe klasyka?";
        }
        
        return `Przepraszam, jestem jeszcze prostym asystentem. Nie mam jeszcze pe≈Çnej mocy AI. Je≈õli szukasz filmu, spr√≥buj u≈ºyƒá s≈Ç√≥w kluczowych jak "akcja", "d≈Çugi" lub "stary".`;
    }
};

AIAssistant.init();
</script>
</body>
</html>
