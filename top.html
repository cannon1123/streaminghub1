<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TOP ‚Ä¢ StreamingHub</title>
<style>
:root {
  --bg:#0b0d10; 
  --card:#151922; 
  --text:#e3e7ee; 
  --muted:#a8bfe2;
  --brand:#4f7cff; 
  --border:#232a37; 
  --danger:#c24b4b;
}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:ui-sans-serif,system-ui;
}
.container{
  max-width:1100px;
  margin:auto;
  padding:16px;
}
header{
  position:sticky;
  top:0;
  background:rgba(11,13,16,.85);
  backdrop-filter:blur(6px);
  z-index:20;
}
.nav{
  display:flex;
  gap:12px;
  align-items:center;
  padding:12px 16px;
}
.menu a,.menu button{
  color:var(--muted);
  padding:8px 10px;
  background:none;
  border:none;
  cursor:pointer;
}
.menu a.active{
  color:#fff;
}
.item{
  background:#0e1218;
  border:1px solid var(--border);
  padding:12px;
  border-radius:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:10px;
}
.rank{
  font-size:18px;
  font-weight:700;
  margin-right:10px;
  color:var(--brand);
}
.username{
  font-weight:600;
}
.btn{
  background:var(--brand);
  padding:6px 10px;
  border-radius:8px;
  border:none;
  color:#fff;
  cursor:pointer;
}
.btn.secondary{
  background:#2a3446;
}
.toggle-box{
  margin-top:15px;
  padding:10px;
  border:1px solid var(--border);
  border-radius:10px;
  background:#0e1218;
}
.event-box{
  margin-top:20px;
  padding:15px;
  border-radius:10px;
  background:#11151c;
  border:1px solid var(--border);
}
.event-title{
  font-size:20px;
  font-weight:700;
}
.countdown{
  color:var(--brand);
  margin-top:5px;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="filmy.html">üé¨ StreamingHub</a>
    <nav class="menu" style="margin-left:auto">
      <a href="filmy.html">Filmy</a>
      <a href="seriale.html">Seriale</a>
      <a href="top.html" class="active">TOP</a>
      <a href="moja-biblioteka.html">Moja biblioteka</a>
      <button onclick="logout()" class="btn secondary">Wyloguj</button>
    </nav>
  </div>
</header>

<main class="container" id="app">
<h1>üèÜ TOP u≈ºytkownik√≥w</h1>

<!-- EVENT -->
<div id="eventBox" class="event-box">
  <div class="event-title">‚è≥ Obecny event</div>
  <div id="eventContent">≈Åadowanie...</div>
  <div id="countdown" class="countdown"></div>
</div>

<!-- HIDE FROM TOP -->
<div class="toggle-box">
  <label>
    <input type="checkbox" id="hideToggle" onchange="toggleHide()">
    Nie pokazuj mnie w rankingach
  </label>
</div>

<!-- TABS -->
<div id="tabs" style="margin-top:20px;">
  <button class="btn" onclick="showTab('unlocks')">üîì Odblokowane filmy</button>
  <button class="btn" onclick="showTab('episodes')">üì∫ Obejrzane odcinki</button>
  <button class="btn" onclick="showTab('points')">üí∞ Punkty</button>
  <button class="btn" onclick="showTab('friends')">üë• Znajomi</button>
  <button class="btn" onclick="showTab('visits')">üëÅ Odwiedziny stron</button>
</div>

<div id="content"></div>
</main>

<script>
/* ---------------------- SUPABASE ---------------------- */
const db = supabase.createClient(
  "https://jjmnacolebxsifmnmqks.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0"
);

let user = null;

(async () => {
  const { data:{ session }} = await db.auth.getSession();
  if(!session){ location.href="login.html"; return; }
  user = session.user;

  await loadHideToggle();
  await loadEvent();

  showTab('unlocks');
})();

async function logout(){
  await db.auth.signOut();
  location.href="login.html";
}

/* ---------------------- HIDE FROM TOP ---------------------- */
async function loadHideToggle(){
  const { data } = await db
    .from("profiles")
    .select("hide_from_top")
    .eq("id", user.id)
    .maybeSingle();

  document.getElementById("hideToggle").checked = data?.hide_from_top || false;
}

async function toggleHide(){
  const value = document.getElementById("hideToggle").checked;
  await db
    .from("profiles")
    .update({ hide_from_top: value })
    .eq("id", user.id);
}

/* ---------------------- EVENT SYSTEM ---------------------- */
async function loadEvent(){
  const { data } = await db
    .from("events")
    .select("*")
    .order("id",{ascending:false})
    .limit(1);

  const box = document.getElementById("eventContent");
  const timer = document.getElementById("countdown");

  if(!data || data.length===0){
    box.innerHTML = "<p>Brak aktywnego eventu.</p>";
    return;
  }

  const ev = data[0];

  box.innerHTML = `
    <b>Nazwa:</b> ${ev.name}<br>
    <b>Opis:</b> ${ev.description}<br>
    <b>Nagroda:</b> ${ev.reward}<br>
    <b>Kategoria topki:</b> ${ev.category}
  `;

  const endTime = new Date(ev.ends_at).getTime();
  
  function updateTimer(){
    const now = Date.now();
    const diff = endTime - now;
    if(diff <= 0){
      timer.innerHTML = "‚õî Event zako≈Ñczony!";
      return;
    }

    const d = Math.floor(diff / (1000 * 60 * 60 * 24));
    const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
    const m = Math.floor((diff / (1000 * 60)) % 60);
    const s = Math.floor((diff / 1000) % 60);

    timer.innerHTML = `‚è∞ Do ko≈Ñca: ${d}d ${h}h ${m}m ${s}s`;
  }

  updateTimer();
  setInterval(updateTimer,1000);
}

/* ---------------------- SHOW TAB ---------------------- */
async function showTab(tab){
  document.getElementById("content").innerHTML = "<p>≈Åadowanie...</p>";

  if(tab==="unlocks") loadUnlocks();
  if(tab==="episodes") loadEpisodes();
  if(tab==="points") loadPoints();
  if(tab==="friends") loadFriends();
  if(tab==="visits") loadVisits();
}

/* ---------------------- RANKINGS ---------------------- */
async function loadUnlocks(){
  const { data } = await db
    .from("unlocks")
    .select("user_id, profiles:profiles(id, username, hide_from_top)")
    .eq("profiles.hide_from_top",false);

  const counts = {};
  for(const r of data){
    counts[r.user_id] = (counts[r.user_id]||0) + 1;
  }

  const sorted = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,50);

  render(sorted, r => `${r[1]} odblokowanych`);
}

async function loadEpisodes(){
  const { data } = await db
    .from("watch_history")
    .select("user_id, episode_id, profiles:profiles(id, username, hide_from_top)")
    .not("episode_id","is",null)
    .eq("profiles.hide_from_top",false);

  const counts = {};
  for(const r of data){
    counts[r.user_id] = (counts[r.user_id]||0) + 1;
  }

  const sorted = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,50);

  render(sorted, r => `${r[1]} odcink√≥w`);
}

async function loadPoints(){
  const { data } = await db
    .from("profiles")
    .select("id, username, points, hide_from_top")
    .eq("hide_from_top",false)
    .order("points",{ascending:false})
    .limit(50);

  const arr = data.map(d => [d.id, d.points, d.username]);

  renderFixed(arr, r => `${r[1]} pkt`, r => r[2]);
}

async function loadFriends(){
  const { data } = await db
    .from("friends")
    .select("user_id, profiles:profiles(id, username, hide_from_top)")
    .eq("profiles.hide_from_top",false);

  const counts = {};
  for(const r of data){
    counts[r.user_id] = (counts[r.user_id]||0) + 1;
  }

  const sorted = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,50);

  render(sorted, r => `${r[1]} znajomych`);
}

async function loadVisits(){
  const { data } = await db
    .from("page_visits")
    .select("user_id, profiles:profiles(id, username, hide_from_top)")
    .eq("profiles.hide_from_top",false);

  const counts = {};
  for(const r of data){
    counts[r.user_id] = (counts[r.user_id]||0) + 1;
  }

  const sorted = Object.entries(counts)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,50);

  render(sorted, r => `${r[1]} odwiedzin`);
}

/* ---------------------- RENDERING ---------------------- */
async function render(list, label){
  const { data: profiles } = await db
    .from("profiles")
    .select("id, username");

  const map = new Map(profiles.map(p => [p.id, p.username]));

  let html = "";
  let rank = 1;

  for(const [uid,count] of list){
    html += `
      <div class="item">
        <div>
          <span class="rank">#${rank}</span>
          <span class="username">${map.get(uid)}</span>
        </div>
        <div>${label([uid,count])}</div>
      </div>
    `;
    rank++;
  }

  document.getElementById("content").innerHTML =
    html || "<p>Brak danych</p>";
}

async function renderFixed(list, label, userNameGetter){
  let html = "";
  let rank = 1;

  for(const row of list){
    html += `
      <div class="item">
        <div>
          <span class="rank">#${rank}</span>
          <span class="username">${userNameGetter(row)}</span>
        </div>
        <div>${label(row)}</div>
      </div>
    `;
    rank++;
  }

  document.getElementById("content").innerHTML =
    html || "<p>Brak danych</p>";
}
</script>

</body>
</html>
