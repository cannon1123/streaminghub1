<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamingHub ‚Ä¢ Logowanie</title>
  <style>
    :root {
      --bg: #0b0d10;
      --card: #151922;
      --muted: #9fb1d9;
      --text: #e3e7ee;
      --brand: #4f7cff;
      --border: #232a37;
      --google-bg: #ffffff;
      --google-text: #1f1f1f;
    }
    body {
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui, sans-serif;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    header {
      position:sticky;
      top:0;
      background:rgba(11,13,16,0.85);
      backdrop-filter:blur(6px);
      z-index:10;
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .nav {
      display:flex;
      align-items:center;
      justify-content:space-between;
      max-width:1200px;
      margin:0 auto;
      padding:12px 16px;
    }
    .brand { font-weight:700; color:var(--text); text-decoration:none; display:flex; align-items:center; gap:8px; }
    .menu { display:flex; align-items:center; gap:18px; }
    .menu a { color:var(--muted); text-decoration:none; font-size:0.95rem; transition:color .2s; }
    .menu a:hover { color:#fff; }

    main {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:40px 16px;
    }

    .auth-box {
      background:var(--card);
      padding:30px 40px;
      border-radius:16px;
      width:100%;
      max-width:400px;
      box-shadow:0 0 25px rgba(0,0,0,.4);
    }
    h2 { text-align:center; margin-bottom:25px; margin-top: 0; }
    label { display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px; }
    input {
      width:100%; background:#0e1218; border:1px solid var(--border);
      color:#fff; padding:10px 12px; border-radius:10px; margin-bottom:14px;
      box-sizing: border-box;
    }
    button {
      width:100%; background:var(--brand); color:#fff; border:none;
      padding:10px 16px; border-radius:12px; cursor:pointer;
      font-weight:600; margin-top:4px; transition:background .2s;
    }
    button:hover { background:#668cff; }

    /* Google Button */
    .btn-google {
      background: var(--google-bg); color: var(--google-text);
      display: flex; align-items: center; justify-content: center; gap: 10px;
      margin-bottom: 15px; border: none;
    }
    .btn-google:hover { background: #f0f0f0; }
    .btn-google svg { width: 20px; height: 20px; }

    /* Separator */
    .separator {
      display: flex; align-items: center; text-align: center;
      color: var(--muted); font-size: 0.85rem; margin: 15px 0;
    }
    .separator::before, .separator::after {
      content: ''; flex: 1; border-bottom: 1px solid var(--border);
    }
    .separator::before { margin-right: 10px; }
    .separator::after { margin-left: 10px; }

    .switch, small.link { text-align:center; margin-top:10px; color:var(--muted); cursor:pointer; font-size:.9rem; display:block; }
    .switch:hover, small.link:hover { color:#fff; text-decoration:underline; }
    .captcha {
      display:flex; align-items:center; justify-content:space-between;
      background:#0e1218; padding:8px 12px; border:1px solid var(--border);
      border-radius:10px; margin-bottom:12px; user-select:none;
    }
    .captcha span { font-family:monospace; font-size:1rem; letter-spacing:2px; font-weight: bold; }

    footer {
      text-align:center;
      padding:20px 0;
      color:var(--muted);
      font-size:0.9rem;
    }

    /* MOBILE RESPONSYWNO≈öƒÜ */
    @media (max-width: 900px) {
      .nav { flex-direction: column; gap: 10px; }
      .menu { flex-wrap: wrap; justify-content: center; }
      .auth-box { padding: 24px; }
    }
    @media (max-width: 600px) {
      h2 { font-size: 1.3rem; }
      input, button { font-size: 14px; padding: 9px 12px; }
      .auth-box { max-width: 90%; padding: 22px; }
    }
    @media (max-width: 400px) {
      .nav { padding: 8px; }
      .menu a { font-size: 13px; }
      .auth-box { padding: 18px; }
      footer { font-size: 12px; }
    }
  </style>
</head>
<body>

<header>
  <div class="nav">
    <a class="brand" href="index.html">üé¨ StreamingHub</a>
    <nav class="menu">
      <a href="/filmy/">Filmy</a>
      <a href="/seriale/">Seriale</a>
      <a href="index.html#me">Moja biblioteka</a>
      <a href="/login/" style="color:#fff;">Logowanie</a>
      <a href="#" onclick="showRegister()">Rejestracja</a>
    </nav>
  </div>
</header>

<main>
  <div class="auth-box" id="authBox">
    <h2 id="formTitle">Zaloguj siƒô</h2>

    <div id="googleSection">
      <button class="btn-google" onclick="loginWithGoogle()">
        <svg viewBox="0 0 48 48">
          <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
          <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path>
          <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path>
          <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
        </svg>
        Kontynuuj przez Google
      </button>
      <div class="separator">lub kontynuuj emailem</div>
    </div>

    <div id="loginForm">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="tw√≥j@email.com" />
      <label>Has≈Ço</label>
      <input type="password" id="loginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button onclick="login()">Zaloguj siƒô</button>
      <small class="link" onclick="showReset()">Zapomnia≈Çe≈õ has≈Ça?</small>
      <small class="link" onclick="showRegister()">Nie masz konta? Zarejestruj siƒô</small>
      <small class="link" onclick="sendMagicLink()">Zaloguj siƒô magicznym linkiem ‚ú®</small>
    </div>

    <div id="registerForm" style="display:none;">
      <label>Nazwa u≈ºytkownika</label>
      <input type="text" id="regName" placeholder="np. Janek123" />
      <label>Email</label>
      <input type="email" id="regEmail" placeholder="tw√≥j@email.com" />
      <label>Has≈Ço</label>
      <input type="password" id="regPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <label>Powt√≥rz has≈Ço</label>
      <input type="password" id="regPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <div class="captcha">
        <span id="captchaText"></span>
        <input type="text" id="captchaInput" placeholder="Przepisz" style="width:100px;">
      </div>
      <button onclick="register()">Utw√≥rz konto</button>
      <small class="link" onclick="showLogin()">Masz ju≈º konto? Zaloguj siƒô</small>
    </div>

    <div id="resetForm" style="display:none;">
      <label>Podaj email</label>
      <input type="email" id="resetEmail" placeholder="tw√≥j@email.com" />
      <button onclick="resetPassword()">Wy≈õlij link do resetu</button>
      <small class="link" onclick="showLogin()">Wr√≥ƒá do logowania</small>
    </div>

    <div id="newPassForm" style="display:none;">
      <label>Nowe has≈Ço</label>
      <input type="password" id="newPass1" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <label>Powt√≥rz has≈Ço</label>
      <input type="password" id="newPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
      <button onclick="updatePassword()">Zmie≈Ñ has≈Ço</button>
    </div>
  </div>
</main>

<footer>¬© <script>document.write(new Date().getFullYear())</script> StreamingHub</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// KONFIGURACJA
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Pobiera aktualny adres (dzia≈Ça na localhost i na domenie)
const redirectUrl = window.location.origin + window.location.pathname;

/* -------------------------------------------------------------------------- */
/* G≈Å√ìWNA LOGIKA SESJI                             */
/* -------------------------------------------------------------------------- */

// To jest serce naprawy. Nas≈Çuchujemy zmian stanu, zamiast zgadywaƒá z URL.
db.auth.onAuthStateChange(async (event, session) => {
  console.log("Supabase Auth Event:", event);

  if (event === 'PASSWORD_RECOVERY') {
    // 1. Wykryto klikniƒôcie w "Reset Has≈Ça" w mailu
    hideAll();
    document.getElementById("formTitle").innerText = "Ustaw nowe has≈Ço";
    document.getElementById("newPassForm").style.display = "block";
    document.getElementById("googleSection").style.display = "none";
  } 
  else if (event === 'SIGNED_IN') {
    // 2. Wykryto zalogowanie (Google, Email, Magic Link)
    // Sprawdzamy, czy to nie jest sesja odzyskiwania has≈Ça (≈ºeby nie przekierowaƒá za szybko)
    const isRecovery = window.location.hash && window.location.hash.includes("type=recovery");
    
    if (!isRecovery) {
       // Pomy≈õlne logowanie -> Przekieruj do film√≥w
       window.location.href = "/filmy/";
    }
  }
});

/* -------------------------------------------------------------------------- */
/* FUNKCJE FORMULARZY                           */
/* -------------------------------------------------------------------------- */

/* Logowanie Google */
async function loginWithGoogle() {
  const { error } = await db.auth.signInWithOAuth({
    provider: 'google',
    options: { redirectTo: redirectUrl }
  });
  if(error) alert("B≈ÇƒÖd Google: " + error.message);
}

/* Rejestracja */
async function register(){
  const name = document.getElementById("regName").value.trim();
  const email = document.getElementById("regEmail").value.trim();
  const pass = document.getElementById("regPass").value;
  const captcha = document.getElementById("captchaInput").value.trim().toUpperCase();
  const correct = document.getElementById("captchaText").dataset.value;

  if(!name || !email || !pass){ alert("Uzupe≈Çnij pola!"); return; }
  if(captcha !== correct){ alert("Captcha niepoprawna!"); generateCaptcha(); return; }

  const { error } = await db.auth.signUp({
    email,
    password: pass,
    options: {
      data: { username: name },
      emailRedirectTo: redirectUrl // Wa≈ºne dla linku potwierdzajƒÖcego
    }
  });
  
  if(error) alert("B≈ÇƒÖd: " + error.message);
  else {
    alert("‚úÖ E-mail wys≈Çany! Sprawd≈∫ folder SPAM, je≈õli nie widzisz wiadomo≈õci.");
    showLogin();
  }
}

/* Logowanie E-mail */
async function login(){
  const email = document.getElementById("loginEmail").value.trim();
  const pass = document.getElementById("loginPass").value;
  
  const { error } = await db.auth.signInWithPassword({ email, password: pass });
  if(error) alert("B≈ÇƒÖd: " + error.message);
  // Przekierowanie obs≈Çu≈ºy onAuthStateChange powy≈ºej
}

/* Magic Link */
async function sendMagicLink(){
  const email = prompt("Podaj email dla magicznego linku:");
  if(!email) return;
  
  const { error } = await db.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: redirectUrl }
  });
  
  if(error) alert("B≈ÇƒÖd: " + error.message);
  else alert("‚ú® Magic Link wys≈Çany! Sprawd≈∫ pocztƒô (i Spam).");
}

/* Reset Has≈Ça - wys≈Çanie maila */
async function resetPassword(){
  const email = document.getElementById("resetEmail").value.trim();
  if(!email) return alert("Podaj email");

  const { error } = await db.auth.resetPasswordForEmail(email, {
    redirectTo: redirectUrl
  });

  if(error) {
    if(error.status === 429) alert("Za du≈ºo pr√≥b! Odczekaj chwilƒô (Supabase Limit).");
    else alert("B≈ÇƒÖd: " + error.message);
  } else {
    alert("üîó Link do resetu wys≈Çany! Sprawd≈∫ Spam.");
    showLogin();
  }
}

/* Aktualizacja Has≈Ça (po klikniƒôciu w link resetujƒÖcy) */
async function updatePassword(){
  const p1 = document.getElementById("newPass1").value;
  if(!p1) return alert("Wpisz has≈Ço");
  
  const { error } = await db.auth.updateUser({ password: p1 });
  
  if(error) alert("B≈ÇƒÖd: " + error.message);
  else {
    alert("Has≈Ço zmienione pomy≈õlnie! ‚úÖ");
    window.location.href = "/filmy/"; // Teraz mo≈ºna bezpiecznie przekierowaƒá
  }
}

/* -------------------------------------------------------------------------- */
/* UI & NARZƒòDZIA                               */
/* -------------------------------------------------------------------------- */

function showLogin(){ hideAll(); document.getElementById("formTitle").innerText="Zaloguj siƒô"; document.getElementById("loginForm").style.display="block"; document.getElementById("googleSection").style.display="block"; }
function showRegister(){ hideAll(); generateCaptcha(); document.getElementById("formTitle").innerText="Rejestracja"; document.getElementById("registerForm").style.display="block"; document.getElementById("googleSection").style.display="block"; }
function showReset(){ hideAll(); document.getElementById("formTitle").innerText="Reset has≈Ça"; document.getElementById("resetForm").style.display="block"; }

function hideAll(){ 
  ["loginForm","registerForm","resetForm","newPassForm","googleSection"].forEach(id=> {
    const el = document.getElementById(id);
    if(el) el.style.display="none";
  }); 
}

function generateCaptcha(){
  const code = Math.random().toString(36).substring(2,8).toUpperCase();
  const el = document.getElementById("captchaText");
  if(el) { el.textContent = code; el.dataset.value = code; }
}

// Inicjalizacja przy starcie
generateCaptcha();

</script>
</body>
</html>
