<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>StreamingHub ‚Äî AI Chat</title>

<style>
    body {
        margin: 0;
        background-color: #0b0d10;
        font-family: Inter, sans-serif;
        color: #fff;
        overflow: hidden;
    }

    .chat-wrapper {
        width: 100%;
        height: 100vh;
        display: flex;
        justify-content: center;
        padding-top: 20px;
    }

    .chat-container {
        width: 95%;
        max-width: 820px;
        height: 88vh;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 18px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        backdrop-filter: blur(10px);
    }

    .chat-header {
        padding: 18px;
        font-size: 20px;
        font-weight: 700;
        background: rgba(255,255,255,0.04);
        border-bottom: 1px solid rgba(255,255,255,0.04);
    }

    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 18px;
        display: flex;
        flex-direction: column;
    }

    .bubble {
        max-width: 78%;
        margin-bottom: 14px;
        padding: 12px 16px;
        border-radius: 14px;
        line-height: 1.45;
        font-size: 15px;
        word-wrap: break-word;
    }

    .ai {
        background: #1a1d23;
        align-self: flex-start;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .user {
        background: #4f7cff;
        align-self: flex-end;
    }

    .input-area {
        padding: 14px;
        display: flex;
        gap: 10px;
        border-top: 1px solid rgba(255,255,255,0.05);
        background: rgba(255,255,255,0.02);
    }

    .input-area input {
        flex: 1;
        padding: 12px 15px;
        border-radius: 12px;
        border: 1px solid rgba(255,255,255,0.08);
        background: rgba(255,255,255,0.05);
        color: #fff;
        outline: none;
        font-size: 15px;
    }

    .input-area button {
        padding: 12px 18px;
        background: #4f7cff;
        border: none;
        border-radius: 12px;
        font-size: 15px;
        color: #fff;
        font-weight: 600;
        cursor: pointer;
    }

    .rec-box {
        display: flex;
        gap: 12px;
        background: rgba(255,255,255,0.04);
        padding: 10px;
        border-radius: 12px;
        margin-bottom: 8px;
        border: 1px solid rgba(255,255,255,0.05);
    }

    .rec-box img {
        width: 130px;
        height: 74px;
        object-fit: cover;
        border-radius: 10px;
    }

    .rec-meta {
        flex: 1;
    }

    .rec-title {
        font-size: 16px;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .rec-desc {
        font-size: 14px;
        opacity: 0.8;
    }

</style>
</head>

<body>

<div class="chat-wrapper">
    <div class="chat-container">
        
        <div class="chat-header">üé¨ StreamingHub ‚Äî Asystent Filmowy</div>

        <div class="messages" id="messages">
            <div class="bubble ai">
                Cze≈õƒá! üëã Jestem tu, aby pom√≥c Ci wybraƒá idealny film.  
                Odpowiadaj swobodnie, mo≈ºesz u≈ºyƒá "-" je≈õli czego≈õ nie wiesz.
            </div>
        </div>

        <div class="input-area">
            <input id="user-input" placeholder="Napisz wiadomo≈õƒá..." />
            <button id="send-btn">Wy≈õlij</button>
        </div>
    </div>
</div>

<script type="module">

/* ‚ñº‚ñº‚ñº UZUPE≈ÅNIASZ TYLKO TO ‚ñº‚ñº‚ñº */
const OPENAI_API_KEY = "";

const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGc...Tw√≥j klucz anon";
/* ‚ñ≤‚ñ≤‚ñ≤ NIC WIƒòCEJ NIE ZMIENIASZ ‚ñ≤‚ñ≤‚ñ≤ */


// --------------------- SUPABASE -------------------------
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


// --------------------- ELEMENTY -------------------------
const messages = document.getElementById("messages");
const input = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");

function addBubble(text, type="ai", html=false) {
    const div = document.createElement("div");
    div.className = "bubble " + type;
    div.innerHTML = html ? text : text.replace(/\n/g,"<br>");
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}


// --------------------- PYTANIA -------------------------
const QUESTIONS = [
    "Jaki gatunek preferujesz? (komedia, akcja, thriller...)",
    "Jaki nastr√≥j filmu Ci odpowiada? (lekki, mroczny...)",
    "Z jakich lat? (np. ostatnie 10 lat albo '-')",
    "Jak d≈Çuga mo≈ºe byƒá produkcja? (<90 min, d≈Çu≈ºsza, brak preferencji)",
    "Jakie s≈Çowa-klucze powinien zawieraƒá opis filmu?"
];

let qIndex = 0;
let prefs = {};

addBubble(QUESTIONS[0]);


// --------------------- OPENAI ‚Äî GPT-4o -------------------------
async function callOpenAI(messages) {
    const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${OPENAI_API_KEY}`
        },
        body: JSON.stringify({
            model: "gpt-4o",
            messages,
            temperature: 0.6
        })
    });

    const data = await res.json();
    return data.choices[0].message.content;
}


// --------------------- SUPABASE ‚Äî pobierz filmy -------------------------
async function loadMovies() {
    const { data } = await supabase
        .from("movies")
        .select("id,title,description,thumb,year,duration,category_id")
        .limit(200);

    const { data: cat } = await supabase
        .from("categories")
        .select("id,name");

    return data.map(m => ({
        ...m,
        category: cat.find(c => c.id === m.category_id)?.name || null
    }));
}


// --------------------- REKOMENDACJE -------------------------
async function generateRecommendations() {

    addBubble("Szukam najlepszych propozycji‚Ä¶ üé¨");

    const movies = await loadMovies();

    const context = movies
        .slice(0, 60)
        .map(m => `Tytu≈Ç: ${m.title} (${m.year})\nOpis: ${m.description}\nGatunek: ${m.category}\nD≈Çugo≈õƒá: ${m.duration} min`)
        .join("\n\n");

    const aiResponse = await callOpenAI([
        {
            role: "system",
            content: `
Jeste≈õ inteligentnym asystentem filmowym. 
Na podstawie preferencji u≈ºytkownika i listy film√≥w wybierasz TOP 5.
Dla ka≈ºdego filmu podaj:
‚Ä¢ tytu≈Ç
‚Ä¢ rok
‚Ä¢ kr√≥tki opis rekomendacji
‚Ä¢ kr√≥tki opis dlaczego pasuje
Zwr√≥ƒá odpowied≈∫ w czytelnym tek≈õcie.
Nic nie wymy≈õlaj ‚Äî korzystaj TYLKO z podanych film√≥w.`
        },
        {
            role: "user",
            content: `
Preferencje u≈ºytkownika:
${JSON.stringify(prefs, null, 2)}

Lista film√≥w:
${context}

Wygeneruj TOP 5 najlepiej dopasowanych film√≥w.`
        }
    ]);

    renderRecommendations(aiResponse, movies);
}


// --------------------- RENDER REKOMENDACJI -------------------------
function renderRecommendations(text, movies) {

    const blocks = text.split("\n\n").slice(0, 5);

    for (let b of blocks) {
        const titleMatch = b.match(/Tytu≈Ç:\s*(.+)/i);
        if (!titleMatch) continue;
        const title = titleMatch[1].trim();

        const movie = movies.find(m => m.title.toLowerCase() === title.toLowerCase());
        if (!movie) continue;

        const box = `
        <div class="rec-box">
            <img src="${movie.thumb || ""}">
            <div class="rec-meta">
                <div class="rec-title">${movie.title} (${movie.year})</div>
                <div class="rec-desc">${movie.description}</div>
            </div>
        </div>`;

        addBubble(box, "ai", true);
    }

    addBubble("Je≈õli to nie to, napisz czego brakuje a dobiorƒô lepiej!");
}


// --------------------- OBS≈ÅUGA WIADOMO≈öCI -------------------------
sendBtn.onclick = handleSend;
input.onkeypress = e => e.key === "Enter" && handleSend();

async function handleSend() {
    const msg = input.value.trim();
    if (!msg) return;

    addBubble(msg, "user");
    input.value = "";

    // zapisujemy odpowied≈∫
    prefs[qIndex] = msg;

    // przechodzimy dalej
    qIndex++;

    // je≈õli sko≈Ñczyli≈õmy pytania ‚Üí rekomendacje
    if (qIndex >= QUESTIONS.length) {
        generateRecommendations();
        return;
    }

    addBubble(QUESTIONS[qIndex]);
}

</script>

</body>
</html>
