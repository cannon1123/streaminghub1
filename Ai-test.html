<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Film Finder ‚Äî test</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#151922; --text:#e3e7ee; --muted:#a8bfe2; --brand:#4f7cff; --border:#232a37;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto;}
    .wrap{max-width:980px;margin:20px auto;padding:16px;}
    header{display:flex;align-items:center;gap:16px;margin-bottom:14px}
    .logo{font-size:20px;font-weight:800;color:var(--brand)}
    .lead{color:var(--muted);font-size:14px}
    .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 6px 30px rgba(0,0,0,0.5)}
    #chat{height:520px;overflow:auto;padding:12px;border-radius:10px;background:#0e1218;border:1px solid var(--border);display:flex;flex-direction:column;gap:12px}
    .msg{max-width:82%;padding:12px 16px;border-radius:12px;line-height:1.4;word-break:break-word}
    .ai{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;align-self:flex-start}
    .user{background:linear-gradient(135deg,#10b981,#059669);color:white;align-self:flex-end}
    .sys{background:transparent;border:1px dashed var(--border);color:var(--muted);align-self:center}
    .typing{font-size:13px;color:var(--muted);padding:8px}
    .controls{display:flex;gap:10px;margin-top:12px}
    input[type="text"]{flex:1;padding:12px;border-radius:10px;border:1px solid var(--border);background:#0e1218;color:var(--text)}
    button{padding:12px 18px;border-radius:10px;border:none;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .rec-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .rec{display:flex;gap:12px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);align-items:flex-start}
    .rec img{width:92px;height:56px;object-fit:cover;border-radius:6px}
    .rec .meta{flex:1}
    .rec .title{font-weight:700}
    .meta .desc{font-size:13px;color:var(--muted);margin-top:6px}
    .small{font-size:12px;color:var(--muted)}
    @media(max-width:640px){
      #chat{height:420px}
      .rec img{width:80px;height:50px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <div class="logo">üé¨ AI Film Finder</div>
        <div class="lead">Bot zadaje przyjemne pytania i wyszukuje filmy z Twojej bazy Supabase</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div class="small">Tryb testowy ‚Äî frontend u≈ºywa ANON KEY</div>
      </div>
    </header>

    <div class="card">
      <div id="chat" aria-live="polite">
        <div class="msg sys">≈Åadowanie... ≈ÇƒÖczenie z Supabase</div>
      </div>

      <div class="typing" id="typing" style="display:none">AI pisze...</div>

      <div class="controls">
        <input id="input" type="text" placeholder="Napisz odpowied≈∫ (u≈ºyj '-' je≈õli nie wiesz)" autocomplete="off" />
        <button id="send">Wy≈õlij</button>
      </div>
      <div style="margin-top:10px" class="small">Mo≈ºesz odpowiadaƒá kr√≥tkimi zdaniami lub pojedynczym wyrazem. Bot akceptuje "-" jako "nie wiem".</div>
    </div>
  </div>

  <script type="module">
    // =========================
    // Konfiguracja Supabase (wklejone z Twojego inputu)
    // =========================
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: false } });

    // =========================
    // UI refs
    // =========================
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const send = document.getElementById('send');
    const typing = document.getElementById('typing');

    // =========================
    // Stan konwersacji (frontend-only)
    // conversationHistory = [{role:'assistant'|'user', content:''}, ...]
    // preferences: zbierane pola
    // =========================
    let conversationHistory = [];
    let preferences = { category: null, mood: null, yearFrom: null, yearTo: null, durationMax: null, keywords: [] };
    let categoriesMap = {}; // name -> id (pobrane z supabase)
    let awaiting = false;

    // Helper: dodaj wiadomo≈õƒá
    function addMessage(text, who='ai', html=false){
      const d = document.createElement('div');
      d.className = 'msg ' + (who==='ai'?'ai': who==='user'?'user':'sys');
      d.innerHTML = html ? text : escapeHtml(text);
      chat.appendChild(d);
      chat.scrollTop = chat.scrollHeight;
    }
    function escapeHtml(t){ return String(t).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
    function setTyping(v){ typing.style.display = v ? 'block' : 'none'; }

    // =========================
    // Inicjalizacja: pobierz mapƒô kategorii (name->id) i rozpocznij dialog
    // =========================
    async function init(){
      addMessage('≈ÅƒÖczƒô siƒô z bazƒÖ i ≈Çadujƒô kategorie...', 'sys');
      try {
        const { data, error } = await supabase.from('categories').select('id,name');
        if (error) throw error;
        (data||[]).forEach(c => categoriesMap[c.name.toLowerCase()] = c.id);
        chat.innerHTML = ''; // wyczy≈õƒá loading
        startConversation();
      } catch (err) {
        chat.innerHTML = '';
        addMessage('B≈ÇƒÖd po≈ÇƒÖczenia z Supabase: ' + (err.message || err), 'sys');
        console.error(err);
      }
    }

    // =========================
    // Sekwencja pyta≈Ñ AI (logika lokalna)
    // - proste przyjemne pytania
    // - akceptuje "-" jako "nie wiem"
    // - gdy wystarczajƒÖ prefy -> wyszukaj rekomendacje
    // =========================
    const QUESTIONS = [
      'Cze≈õƒá! üòä Jakiego rodzaju film√≥w szukasz? (np. "komedia", "thriller", "romans" lub "-")',
      'Jaki nastr√≥j preferujesz? (np. "lekki", "mroczny", "romantyczny" lub "-")',
      'Masz preferencjƒô co do roku produkcji? (np. "ostatnie 10 lat", "lata 90-te", rok "2010" lub "-")',
      'Wolisz kr√≥tsze filmy (~<90 min) czy d≈Çu≈ºsze (>120 min)? (albo "-" je≈õli nie wiesz)',
      'Podaj kilka s≈Ç√≥w kluczowych, kt√≥re chcia≈Çby≈õ zobaczyƒá w opisie (np. "podr√≥≈º", "kosmos", "mafia") lub "-" je≈õli brak.'
    ];

    let questionIndex = 0;

    function startConversation(){
      conversationHistory = [];
      preferences = { category: null, mood: null, yearFrom: null, yearTo: null, durationMax: null, keywords: [] };
      questionIndex = 0;
      addMessage(QUESTIONS[questionIndex], 'ai');
      awaiting = true;
      input.disabled = false; input.focus();
    }

    // =========================
    // Parsowanie prostych odpowiedzi do preferences
    // =========================
    function interpretAnswer(ans){
      const a = (ans||'').trim();
      if (!a || a === '-') return { consumed: false }; // nie-dostarczone info
      const low = a.toLowerCase();

      // 1) category
      // sprawd≈∫ czy w odpowiedzi jest jaka≈õ znana kategoria (mapa kategorii + lista podstawowych)
      const basicCats = ['komedia','thriller','dramat','akcja','fantasy','sci-fi','scifi','science fiction','romans','horror','animacja','dokument','dokumentalny'];
      for (const c of basicCats){
        if (low.includes(c)) {
          return { consumed:true, field:'category', value: c.includes('scifi')||c.includes('science') ? 'sci-fi' : c.replace('science fiction','sci-fi') };
        }
      }

      // 2) mood
      if (low.includes('luz') || low.includes('lekki') || low.includes('relax') || low.includes('lekka')) return { consumed:true, field:'mood', value:'light' };
      if (low.includes('mrocz') || low.includes('ciƒô≈º') || low.includes('powa≈º') || low.includes('dark')) return { consumed:true, field:'mood', value:'dark' };
      if (low.includes('romant')) return { consumed:true, field:'mood', value:'romantic' };

      // 3) year
      // obs≈Çu≈º 'ostatnie X lat', 'lata 90', '1999', '2000-2010'
      const years = [...low.matchAll(/(19|20)\d{2}/g)].map(m=>parseInt(m[0]));
      if (years.length===1) return { consumed:true, field:'yearFrom', value: years[0], extra:{yearTo:years[0]} };
      if (years.length>=2) return { consumed:true, field:'yearFrom', value: Math.min(...years), extra:{yearTo:Math.max(...years)} };
      const lastX = low.match(/ostatnie\s+(\d{1,2})\s+lat/);
      if (lastX) {
        const x = parseInt(lastX[1]);
        const thisYear = (new Date()).getFullYear();
        return { consumed:true, field:'yearFrom', value: thisYear - x, extra:{yearTo:thisYear} };
      }
      const lata = low.match(/lata\s+(\d{2})\-?(\d{2})?/); // 'lata 90' or 'lata 90-00'
      if (lata) {
        const a = parseInt(lata[1]);
        let from = (a<=30)? (1900 + a) : (1900 + a); // conservative
        if (lata[2]) {
          const b = parseInt(lata[2]);
          const to = (b < 100) ? (1900 + b) : b;
          return { consumed:true, field:'yearFrom', value: from, extra: { yearTo: to } };
        }
        // lata 90 -> 1990-1999
        return { consumed:true, field:'yearFrom', value: from, extra:{ yearTo: from+9 } };
      }

      // 4) duration
      if (low.includes('kr√≥t') || low.includes('<90') || low.includes('< 90') || low.includes('~<90')) return { consumed:true, field:'durationMax', value:90 };
      if (low.includes('d≈Ç') || low.includes('>120') || low.includes('> 120')) return { consumed:true, field:'durationMax', value:180 };

      // 5) keywords: je≈õli zawiera przecinek lub kilka s≈Ç√≥w, treat as keywords
      const tokens = low.split(/[,;\/]+/).map(s=>s.trim()).filter(Boolean);
      if (tokens.length>1) {
        const kws = tokens.flatMap(t => t.split(/\s+/)).filter(w=>w.length>2);
        return { consumed:true, field:'keywords', value:kws.slice(0,8) };
      }

      // je≈õli pojedyncze s≈Çowo >2 znaki -> treat as keyword
      if (a.length>2) return { consumed:true, field:'keywords', value:[low] };

      return { consumed:false };
    }

    // =========================
    // G≈Ç√≥wna obs≈Çuga wysy≈Çki
    // =========================
    send.addEventListener('click', onSend);
    input.addEventListener('keypress', e => { if (e.key==='Enter') onSend(); });

    async function onSend(){
      if (awaiting===false) return;
      const text = input.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      conversationHistory.push({ role:'user', content:text });
      input.value = '';
      input.disabled = true;
      setTyping(true);

      // spr√≥buj zinterpretowaƒá
      const result = interpretAnswer(text);
      let aiReply = '';

      if (result.consumed){
        // zapisz pref
        const f = result.field;
        if (f === 'category') {
          // spr√≥buj znale≈∫ƒá category id z categoriesMap (najpierw exact, potem ilike)
          const catName = result.value.toLowerCase();
          preferences.category = catName;
        } else if (f === 'mood') {
          preferences.mood = result.value;
        } else if (f === 'yearFrom') {
          preferences.yearFrom = result.value;
          if (result.extra && result.extra.yearTo) preferences.yearTo = result.extra.yearTo;
        } else if (f === 'durationMax') {
          preferences.durationMax = result.value;
        } else if (f === 'keywords') {
          // dopisz s≈Çowa kluczowe unikalnie
          const kw = result.value.map(k=>k.toLowerCase());
          preferences.keywords = Array.from(new Set([...(preferences.keywords||[]), ...kw])).slice(0,12);
        }
        aiReply = 'Super ‚Äî zapisa≈Çem to.';
      } else {
        aiReply = 'W porzƒÖdku, rozumiem ‚Äî przejd≈∫my dalej.';
      }

      // poka≈º odpowied≈∫ AI i zdecyduj co dalej
      addMessage(aiReply, 'ai');

      // czy mamy wystarczajƒÖco informacji?
      const ready = isPreferencesComplete(preferences);

      // je≈õli ready -> zapytaj o potwierdzenie lub od razu szukaj
      if (ready) {
        // zapytaj czy u≈ºytkownik chce TOP5 teraz
        addMessage('Mam wystarczajƒÖco informacji. Chcesz, ≈ºebym teraz pokaza≈Ç TOP 5 film√≥w? Napisz "tak" aby potwierdziƒá lub podaj wiƒôcej preferencji.', 'ai');
        input.disabled = false;
        input.focus();
        setTyping(false);
        return;
      } else {
        // przejd≈∫ do nastƒôpnego pytania
        questionIndex = Math.min(questionIndex + 1, QUESTIONS.length - 1);
        // je≈õli u≈ºytk wpisa≈Ç "-" to po prostu idziemy do nastƒôpnego
        addMessage(QUESTIONS[questionIndex], 'ai');
        input.disabled = false;
        input.focus();
        setTyping(false);
      }
    }

    function isPreferencesComplete(p){
      // kryterium minimalne: category OR mood OR keywords -> enough
      return (!!p.category) || (!!p.mood) || (p.keywords && p.keywords.length>0);
    }

    // =========================
    // Je≈õli u≈ºytkownik potwierdzi "tak" -> fetchRecommendations()
    // =========================
    // Intercept input to detect "tak" (or "nie"/"zmie≈Ñ") quick actions
    input.addEventListener('input', (e) => {
      const v = e.target.value.trim().toLowerCase();
      if (v === 'tak' || v === 'poka≈º' || v === 'ok') {
        // disable typing to avoid immediate send by enter; user can press send
      }
    });

    // Przyciski u≈ÇatwiajƒÖce (opcjonalnie) - gdy wy≈õwietlimy TOP5 dodamy 'Nie, inne' button jako follow-up

    // =========================
    // Funkcja wyszukiwania film√≥w w Supabase i render TOP 5
    // =========================
    async function fetchRecommendations(){
      setTyping(true);
      addMessage('Szukam film√≥w pasujƒÖcych do Twoich preferencji...', 'ai');

      try {
        // zbuduj query poczƒÖtkowe
        // je≈õli mamy category jako tekst, spr√≥buj dopasowaƒá do categoriesMap, a potem u≈ºyƒá category_id
        let categoryId = null;
        if (preferences.category) {
          // spr√≥buj znale≈∫ƒá dok≈Çadne dopasowanie (nazwa w categoriesMap) lub ilike
          const lower = preferences.category.toLowerCase();
          if (categoriesMap[lower]) categoryId = categoriesMap[lower];
          else {
            // pobierz kategoriƒô ilike
            const { data: catData, error: catErr } = await supabase.from('categories').select('id,name').ilike('name', `%${preferences.category}%`).limit(1);
            if (!catErr && catData && catData.length>0) categoryId = catData[0].id;
          }
        }

        // Najpierw pobierz kandydat√≥w (limit 200) z podstawowym filtrem
        let q = supabase.from('movies').select('id,title,description,thumb,year,duration,category_id').limit(200);

        if (categoryId) q = q.eq('category_id', categoryId);
        if (preferences.durationMax) q = q.lte('duration', preferences.durationMax);
        if (preferences.yearFrom) q = q.gte('year', preferences.yearFrom);
        if (preferences.yearTo) q = q.lte('year', preferences.yearTo);

        const { data, error } = await q;
        if (error) throw error;

        let candidates = data || [];

        // prosty scoring po s≈Çowach kluczowych i mood
        const keys = (preferences.keywords || []).map(k => k.toLowerCase()).filter(Boolean);
        candidates = candidates.map(m => {
          const text = ((m.title||'') + ' ' + (m.description||'') + ' ' + (m.year||'')).toLowerCase();
          let score = 0;
          // keyword matches
          for (const k of keys) if (text.includes(k)) score += 3;
          // category presence adds bonus if we didn't filter by it (helps boost)
          if (preferences.category && String(m.category_id) === String(categoryId)) score += 2;
          // mood heuristics: search words in description/title
          if (preferences.mood === 'light' && /fun|comedy|humor|light|romantic|feel good|romans|komedi/i.test(text)) score += 2;
          if (preferences.mood === 'dark' && /dark|thrill|horror|murder|mrocz|czarny|tragic|thriller/i.test(text)) score += 2;
          if (preferences.mood === 'romantic' && /romant|love|mi≈Ço≈õƒá|romance|romans/i.test(text)) score += 2;
          // recent year preference
          if (preferences.yearFrom && m.year && m.year >= preferences.yearFrom) score += 1;
          return { ...m, score };
        });

        // je≈õli nie ma keywords -> fallback sort by year desc
        if (keys.length === 0) {
          candidates.sort((a,b) => (b.year||0) - (a.year||0));
        } else {
          candidates.sort((a,b) => (b.score - a.score) || ((b.year||0) - (a.year||0)));
        }

        // odfiltruj s≈Çabe wyniki je≈õli score == 0 i mieli≈õmy keywords (≈ºeby nie pokazywaƒá losowych)
        if (keys.length>0) candidates = candidates.filter(c => c.score>0);

        if (!candidates || candidates.length===0) {
          addMessage('Niestety nie znalaz≈Çem niczego dok≈Çadnie pasujƒÖcego. Spr√≥buj podaƒá inne s≈Çowa kluczowe lub kategoriƒô.', 'ai');
          setTyping(false);
          input.disabled = false;
          input.focus();
          return;
        }

        // top 5
        const top = candidates.slice(0,5);
        // zbuduj HTML listy rekomendacji
        let html = '<div><strong>Top 5 dopasowanych film√≥w:</strong><div class="rec-list">';
        for (const m of top){
          const desc = m.description ? (m.description.length>180 ? (m.description.slice(0,177)+'...') : m.description) : '';
          const thumb = m.thumb ? `<img src="${escapeHtml(m.thumb)}" alt="${escapeHtml(m.title)}" onerror="this.style.display=\\'none\\'">` : '';
          html += `<div class="rec">${thumb}<div class="meta"><div class="title">${escapeHtml(m.title)} ${m.year?('('+m.year+')'):''}</div><div class="desc">${escapeHtml(desc)}</div></div></div>`;
        }
        html += '</div></div>';
        addMessage(html, 'ai', true);

        // Dodaj przycisk "Nie, inne" i "Poka≈º wiƒôcej" pod listƒÖ (zrobione jako sys message z instrukcjƒÖ)
        const btnContainer = document.createElement('div');
        btnContainer.className = 'msg sys';
        btnContainer.style.marginTop = '8px';
        btnContainer.innerHTML = `<div style="display:flex;gap:8px"><button id="btn-more">Poka≈º wiƒôcej</button><button id="btn-other">Nie, inne</button></div>`;
        chat.appendChild(btnContainer);
        chat.scrollTop = chat.scrollHeight;

        // obs≈Çuga przycisk√≥w
        document.getElementById('btn-more').addEventListener('click', () => {
          // poka≈º kolejne 5
          showMoreCandidates(candidates, 5);
        });
        document.getElementById('btn-other').addEventListener('click', () => {
          addMessage('Ok ‚Äî co zmieniƒá? Napisz np. inny gatunek, nastr√≥j lub s≈Çowa kluczowe.', 'ai');
          input.disabled = false;
          input.focus();
        });

        setTyping(false);
        input.disabled = false;
        input.focus();
      } catch (err){
        console.error(err);
        addMessage('B≈ÇƒÖd przy pobieraniu rekomendacji: ' + (err.message || err), 'sys');
        setTyping(false);
        input.disabled = false;
        input.focus();
      }
    }

    // pokaz kolejne N kandydat√≥w (pagination client-side)
    function showMoreCandidates(list, n){
      // find how many rec items currently shown
      const shown = chat.querySelectorAll('.rec').length;
      const more = list.slice(shown, shown + n);
      if (!more || more.length===0) {
        addMessage('Brak kolejnych wynik√≥w.', 'ai');
        return;
      }
      // dodaj HTML dla ka≈ºdego
      const container = document.createElement('div');
      container.className = 'msg ai';
      container.innerHTML = '<div class="rec-list">' + more.map(m => {
        const desc = m.description ? (m.description.length>180 ? (m.description.slice(0,177)+'...') : m.description) : '';
        const thumb = m.thumb ? `<img src="${escapeHtml(m.thumb)}" alt="${escapeHtml(m.title)}" onerror="this.style.display=\\'none\\'">` : '';
        return `<div class="rec">${thumb}<div class="meta"><div class="title">${escapeHtml(m.title)} ${m.year?('('+m.year+')'):''}</div><div class="desc">${escapeHtml(desc)}</div></div></div>`;
      }).join('') + '</div>';
      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
    }

    // =========================
    // Shortcut: je≈ºeli u≈ºytkzyk wpisze 'tak' -> uruchom fetchRecommendations
    // =========================
    input.addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') {
        const txt = input.value.trim().toLowerCase();
        if (txt === 'tak' || txt === 'ok' || txt === 'poka≈º') {
          // treat as confirm and fetch
          addMessage(input.value.trim(), 'user');
          input.value = '';
          input.disabled = true;
          await fetchRecommendations();
          return;
        }
        // je≈ºeli u≈ºytkownik wpisze 'reset' -> restart conversation
        if (txt === 'reset') {
          addMessage('reset', 'user');
          input.value = '';
          startConversation();
          return;
        }
        // normal flow handled by click handler
      }
    });

    // =========================
    // Start
    // =========================
    init();

  </script>
</body>
</html>
