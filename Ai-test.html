<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StreamingHub - AI Asystent Filmowy</title>
  <style>
    :root {
      --bg: #0b0d10;
      --card: #151922;
      --text: #e3e7ee;
      --muted: #a8bfe2;
      --brand: #4f7cff;
      --border: #232a37;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      line-height: 1.5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      text-align: center;
      padding: 24px 0;
      border-bottom: 2px solid var(--border);
      margin-bottom: 24px;
    }
    .brand { font-size: 1.8rem; font-weight: 800; color: var(--brand); }
    .subtitle { color: var(--muted); margin-top: 8px; }
    .chat-container {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    #chat-messages {
      height: 500px;
      overflow-y: auto;
      padding: 16px;
      background: #0e1218;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .message {
      padding: 14px 18px;
      border-radius: 12px;
      max-width: 80%;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message.ai {
      background: linear-gradient(135deg, #8b5cf6, #6366f1);
      align-self: flex-start;
      color: #fff;
    }
    .message.user {
      background: linear-gradient(135deg, #10b981, #059669);
      align-self: flex-end;
      color: #fff;
    }
    .message.system {
      background: var(--border);
      align-self: center;
      font-size: 0.9rem;
      color: var(--muted);
      max-width: 90%;
      text-align: center;
    }
    .typing { display: none; align-self: flex-start; padding: 12px 18px; background: var(--border); border-radius: 12px; color: var(--muted); }
    .typing.active { display: block; }
    .input-group { display: flex; gap: 12px; }
    #user-input {
      flex: 1;
      padding: 14px 18px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: #0e1218;
      color: var(--text);
      font-size: 1rem;
      transition: border 0.3s;
    }
    #user-input:focus { outline: none; border-color: var(--brand); }
    #send-btn {
      padding: 14px 28px;
      background: var(--brand);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
    }
    #send-btn:hover { background: #3d62d9; }
    #send-btn:disabled { background: var(--border); cursor: not-allowed; }
    @media(max-width: 600px) {
      .container { padding: 12px; }
      #chat-messages { height: 400px; }
      .message { max-width: 95%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">üé¨ StreamingHub AI</div>
      <div class="subtitle">Tw√≥j osobisty asystent filmowy</div>
    </header>
    <div class="chat-container">
      <div id="chat-messages">
        <div class="message system">≈Åadowanie asystenta AI...</div>
      </div>
      <div class="typing" id="typing-indicator">AI pisze...</div>
      <div class="input-group">
        <input type="text" id="user-input" placeholder="Napisz swojƒÖ odpowied≈∫..." disabled />
        <button id="send-btn" disabled>Wy≈õlij</button>
      </div>
    </div>
  </div>

  <!-- Supabase JS (u≈ºyj swojego URL i anon key poni≈ºej) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>

  <script>
    /*************************************************************************
     *  Ustawienia Supabase - wstaw swoje warto≈õci poni≈ºej (PRZYPOMNIENIE):
     *  - Na produkcji wrzuƒá zapytania do backendu i nie expose'uj anon key w frontendzie.
     *************************************************************************/
const SUPABASE_URL = "https://jjmnacolebxsifmnmqks.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0";

    // Inicjalizacja klienta Supabase
    const supabase = supabaseCreateClientSafe();

    function supabaseCreateClientSafe() {
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_URL.includes('YOUR_') || SUPABASE_ANON_KEY.includes('YOUR_')) {
        console.warn('Supabase URL / KEY nie ustawione. Wstaw je w skrypcie aby po≈ÇƒÖczyƒá siƒô z bazƒÖ.');
        return null;
      }
      return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    }

    // UI references
    const chatMessages = document.getElementById('chat-messages');
    const userInput = document.getElementById('user-input');
    const sendBtn = document.getElementById('send-btn');
    const typingIndicator = document.getElementById('typing-indicator');

    let conversationHistory = [];
    let userPreferences = {
      genre: null,
      mood: null,
      era: null,
      duration: null,
      keywords: null,
      language: null
    };
    let currentQuestionIndex = 0;

    const QUESTIONS = [
      { key: 'genre', text: 'Jakiego gatunku filmowego szukasz? (np. dramat, komedia, thriller). Je≈õli nie wiesz, wpisz "-"', hint: 'Podaj 1-2 gatunki lub "-"' },
      { key: 'mood', text: 'Jaki nastr√≥j? (np. lekki, powa≈ºny, trzymajƒÖcy w napiƒôciu, romantyczny). "-" je≈õli brak', hint: 'Przyk≈Çad: "lekki" lub "-" ' },
      { key: 'era', text: 'Wolisz konkretnƒÖ dekadƒô/rok? (np. 1990s, 2010, "-" je≈õli bez znaczenia)', hint: 'Np. "1990" lub "2000s" lub "-" ' },
      { key: 'duration', text: 'Preferowana d≈Çugo≈õƒá filmu? (np. "<90", "90-120", ">120" lub "-" je≈õli bez znaczenia)', hint: 'Np. "90-120" lub "-" ' },
      { key: 'keywords', text: 'Jakie≈õ s≈Çowa-klucze (np. "kosmos", "samotno≈õƒá", "intryga")? "-" je≈õli brak', hint: 'Kilka s≈Ç√≥w rozdzielonych spacjƒÖ lub "-"' },
      { key: 'language', text: 'Jƒôzyk filmu? (np. "polski", "angielski") lub "-"', hint: 'Np. "angielski" lub "-"' }
    ];

    function addMessage(content, type = 'ai') {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${type}`;
      msgDiv.innerHTML = content;
      chatMessages.appendChild(msgDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function showTyping(show) {
      typingIndicator.classList.toggle('active', show);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function toggleInput(enabled) {
      userInput.disabled = !enabled;
      sendBtn.disabled = !enabled;
      if (enabled) userInput.focus();
    }

    function askNextQuestion() {
      if (currentQuestionIndex < QUESTIONS.length) {
        const q = QUESTIONS[currentQuestionIndex];
        addMessage(`${q.text}<div style="margin-top:8px;font-size:0.9rem;color:var(--muted)">${q.hint}</div>`, 'ai');
        toggleInput(true);
      } else {
        // Wszystkie pytania zebrane -> szukamy film√≥w
        addMessage('Super ‚Äî przeanalizujƒô teraz Twoje preferencje i poszukam najlepszych film√≥w...', 'ai');
        searchAndRecommend();
      }
    }

    function normalizeAnswer(ans) {
      if (!ans) return '-';
      return ans.trim();
    }

    function parseDurationSpec(spec) {
      // spec mo≈ºe byƒá "<90", "90-120", ">120"
      if (!spec || spec === '-' ) return null;
      const s = spec.replace(/\s/g, '');
      if (s.startsWith('<')) return { op: '<', minutes: parseInt(s.slice(1), 10) || 90 };
      if (s.startsWith('>')) return { op: '>', minutes: parseInt(s.slice(1), 10) || 120 };
      if (s.includes('-')) {
        const parts = s.split('-').map(p => parseInt(p,10));
        if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) return { op: 'between', min: parts[0], max: parts[1] };
      }
      return null;
    }

    function buildFilterFromPreferences(prefs) {
      // Tworzy obiekt filtr√≥w do u≈ºycia w queries
      const filters = {};
      if (prefs.genre && prefs.genre !== '-') filters.genre = prefs.genre.toLowerCase();
      if (prefs.mood && prefs.mood !== '-') filters.mood = prefs.mood.toLowerCase();
      if (prefs.era && prefs.era !== '-') filters.era = prefs.era.toLowerCase();
      if (prefs.language && prefs.language !== '-') filters.language = prefs.language.toLowerCase();
      if (prefs.keywords && prefs.keywords !== '-') {
        filters.keywords = prefs.keywords.toLowerCase().split(/\s+/).filter(Boolean);
      }
      if (prefs.duration && prefs.duration !== '-') {
        filters.duration = parseDurationSpec(prefs.duration);
      }
      return filters;
    }

    async function searchAndRecommend() {
      showTyping(true);
      toggleInput(false);

      const filters = buildFilterFromPreferences(userPreferences);

      // Je≈õli brak konfiguracji supabase - zwr√≥ƒá informacjƒô
      if (!supabase) {
        showTyping(false);
        addMessage('Baza Supabase nie jest skonfigurowana. Wstaw SUPABASE_URL i SUPABASE_ANON_KEY w skrypcie, aby po≈ÇƒÖczyƒá siƒô z bazƒÖ.', 'system');
        toggleInput(true);
        return;
      }

      try {
        // Pobieramy filmy - pobieramy podstawowe pola i category_id (mo≈ºesz rozbudowaƒá select w zale≈ºno≈õci od RLS/relacji)
        const { data: movies, error } = await supabase
          .from('movies')
          .select('id, title, description, year, duration, thumb, category_id')
          .limit(1000); // limit, ≈ºeby nie pobieraƒá za du≈ºo - zmie≈Ñ wedle potrzeb

        if (error) throw error;

        if (!movies || movies.length === 0) {
          showTyping(false);
          addMessage('W bazie nie znaleziono ≈ºadnych film√≥w.', 'system');
          toggleInput(true);
          return;
        }

        // Opcjonalnie pobieramy kategorie dla lepszego dopasowania (mapujemy id->name)
        const categoryIds = Array.from(new Set(movies.map(m => m.category_id).filter(Boolean)));
        let categoriesMap = {};
        if (categoryIds.length && categoryIds.length <= 100) {
          const { data: cats } = await supabase.from('categories').select('id, name').in('id', categoryIds);
          if (cats) cats.forEach(c => categoriesMap[c.id] = c.name.toLowerCase());
        }

        // Scoring: prosty system punkt√≥w
        const scored = movies.map(m => {
          let score = 0;
          const title = (m.title || '').toLowerCase();
          const desc = (m.description || '').toLowerCase();
          const cat = categoriesMap[m.category_id] || '';

          // genre match (je≈õli podano)
          if (filters.genre) {
            if (cat.includes(filters.genre) || title.includes(filters.genre) || desc.includes(filters.genre)) score += 30;
          }

          // mood match - sprawdzamy w opisie/tytule
          if (filters.mood) {
            if (title.includes(filters.mood) || desc.includes(filters.mood)) score += 20;
          }

          // era/year match
          if (filters.era) {
            // dopuszczamy wpisy typu "1990s" lub "1990"
            const era = filters.era;
            if (!isNaN(parseInt(era))) {
              const y = parseInt(era);
              if (m.year && Math.abs((m.year || 0) - y) <= 3) score += 25;
            } else if (era.endsWith('s')) {
              const decade = parseInt(era.slice(0, -1));
              if (!isNaN(decade) && m.year && m.year >= decade && m.year < decade + 10) score += 20;
            } else {
              if (desc.includes(era) || title.includes(era)) score += 10;
            }
          }

          // duration match
          if (filters.duration && m.duration) {
            const d = filters.duration;
            if (d.op === '<' && m.duration < d.minutes) score += 10;
            if (d.op === '>' && m.duration > d.minutes) score += 10;
            if (d.op === 'between' && m.duration >= d.min && m.duration <= d.max) score += 15;
          }

          // keywords
          if (filters.keywords && filters.keywords.length) {
            let kwscore = 0;
            for (const kw of filters.keywords) {
              if (title.includes(kw)) kwscore += 8;
              if (desc.includes(kw)) kwscore += 6;
              if (cat.includes(kw)) kwscore += 5;
            }
            score += kwscore;
          }

          // small bonus for presence of thumbnail and description
          if (m.thumb) score += 2;
          if (m.description) score += 3;

          return { movie: m, score, title, desc };
        });

        scored.sort((a,b) => b.score - a.score);

        // Je≈õli najlepszy wynik ma 0 punkt√≥w -> najpierw zapytaj czy ma zastosowanie "s≈Çowa-kluczowe"
        if (scored.length && scored[0].score < 5) {
          showTyping(false);
          addMessage('Nie jestem pewien, co powinienem zaproponowaƒá na podstawie dotychczasowych odpowiedzi. Czy chcesz dodaƒá wiƒôcej szczeg√≥≈Ç√≥w (np. s≈Çowa-klucze, znany aktor, dok≈Çadny nastr√≥j)?', 'ai');
          toggleInput(true);
          return;
        }

        // Przygotuj top 5 rekomendacji
        const top = scored.slice(0, 5).map(s => s.movie);

        // Tworzymy podsumowanie z opis√≥w (proste: bierzemy fragment opisu + informacjƒô dlaczego dopasowano)
        const recMessages = top.map((m, idx) => {
          const reasons = [];
          const sc = scored.find(s => s.movie.id === m.id);
          if (sc.score >= 30) reasons.push('bardzo dopasowany do Twoich preferencji');
          else if (sc.score >= 15) reasons.push('dobrze dopasowany');
          else reasons.push('czƒô≈õciowo dopasowany');

          if (m.year) reasons.push(`rok: ${m.year}`);
          if (m.duration) reasons.push(`czas: ${m.duration} min`);
          if (categoriesMap[m.category_id]) reasons.push(`gatunek: ${categoriesMap[m.category_id]}`);

          const descShort = m.description ? (m.description.length > 220 ? m.description.slice(0,220) + '...' : m.description) : 'Brak opisu';
          return `<strong>${idx+1}. ${escapeHtml(m.title)}</strong><br>${escapeHtml(descShort)}<br><small>${reasons.join(' ¬∑ ')}</small>`;
        }).join('<hr style="border-color: rgba(255,255,255,0.06); margin:12px 0;" />');

        showTyping(false);
        addMessage('<div style="font-weight:700;margin-bottom:8px">Top 5 film√≥w dla Ciebie:</div>' + recMessages, 'ai');

        // Dodaj przycisk do akcji (u≈ºytkownik mo≈ºe napisaƒá "nie takie" albo kliknƒÖƒá dalej ‚Äî tu ograniczamy siƒô do czatu)
        addMessage('Je≈õli ≈ºaden z tych film√≥w nie pasuje, napisz "nie takie" lub opisz co zmieniƒá ‚Äî dopytam i zawƒô≈ºƒô wyb√≥r.', 'ai');

        toggleInput(true);
      } catch (err) {
        console.error(err);
        showTyping(false);
        addMessage('WystƒÖpi≈Ç b≈ÇƒÖd przy wyszukiwaniu film√≥w: ' + (err.message || err), 'system');
        toggleInput(true);
      }
    }

    // Proste czyszczenie HTML w tytule/opisie
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // Obs≈Çuga wiadomo≈õci wysy≈Çanej przez u≈ºytkownika
    async function handleSend() {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage(escapeHtml(message), 'user');
      userInput.value = '';
      toggleInput(false);
      showTyping(true);

      // Je≈ºeli u≈ºytkownik wpisze "nie takie" => zadajemy doprecyzowujƒÖce pytanie
      const low = message.toLowerCase();
      if (low === 'nie takie' || low === 'nie takie!' || low.includes('nie takie')) {
        showTyping(false);
        addMessage('Rozumiem ‚Äî co dok≈Çadnie nie pasowa≈Ço? (gatunek, nastr√≥j, era, tempo, jƒôzyk ‚Äî mo≈ºesz wpisaƒá kilka rzeczy oddzielonych przecinkami)', 'ai');
        toggleInput(true);
        return;
      }

      // Je≈ºeli w trakcie zadawania pyta≈Ñ - zapisz odpowied≈∫
      if (currentQuestionIndex < QUESTIONS.length) {
        const q = QUESTIONS[currentQuestionIndex];
        const ans = normalizeAnswer(message);
        userPreferences[q.key] = ans;
        conversationHistory.push({ role: 'user', content: message });
        currentQuestionIndex++;
        showTyping(false);

        // Po zapisaniu - automatycznie zadaj kolejne pytanie
        askNextQuestion();
        return;
      }

      // Je≈õli ju≈º by≈Çy rekomendacje i u≈ºytkownik wpisze dodatkowe preferencje, aktualizujemy i szukamy ponownie
      // Przyk≈Çadowny format: "dodaj: aktor Tom Hanks" lub po prostu "wiƒôcej dramat√≥w" - tutaj prosty update keywords/genre
      // Spr√≥bujmy zaktualizowaƒá podstawowe pola:
      if (low.startsWith('dodaj:')) {
        const after = message.slice(5).trim();
        // je≈õli zawiera 'aktor' to dodajemy do keywords
        if (after.toLowerCase().includes('aktor')) {
          userPreferences.keywords = (userPreferences.keywords || '-') + ' ' + after.replace(/aktor/i,'').trim();
        } else {
          userPreferences.keywords = (userPreferences.keywords || '-') + ' ' + after;
        }
        addMessage('Ok, doda≈Çem dodatkowe wskaz√≥wki. Szukam ponownie...', 'ai');
        await searchAndRecommend();
        return;
      }

      // Je≈õli u≈ºytkownik poda≈Ç normalnƒÖ wiadomo≈õƒá po rekomendacjach, traktujemy jƒÖ jako aktualizacjƒô preferencji:
      // prosta zasada: je≈õli zawiera s≈Çowo-klucz 'gatunek', 'nastroj', 'rok', 'czas' -> pr√≥bujemy przypisaƒá
      if (low.includes('gatunek') || low.includes('gatunek:') || low.includes('genre')) {
        const g = message.split(':').pop().trim();
        userPreferences.genre = g;
        addMessage('Zaktualizowa≈Çem gatunek ‚Äî szukam ponownie...', 'ai');
        await searchAndRecommend();
        return;
      }

      // Domy≈õlnie traktujemy to jako nowe s≈Çowa-klucze
      userPreferences.keywords = (userPreferences.keywords && userPreferences.keywords !== '-') ? (userPreferences.keywords + ' ' + message) : message;
      addMessage('Dziƒôki ‚Äî bazujƒÖc na tym poszukam nowych propozycji...', 'ai');
      await searchAndRecommend();
    }

    // Inicjalizacja czatu
    function init() {
      chatMessages.innerHTML = '';
      const greetings = [
        `Cze≈õƒá! üé¨ Chƒôtnie pomogƒô znale≈∫ƒá film. Mo≈ºesz odpowiedzieƒá "-" je≈õli nie wiesz.`,
        `Witaj! üçø Odpowiedz na kilka prostych pyta≈Ñ (mo≈ºesz wpisaƒá "-" je≈õli nie chcesz odpowiadaƒá).`,
        `Hej! üé• Powiedz mi, czego chcesz ‚Äî zadam kilka przyjemnych pyta≈Ñ i znajdƒô top filmy z Twojej bazy.`
      ];
      addMessage(greetings[Math.floor(Math.random() * greetings.length)], 'ai');

      // reset pref & index
      userPreferences = { genre: null, mood: null, era: null, duration: null, keywords: null, language: null };
      conversationHistory = [];
      currentQuestionIndex = 0;

      // kr√≥tka podpowied≈∫
      addMessage('<small class="system" style="display:block;text-align:center;color:var(--muted)">TIP: mo≈ºesz wpisaƒá "-" gdy nie znasz odpowiedzi. Po zebraniu odpowiedzi wy≈õwietlƒô Top 5 film√≥w z Twojej bazy.</small>', 'ai');

      // zadaj pierwsze pytanie po chwili
      setTimeout(() => askNextQuestion(), 800);
    }

    // Eventy
    sendBtn.addEventListener('click', handleSend);
    userInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) handleSend();
    });

    // Start
    init();

  </script>
</body>
</html>
