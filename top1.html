<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TOP ‚Ä¢ StreamingHub</title>
<style>
:root {
  --bg: #0b0d10;
  --card: #151922;
  --text: #e3e7ee;
  --muted: #a8bfe2;
  --brand: #4f7cff; /* G≈Ç√≥wny kolor niebieski */
  --border: #232a37;
  --success: #3f9c6c; /* Kolor dla odebranej nagrody */
}

* { box-sizing: border-box; }

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, Roboto;
  line-height: 1.4;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 16px;
}
.menu button.btn.secondary {
margin-left: 0;
}
/* ---------------- HEADER ---------------- */
header {
  position: sticky;
  top: 0;
  background: rgba(11,13,16,0.9);
  backdrop-filter: blur(6px);
  z-index: 20;
}

.nav {
  display: flex;
  gap: 12px;
  align-items: center;
  padding: 12px 16px;
  flex-wrap: nowrap;
}

.brand {
  margin-right: auto;       
  font-weight: 800;
}

.menu {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-left: 0;
  align-items: center;
}

.menu a, .menu button {
  padding: 8px 10px;
  color: var(--muted);
  background: none;
  border: none;
  cursor: pointer;
  text-decoration: none;
}

.menu a.active {
  color: #fff;
}

/* ---------------- ITEMY RANKINGU ---------------- */
.item {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 14px;
  border-radius: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
}
.item-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.rank {
  font-size: 18px;
  font-weight: 700;
  color: var(--brand);
  margin-right: 10px;
}

.username {
  font-weight: 600;
}

.btn {
  background: var(--brand);
  color: #fff;
  padding: 10px 14px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  font-size: 15px;
  white-space: nowrap;
}

.btn.secondary {
  background: #2a3446;
}
.btn.claim-btn {
  background: var(--success);
}
.btn.chat-btn {
  background: #6a5acd; /* Kolor dla Chatu */
}

/* BOXY */
.event-box, .toggle-box {
  background: #11151c;
  border: 1px solid var(--border);
  padding: 14px;
  border-radius: 12px;
  margin-top: 18px;
}

.small { color: var(--muted); font-size: 13px; }

/* Licznik */
#countdown {
  color: var(--brand); 
  font-weight: 700;    
  font-size: 1.1rem;   
  margin-top: 8px;     
}

/* ---------------------- MODAL PE≈ÅNOEKRANOWY (dla wygranych/konfiguracji) ---------------------- */
.modal {
  position: fixed;
  left: 0; top: 0; right:0; bottom:0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(2,4,6,0.6);
  z-index: 1000;
}

.modal-card {
  background: var(--card);
  border: 1px solid var(--border);
  padding: 16px;
  border-radius: 12px;
  width: 90%;
  max-width: 700px;
  max-height: 90vh;
  overflow: auto;
}
.admin-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* ---------------------- FLOATING CHAT WIDGET (DYMEK) ---------------------- */
.chat-widget-root {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000; /* Najwy≈ºszy index, aby by≈Ç na wierzchu */
    display: none;
}
.chat-widget-modal-style {
    width: 350px; 
    max-width: 90vw;
    height: 500px; 
    max-height: 80vh;
    background: var(--card);
    border: 1px solid var(--brand); 
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    overflow: hidden; /* Upewnij siƒô, ≈ºe tre≈õƒá nie wycieka */
}
.chat-widget-header {
    padding: 12px;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: var(--brand);
}
.chat-widget-content {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
}
.chat-widget-close {
    cursor: pointer;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 1.2rem;
}

/* Style dla globalnego przycisku chatu w nawigacji */
#chatIndicator {
    position: relative;
    /* styl display:none jest zarzƒÖdzany w JS */
}
#newMessageExclamation {
    position: absolute;
    top: -5px;
    right: 5px;
    color: red;
    font-weight: bold;
    font-size: 1.2em;
    display: none;
}

/* ------------- RESPONSYWNO≈öƒÜ ------------- */
@media (max-width: 900px) {
  .nav { 
    flex-direction: column;
    align-items: stretch;
    text-align: center;
  }

  .menu { justify-content: center; }
  .container { padding: 12px; }

  .item {
    flex-direction: column;
    align-items: flex-start;
    gap: 6px;
  }
}

@media (max-width: 600px) {
  h1, h2, h3 { font-size: 1.2rem; }
  .btn { padding: 10px 12px; font-size: 14px; }

  .item {
    padding: 12px;
    font-size: 14px;
  }
  .item-actions { flex-direction: column; align-items: flex-end; }
  .btn.chat-btn, .btn.claim-btn { width: 100%; text-align: center; }
  .rank { font-size: 16px; }

  /* Na ma≈Çych ekranach wid≈ºet czatu mo≈ºe zajƒÖƒá ca≈ÇƒÖ szeroko≈õƒá i byƒá przy dolnej krawƒôdzi */
  .chat-widget-root {
      right: 10px;
      bottom: 10px;
      width: calc(100% - 20px);
      max-width: unset;
  }
}

@media (max-width: 400px) {
  .nav { padding: 8px; }

  .menu a, .menu button { font-size: 13px; }

  .item {
    padding: 10px;
    font-size: 13px;
  }

  .rank { font-size: 15px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>
  <div class="nav container">
    <a class="brand" href="filmy.html">üé¨ StreamingHub</a>
    <nav class="menu">
      <a href="filmy.html">Filmy</a>
      <a href="seriale.html">Seriale</a>
      <a href="top.html" class="active">TOP</a>
      <a href="moja-biblioteka.html">Moja biblioteka</a>
      
      <a href="#" onclick="openChatWidget(event)" id="chatIndicator" style="display:none; position:relative;">
        <span id="chatIcon">üí¨ Chat</span>
        <span id="newMessageExclamation" style="display:none;">!</span>
      </a>

      <button onclick="logout()" class="btn secondary">Wyloguj</button>
    </nav>
  </div>
</header>

<main class="container" id="app">
<h1>üèÜ TOP u≈ºytkownik√≥w</h1>

<div id="eventBox" class="event-box">
  <div class="event-title">‚è≥ Obecny event</div>
  <div id="eventContent" class="small">≈Åadowanie...</div>
  <div id="countdown"></div>
  
  <div id="publicActions" style="margin-top: 10px;">
    <button class="btn secondary" id="showWinnersBtn" onclick="showWinners()">Poka≈º wygranych</button>
  </div>
  
  <div class="admin-actions" id="adminActions" style="display:none">
    <button class="btn secondary" id="configRewardsBtn" onclick="openRewardsConfig()">Konfiguruj auto-nagrody</button>
    <button class="btn" id="finalizeBtn" onclick="finalizeCurrentEvent()">Finalizuj event</button>
  </div>
</div>

<div class="toggle-box">
  <label>
    <input type="checkbox" id="hideToggle" onchange="toggleHide()">
    Nie pokazuj mnie w rankingach
  </label>
</div>

<div id="tabs" style="margin-top:20px;">
  <button class="btn" onclick="showTab('unlocks')">üîì Odblokowane filmy</button>
  <button class="btn" onclick="showTab('episodes')">üì∫ Obejrzane odcinki</button>
  <button class="btn" onclick="showTab('points')">üí∞ Punkty</button>
  <button class="btn" onclick="showTab('friends')">üë• Znajomi</button>
  <button class="btn" onclick="showTab('visits')">üëÅ Odwiedziny stron</button>
</div>

<div id="content" style="margin-top:14px"></div>
</main>

<div id="modalRoot" style="display:none"></div>

<div id="chatWidgetRoot" class="chat-widget-root">
    <div class="chat-widget-modal-style">
        <div class="chat-widget-header">
            <span>üí¨ Centrum Wsparcia</span>
            <button class="chat-widget-close" onclick="closeChatWidget()">‚úñ</button>
        </div>
        <div class="chat-widget-content" id="chatWidgetContent">
            </div>
    </div>
</div>

<script>
/* ---------------------- SUPABASE INIT ---------------------- */
const db = supabase.createClient(
  "https://jjmnacolebxsifmnmqks.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqbW5hY29sZWJ4c2lmbW5tcWtzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU3OTcyNDQsImV4cCI6MjA3MTM3MzI0NH0.1hNoBQ4wDuA_t_vscorQ6FRb-aW8IxHEDxuZKEhndv0"
);

let user = null;
let currentEvent = null;
let countdownInterval = null;

/* ------------- POPRAWIONA FUNKCJA DO PARSOWANIA DAT ------------- */
function parseSupabaseTs(ts){
  if(!ts) return NaN;
  if(typeof ts === 'number') return Number(ts);
  let s = String(ts).trim();

  if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?([+-]\d{2}:?\d{2})$/.test(s)){
    s = s.replace(" ", "T");
  }
  else if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)){
    s = s.replace(" ", "T") + "Z";
  }
  else if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?$/.test(s)){
    s = s + "Z";
  }

  const result = Date.parse(s);
  return isNaN(result) ? NaN : result;
}

/* ---------------------- BOOT ---------------------- */
(async () => {
  const { data:{ session }} = await db.auth.getSession();
  if(!session){ location.href="login.html"; return; }
  user = session.user;
  
  // Wczytanie profilu dla is_admin
  const { data: profileData } = await db
    .from("profiles")
    .select("is_admin")
    .eq("id", user.id)
    .maybeSingle();

  user.is_admin = profileData?.is_admin || false;

  await Promise.all([
    loadHideToggle(),
    loadEvent(),
    loadChatIndicator() // ≈Åadowanie wska≈∫nika chatu
  ]);

  showTab('unlocks');
})();

async function logout(){
  await db.auth.signOut();
  location.href="login.html";
}

/* ---------------------- CZAT WID≈ªET (DYMEK) ---------------------- */

// Zamyka pe≈Çnoekranowe modale, aby nie kolidowa≈Çy z wid≈ºetem czatu
function closeFullScreenModal(){
  const root = document.getElementById("modalRoot");
  root.style.display = "none";
  root.innerHTML = "";
}

// Zamyka p≈ÇywajƒÖcy wid≈ºet czatu
function closeChatWidget(){
  document.getElementById("chatWidgetRoot").style.display = "none";
}

// Symuluje tre≈õƒá podstrony czatu
function getChatPageContent() {
    const isAdmin = user.is_admin ? "ADMINISTRATOR" : "U≈ªYTKOWNIK";
    return `
        <div style="padding: 10px; font-size: 14px;">
            <p>Witaj, ${isAdmin}.</p>
            <p><b>[Symulacja widoku Czatu]</b></p>
            <p>Tutaj pojawi≈Çaby siƒô lista otwartych konwersacji (tabela 'conversations').</p>
            <p>Gdyby≈õ by≈Ç adminem, zobaczy≈Çby≈õ wszystkie wƒÖtki u≈ºytkownik√≥w. Je≈õli jeste≈õ u≈ºytkownikiem, tylko sw√≥j.</p>
            <p>Klikniƒôcie na wƒÖtek otworzy≈Çoby historiƒô wiadomo≈õci (tabela 'conversation_messages').</p>
            <hr style="border-color: var(--border);">
            <p class="small" style="color:var(--muted)">Uwaga: To jest implementacja wid≈ºetu w rogu ekranu (dymek), a nie pe≈Çny UI czatu. Otwarcie nowego czatu spowodowa≈Ço usuniƒôcie wska≈∫nika <b>!</b></p>
        </div>
    `;
}

function openChatWidget(event) {
    if(event) event.preventDefault(); // Zapobiegamy przej≈õciu na inny link
    
    const root = document.getElementById("chatWidgetRoot");
    const content = document.getElementById("chatWidgetContent");
    
    // Upewnij siƒô, ≈ºe inne modale sƒÖ zamkniƒôte
    closeFullScreenModal(); 

    // Ustawienie tre≈õci
    content.innerHTML = getChatPageContent(); 

    // Pokazanie wid≈ºetu
    root.style.display = "block";
    
    // Zresetowanie wykrzyknika, poniewa≈º u≈ºytkownik otwiera chat
    document.getElementById("newMessageExclamation").style.display = "none";
}

async function loadChatIndicator() {
    const chatIndicator = document.getElementById("chatIndicator");
    const exclamation = document.getElementById("newMessageExclamation");

    // Wyszukaj otwarte konwersacje zwiƒÖzane z u≈ºytkownikiem (jako user lub admin)
    const { data: conversations } = await db
        .from("conversations")
        .select("id, user_id, conversation_messages(sender_id, created_at)")
        .or(`user_id.eq.${user.id},admin_id.eq.${user.id}`)
        .eq("status", "open");
        
    if (!conversations || conversations.length === 0) {
        // Poka≈º przycisk dla admina nawet je≈õli nie ma wƒÖtk√≥w
        chatIndicator.style.display = user.is_admin ? "flex" : "none";
        return;
    }
    
    chatIndicator.style.display = "flex";
    let hasNewMessage = false;

    for(const conv of conversations){
        // Sortujemy wiadomo≈õci, aby znale≈∫ƒá najnowszƒÖ
        conv.conversation_messages.sort((a, b) => parseSupabaseTs(b.created_at) - parseSupabaseTs(a.created_at));
        const lastMessage = conv.conversation_messages[0];

        if (user.is_admin) {
            // Admin ma nowƒÖ wiadomo≈õƒá, je≈õli ostatnia wiadomo≈õƒá jest od U≈ªYTKOWNIKA
            if (lastMessage && lastMessage.sender_id === conv.user_id) {
                hasNewMessage = true;
                break;
            }
            // Nowy, nieodpowiedziany wƒÖtek
            if(!lastMessage){
                hasNewMessage = true;
                break;
            }
        } else {
            // U≈ºytkownik ma nowƒÖ wiadomo≈õƒá, je≈õli ostatnia wiadomo≈õƒá jest od ADMINA
            if (lastMessage && lastMessage.sender_id !== user.id) {
                hasNewMessage = true;
                break;
            }
        }
    }

    exclamation.style.display = hasNewMessage ? "inline" : "none";
}


/* ---------------------- LOGIKA CZATU DLA ADMINA (wywo≈Çanie widgetu) ---------------------- */

async function startAdminChat(winnerId, eventId, winnerName) {
    if (!user.is_admin) {
        alert("Brak uprawnie≈Ñ administratora.");
        return;
    }

    // 1. Sprawdzenie, czy konwersacja ju≈º istnieje
    const { data: existingConv } = await db
        .from("conversations")
        .select("id")
        .eq("user_id", winnerId)
        .eq("event_id", eventId)
        .limit(1);

    if (existingConv && existingConv.length > 0) {
        alert(`IstniejƒÖca konwersacja (#${existingConv[0].id}) z ${winnerName} zosta≈Ça otwarta. (Otwieranie wid≈ºetu)`);
        openChatWidget(); 
        return;
    }

    // 2. Utworzenie nowej konwersacji
    if (!confirm(`RozpoczƒÖƒá nowƒÖ konwersacjƒô z ${winnerName} dotyczƒÖcƒÖ eventu?`)) return;

    const { data: newConv, error: createError } = await db
        .from("conversations")
        .insert({
            user_id: winnerId,
            admin_id: user.id, 
            event_id: eventId,
            status: 'open'
        })
        .select("id")
        .single();

    if (createError) {
        console.error(createError);
        alert("B≈ÇƒÖd tworzenia konwersacji.");
        return;
    }

    alert(`Nowa konwersacja (#${newConv.id}) z ${winnerName} zosta≈Ça utworzona. (Otwieranie wid≈ºetu)`);
    await loadChatIndicator(); 
    openChatWidget();
}

/* ---------------------- HIDE FROM TOP ---------------------- */
async function loadHideToggle(){
  const { data } = await db
    .from("profiles")
    .select("hide_from_top")
    .eq("id", user.id)
    .maybeSingle();

  document.getElementById("hideToggle").checked = data?.hide_from_top || false;
}

async function toggleHide(){
  const value = document.getElementById("hideToggle").checked;
  await db.from("profiles").update({ hide_from_top: value }).eq("id", user.id);
  showTab(document.getElementById("content").dataset.tab || 'unlocks');
}

/* ---------------------- EVENT SYSTEM ---------------------- */
async function loadEvent(){
  // Kod ≈Çadowania eventu (jak w poprzedniej wersji)
  const { data } = await db
    .from("events")
    .select("*")
    .order("id",{ascending:false})
    .limit(1);

  const box = document.getElementById("eventContent");
  const timer = document.getElementById("countdown");
  const adminActionBox = document.getElementById("adminActions");
  
  if(countdownInterval) clearInterval(countdownInterval);
  adminActionBox.style.display = "none";
  currentEvent = null;

  if(!data || data.length===0){
    box.innerHTML = "<p>Brak event√≥w.</p>";
    timer.innerHTML = "";
    document.getElementById("publicActions").style.display = "none";
    return;
  }
  
  document.getElementById("publicActions").style.display = "block";
  const ev = data[0];
  currentEvent = ev;
  
  const endMs = parseSupabaseTs(ev.ends_at);
  const nowMs = Date.now();

  if(isNaN(endMs)) {
      timer.innerHTML = "‚õî B≈ÇƒÖd daty eventu (Brak lub z≈Çy format daty ZAKO≈ÉCZENIA ENDS_AT)";
      return;
  }
  
  let startMs = parseSupabaseTs(ev.starts_at);
  if (isNaN(startMs)) {
      startMs = 0; 
  }

  box.innerHTML = `
    <b>Nazwa:</b> ${ev.name}<br>
    <b>Opis:</b> ${ev.description || '-'}<br>
    <b>Nagroda (opis):</b> ${ev.reward || 'brak'}<br>
    <b>Kategoria:</b> ${ev.category}<br>
    <b>Wygrywa:</b> ${ev.winners_limit || 1} os√≥b
  `;

  if (endMs <= nowMs) {
      timer.innerHTML = "‚õî Event zako≈Ñczony";

      const { data:results } = await db
        .from("event_results")
        .select("id")
        .eq("event_id", ev.id)
        .limit(1);

      const finalized = results && results.length>0;

      adminActionBox.style.display = (user.is_admin && !finalized) ? "flex" : "none";
      
  } else if (startMs > nowMs) {
      timer.innerHTML = `‚è≥ Event rozpocznie siƒô: ${new Date(startMs).toLocaleDateString()}`;
      
  } else {
      adminActionBox.style.display = user.is_admin ? "flex" : "none";
      
      function updateTimer(){
          const now = Date.now();
          const diff = endMs - now;
          
          if(diff <= 0){
              timer.innerHTML = "‚õî Event zako≈Ñczony!";
              clearInterval(countdownInterval);
              setTimeout(()=>{ loadEvent().catch(console.error); }, 1000); 
              return;
          }

          const d = Math.floor(diff / (1000 * 60 * 60 * 24));
          const h = Math.floor((diff / (1000 * 60 * 60)) % 24);
          const m = Math.floor((diff / (1000 * 60)) % 60);
          const s = Math.floor((diff / 1000) % 60);
          timer.innerHTML = `‚è∞ Do ko≈Ñca: ${d}d ${h}h ${m}m ${s}s`;
      }
      
      updateTimer();
      countdownInterval = setInterval(updateTimer,1000);
  }
}

/* ---------------------- LOGIKA ODBIERANIA NAGRODY ---------------------- */

async function claimReward(resultId) {
    if(!confirm("Czy na pewno chcesz odebraƒá nagrodƒô?")) return;

    // 1. Sprawdzenie, czy nagroda nie jest ju≈º odebrana
    const { data: result } = await db
        .from("event_results")
        .select("user_id, claimed_at, reward")
        .eq("id", resultId)
        .maybeSingle();

    if (!result || result.user_id !== user.id) {
        alert("B≈ÇƒÖd: Nie jeste≈õ uprawniony lub wynik nie istnieje.");
        return;
    }
    if (result.claimed_at) {
        alert("Nagroda zosta≈Ça ju≈º odebrana!");
        return;
    }

    // 2. Aktualizacja statusu
    const { error: updateErr } = await db
        .from("event_results")
        .update({ claimed_at: new Date().toISOString() })
        .eq("id", resultId)
        .eq("user_id", user.id);

    if (updateErr) {
        console.error(updateErr);
        alert("B≈ÇƒÖd aktualizacji statusu nagrody. Spr√≥buj ponownie.");
        return;
    }

    alert(`Gratulacje! Nagroda "${result.reward || 'brak opisu'}" zosta≈Ça oznaczona jako odebrana.`);
    await showWinners(); 
}


/* ---------------------- MODAL WYGRANYCH (Zmodyfikowany) ---------------------- */

async function showWinners(){
  let ev = currentEvent;

  if(!ev){
    const { data } = await db.from("events").select("*").order("id",{ascending:false}).limit(1);
    if(!data || data.length===0){ alert("Brak event√≥w."); return; }
    ev = data[0];
  }
  
  // Zamykamy chat widget, je≈õli jest otwarty
  closeChatWidget();

  const { data: results, error: fetchResultsErr } = await db
    .from("event_results")
    .select("id, user_id, score, reward, claimed_at, profiles:profiles(username)")
    .eq("event_id", ev.id)
    .order("id", { ascending: true });
    
    // Sprawdzamy czy event jest zako≈Ñczony
    const endMs = parseSupabaseTs(ev.ends_at);
    const eventFinished = endMs <= Date.now();

  let html = `
    <div class="modal" onclick="closeFullScreenModal()">
      <div class="modal-card" onclick="event.stopPropagation()">
        <h3>Wygrani ‚Äî ${ev.name}</h3>
        <p class="small">Kategoria: <b>${ev.category}</b></p>
        <div style="margin-top:12px;">`;

  if(!results || results.length===0){
    if(eventFinished){
        html += "<p>Brak zapisanych zwyciƒôzc√≥w (Event nie zosta≈Ç jeszcze sfinalizowany). Poni≈ºej podglƒÖd potencjalnych wynik√≥w:</p>";
        // ... (Logika podglƒÖdu zwyciƒôzc√≥w z poprzedniej wersji) ...
        html += "<p>Brak danych do podglƒÖdu wynik√≥w (Potrzebne computeWinnersForEvent).</p>";
    } else {
        html += "<p>Event w trakcie lub jeszcze siƒô nie rozpoczƒÖ≈Ç. Wyniki bƒôdƒÖ dostƒôpne po zako≈Ñczeniu.</p>";
    }
    
  } else {
    let rank = 1;
    results.forEach(w=>{
      const isWinner = w.user_id === user.id;
      const isAdmin = user.is_admin;
      const claimed = w.claimed_at;
      const rewardText = w.reward || 'Brak nagrody';

      let actions = `
        <div class="item-actions">
          <div class="small" style="color:${claimed ? 'var(--success)' : (isWinner ? 'red' : 'var(--muted)')};">
            ${claimed ? 'Odebrano' : (isWinner ? 'Nieodebrano' : '-')}
          </div>
        `;
      
      // Przycisk dla Zwyciƒôzcy
      if(isWinner && !claimed && rewardText !== 'Brak nagrody'){
          actions += `<button class="btn claim-btn" onclick="claimReward(${w.id})">Odbierz nagrodƒô</button>`;
      }
      
      // Przycisk dla Admina (teraz otwiera p≈ÇywajƒÖcy wid≈ºet czatu)
      if(isAdmin){
          actions += `<button class="btn chat-btn" onclick="startAdminChat('${w.user_id}', ${ev.id}, '${w.profiles?.username || 'U≈ºytkownik'}')">üí¨ Chat</button>`;
      }

      actions += `</div>`;

      html += `
        <div class="item">
          <div>
            <span class="rank">#${rank}</span>
            <div class="username">${w.profiles?.username || w.user_id} ${isWinner ? '(Ty)' : ''}</div>
            <div class="small">Nagroda: ${rewardText}</div>
          </div>
          ${actions}
        </div>`;
      rank++;
    });
  }

  html += `
        </div>
        <div style="margin-top:16px; text-align:right;">
          <button class="btn secondary" onclick="closeFullScreenModal()">Zamknij</button>
        </div>
      </div>
    </div>
  `;

  const root = document.getElementById("modalRoot");
  root.innerHTML = html;
  root.style.display = "block";
}

// Funkcje zwiƒÖzane z rankingami (pominiƒôte dla zwiƒôz≈Ço≈õci, sƒÖ jak w poprzedniej wersji)
// ... loadUnlocks, loadEpisodes, render, computeWinnersForEvent, finalizeCurrentEvent, openRewardsConfig, saveAutoRewards ...
// Musisz upewniƒá siƒô, ≈ºe masz je zaimplementowane tak, jak w poprzedniej poprawnej wersji.

async function showTab(tab){ /* ... kod jak wy≈ºej ... */ }
function sinceClauseTimestamp(){ /* ... kod jak wy≈ºej ... */ }
async function getVisibleProfilesMap(ids){ /* ... kod jak wy≈ºej ... */ }
async function loadUnlocks(){ /* ... kod jak wy≈ºej ... */ }
async function loadEpisodes(){ /* ... kod jak wy≈ºej ... */ }
async function loadPoints(){ /* ... kod jak wy≈ºej ... */ }
async function loadFriends(){ /* ... kod jak wy≈ºej ... */ }
async function loadVisits(){ /* ... kod jak wy≈ºej ... */ }
async function render(list, label){ /* ... kod jak wy≈ºej ... */ }
async function renderFixed(list, label, userGetter){ /* ... kod jak wy≈ºej ... */ }
async function computeWinnersForEvent(ev){ /* ... kod jak wy≈ºej ... */ return []; } 
async function finalizeCurrentEvent(){ /* ... kod jak wy≈ºej ... */ }
async function openRewardsConfig(){ /* ... kod jak wy≈ºej ... */ }
function rebuildPositionsInputs(count, existing){ /* ... kod jak wy≈ºej ... */ }
async function saveAutoRewards(eventId){ /* ... kod jak wy≈ºej ... */ }
</script>

</body>
</html>